
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proseco.tests.test_acq &#8212; proseco 4.12.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">proseco</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">proseco 4.12.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for proseco.tests.test_acq</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>
<span class="kn">from</span> <span class="nn">chandra_aca.aca_image</span> <span class="kn">import</span> <span class="n">AcaPsfLibrary</span>
<span class="kn">from</span> <span class="nn">chandra_aca.transform</span> <span class="kn">import</span> <span class="n">mag_to_count_rate</span><span class="p">,</span> <span class="n">yagzag_to_pixels</span>
<span class="kn">import</span> <span class="nn">agasc</span>

<span class="kn">from</span> <span class="nn">..report_acq</span> <span class="kn">import</span> <span class="n">make_report</span>
<span class="kn">from</span> <span class="nn">..acq</span> <span class="kn">import</span> <span class="p">(</span><span class="n">get_p_man_err</span><span class="p">,</span> <span class="n">bin2x2</span><span class="p">,</span>
                   <span class="n">get_imposter_stars</span><span class="p">,</span>
                   <span class="n">get_image_props</span><span class="p">,</span>
                   <span class="n">AcqTable</span><span class="p">,</span> <span class="n">calc_p_on_ccd</span><span class="p">,</span>
                   <span class="n">get_acq_catalog</span><span class="p">,</span>
                   <span class="p">)</span>
<span class="kn">from</span> <span class="nn">..catalog</span> <span class="kn">import</span> <span class="n">get_aca_catalog</span>
<span class="kn">from</span> <span class="nn">..core</span> <span class="kn">import</span> <span class="n">ACABox</span><span class="p">,</span> <span class="n">StarsTable</span>
<span class="kn">from</span> <span class="nn">.test_common</span> <span class="kn">import</span> <span class="n">OBS_INFO</span><span class="p">,</span> <span class="n">STD_INFO</span><span class="p">,</span> <span class="n">mod_std_info</span><span class="p">,</span> <span class="n">DARK40</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">characteristics</span> <span class="k">as</span> <span class="n">ACA</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">characteristics_fid</span> <span class="k">as</span> <span class="n">FID</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">characteristics_acq</span> <span class="k">as</span> <span class="n">ACQ</span>


<span class="n">TEST_DATE</span> <span class="o">=</span> <span class="s1">&#39;2018:144&#39;</span>  <span class="c1"># Fixed date for doing tests</span>
<span class="n">ATT</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Arbitrary test attitude</span>
<span class="n">CACHE</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cache stuff for speed</span>
<span class="n">TEST_COLS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="s1">&#39;slot&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;yang&#39;</span><span class="p">,</span> <span class="s1">&#39;zang&#39;</span><span class="p">,</span> <span class="s1">&#39;halfw&#39;</span><span class="p">)</span>

<span class="c1"># Do not use the AGASC supplement in testing by default since mags can change</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">agasc</span><span class="o">.</span><span class="n">SUPPLEMENT_ENABLED_ENV</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>


<div class="viewcode-block" id="calc_p_brightest"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.calc_p_brightest">[docs]</a><span class="k">def</span> <span class="nf">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">man_err</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">bgd</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stub for original functional version of acq.calc_p_brightest, which was</span>
<span class="sd">    turned into an AcqTable method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">AcqTable</span><span class="p">()</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">t_ccd</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">dark</span> <span class="o">=</span> <span class="n">dark</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">dither</span> <span class="o">=</span> <span class="n">dither</span>
    <span class="k">return</span> <span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">man_err</span><span class="p">,</span> <span class="n">bgd</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_imposter"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.add_imposter">[docs]</a><span class="k">def</span> <span class="nf">add_imposter</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="p">,</span> <span class="n">dzang</span><span class="p">,</span> <span class="n">dmag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For testing, add an imposter (single hot pixel) at the specified delta location</span>
<span class="sd">    and mag relative to an ``acq`` star.  Returns a new dark map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">dark</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">yang</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;yang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dyang</span>
    <span class="n">zang</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dzang</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">yang</span><span class="p">,</span> <span class="n">zang</span><span class="p">)</span>
    <span class="n">row0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span>
    <span class="n">col0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span>
    <span class="n">dark</span><span class="p">[</span><span class="n">row0</span><span class="p">,</span> <span class="n">col0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dmag</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dark</span></div>


<div class="viewcode-block" id="add_spoiler"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.add_spoiler">[docs]</a><span class="k">def</span> <span class="nf">add_spoiler</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="p">,</span> <span class="n">dzang</span><span class="p">,</span> <span class="n">dmag</span><span class="p">,</span> <span class="n">mag_err</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For testing, add a spoiler stars at the specified delta location</span>
<span class="sd">    and mag relative to an ``acq`` star.  Returns a new stars table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;yang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;yang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dyang</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;zang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;zang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dzang</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dmag</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;mag_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_err</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;MAG_ACA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;yang&#39;</span><span class="p">],</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;zang&#39;</span><span class="p">])</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
    <span class="n">star</span><span class="p">[</span><span class="s1">&#39;CLASS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">stars</span></div>


<div class="viewcode-block" id="test_get_p_man_err"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_p_man_err">[docs]</a><span class="k">def</span> <span class="nf">test_get_p_man_err</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test the get_p_man_err function.</span>

<span class="sd">    P_man_errs is a table that defines the probability of a maneuver error being</span>
<span class="sd">    within a defined lo/hi bin [arcsec] given a maneuver angle [deg] within a</span>
<span class="sd">    bin range.  The first two columns specify the maneuver error bins and the</span>
<span class="sd">    subsequent column names give the maneuver angle bin in the format</span>
<span class="sd">    &lt;angle_lo&gt;-&lt;angle_hi&gt;.  The source table does not include the row for</span>
<span class="sd">    the 0-60 man err case: this is generated automatically from the other</span>
<span class="sd">    values so the sum is 1.0.</span>
<span class="sd">    ::</span>

<span class="sd">       man_err_lo man_err_hi 0-5 5-20 20-40 40-60 60-80 80-100 100-120 120-180</span>
<span class="sd">       ---------- ---------- --- ---- ----- ----- ----- ------ ------- -------</span>
<span class="sd">               60         80 0.0  0.2   0.5   0.6   1.6    4.0     8.0     8.0</span>
<span class="sd">               80        100 0.0  0.1   0.2   0.3   0.5    1.2     2.4     2.4</span>
<span class="sd">              100        120 0.0  0.0   0.1   0.2   0.3    0.8     0.8     0.8</span>
<span class="sd">              120        140 0.0  0.0  0.05  0.05   0.2    0.4     0.4     0.4</span>
<span class="sd">              140        160 0.0  0.0  0.05  0.05   0.2    0.2     0.2     0.4</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="n">man_err</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>  <span class="c1"># Exactly 60 is in 0-60 bin</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mf">60.00001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span>  <span class="c1"># Just over 60 in 60-80 bin</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>  <span class="c1"># [0-5 deg bin]</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mf">5.0001</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="mf">0.002</span><span class="p">)</span>  <span class="c1"># [5-20 deg bin]</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mf">60.0001</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.002</span>  <span class="c1"># + 0.001) [5-20 deg bin]</span>
    <span class="k">assert</span> <span class="n">get_p_man_err</span><span class="p">(</span><span class="mf">60.0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>  <span class="c1"># Just over 60 in 60-80&quot; bin</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">get_p_man_err</span><span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_bin2x2"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_bin2x2">[docs]</a><span class="k">def</span> <span class="nf">test_bin2x2</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test the bin2x2 function&quot;&quot;&quot;</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">bin2x2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arr</span> <span class="o">==</span> <span class="p">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">],</span> <span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="mi">50</span><span class="p">]])</span></div>


<div class="viewcode-block" id="test_get_image_props"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_image_props">[docs]</a><span class="k">def</span> <span class="nf">test_get_image_props</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test the get_image_props function&quot;&quot;&quot;</span>
    <span class="n">c_row</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">c_col</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="mf">9.0</span><span class="p">)</span>
    <span class="n">APL</span> <span class="o">=</span> <span class="n">AcaPsfLibrary</span><span class="p">()</span>
    <span class="n">psf_img</span> <span class="o">=</span> <span class="n">APL</span><span class="o">.</span><span class="n">get_psf_image</span><span class="p">(</span><span class="n">c_row</span><span class="p">,</span> <span class="n">c_col</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">pix_zero_loc</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="n">ccd_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">bgd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ccd_img</span><span class="p">[</span><span class="n">c_row</span> <span class="o">-</span> <span class="mi">4</span><span class="p">:</span><span class="n">c_row</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c_col</span> <span class="o">-</span> <span class="mi">4</span><span class="p">:</span><span class="n">c_col</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">psf_img</span>
    <span class="n">img</span><span class="p">,</span> <span class="n">img_sum</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">get_image_props</span><span class="p">(</span><span class="n">ccd_img</span><span class="p">,</span> <span class="n">c_row</span><span class="p">,</span> <span class="n">c_col</span><span class="p">,</span> <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">c_row</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">c_col</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="setup_get_imposter_stars"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.setup_get_imposter_stars">[docs]</a><span class="k">def</span> <span class="nf">setup_get_imposter_stars</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Setup for testing with the get_imposter_stars function.&quot;&quot;&quot;</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">bgd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">box_size</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">dark</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">bgd</span>
    <span class="n">dark</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">bgd</span>
    <span class="n">dark</span><span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">bgd</span>
    <span class="n">dark</span><span class="p">[</span><span class="mi">26</span><span class="p">,</span> <span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">bgd</span> <span class="o">+</span> <span class="mi">1000</span>
    <span class="n">imposters</span> <span class="o">=</span> <span class="n">get_imposter_stars</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">box_size</span><span class="o">=</span><span class="n">box_size</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">imposters</span></div>


<div class="viewcode-block" id="test_get_imposters_3500"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_imposters_3500">[docs]</a><span class="k">def</span> <span class="nf">test_get_imposters_3500</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test three nearby hits that don&#39;t make the cut.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imposters</span> <span class="o">=</span> <span class="n">setup_get_imposter_stars</span><span class="p">(</span><span class="mi">3500</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">imposters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">imposters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;row0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">23</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;col0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">21</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="mf">10.490</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;img_sum&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4500</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4500</span></div>


<div class="viewcode-block" id="test_get_imposters_5000"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_imposters_5000">[docs]</a><span class="k">def</span> <span class="nf">test_get_imposters_5000</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test get_imposters with an imposter of 5000.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imposters</span> <span class="o">=</span> <span class="n">setup_get_imposter_stars</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">imposters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">imposters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;row0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">23</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;col0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">21</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="mf">10.178</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mf">6000.0</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;img_sum&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6000</span>

    <span class="n">imp</span> <span class="o">=</span> <span class="n">imposters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;row0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">28</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;col0&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">26</span>
    <span class="k">assert</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;img_sum&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5000</span> <span class="o">*</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="mf">9.183</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_test_stars</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;stars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CACHE</span><span class="p">:</span>
        <span class="n">CACHE</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_agasc</span><span class="p">(</span><span class="n">ATT</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2018:230&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CACHE</span><span class="p">[</span><span class="s1">&#39;stars&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_test_cand_acqs</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;cand_acqs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CACHE</span><span class="p">:</span>
        <span class="n">acqs</span> <span class="o">=</span> <span class="n">AcqTable</span><span class="p">()</span>
        <span class="n">acqs</span><span class="o">.</span><span class="n">p_man_errs</span> <span class="o">=</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">p_man_errs</span><span class="p">[</span><span class="s1">&#39;120-180&#39;</span><span class="p">]</span>
        <span class="n">acqs</span><span class="o">.</span><span class="n">t_ccd</span> <span class="o">=</span> <span class="o">-</span><span class="mf">10.0</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">get_test_stars</span><span class="p">()</span>
        <span class="n">CACHE</span><span class="p">[</span><span class="s1">&#39;cand_acqs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">get_acq_candidates</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CACHE</span><span class="p">[</span><span class="s1">&#39;cand_acqs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<div class="viewcode-block" id="test_calc_p_brightest_same_bright"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_calc_p_brightest_same_bright">[docs]</a><span class="k">def</span> <span class="nf">test_calc_p_brightest_same_bright</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test for an easy situation of three spoiler/imposters with exactly</span>
<span class="sd">    the same brightness as acq star so that p_brighter is always 0.5.</span>
<span class="sd">    As each one comes into the box you add another coin toss to the</span>
<span class="sd">    odds of the acq star being brightest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">get_test_stars</span><span class="p">()</span>

    <span class="n">acq</span> <span class="o">=</span> <span class="n">get_test_cand_acqs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Imposter ends up with this mag_err (based on get_mag_std() for the</span>
    <span class="c1"># imposter mag), so set the acq and spoilers to have the same err.  This</span>
    <span class="c1"># makes the calculation be trivial to do analytically: prob that acq</span>
    <span class="c1"># is the brightest is 1 / N where N is the total number of objects</span>
    <span class="c1"># (acq + imposters + spoilers).</span>
    <span class="n">mag_err</span> <span class="o">=</span> <span class="mf">0.032234</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;mag_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_err</span>

    <span class="n">dark_imp</span> <span class="o">=</span> <span class="n">add_imposter</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=-</span><span class="mi">105</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=-</span><span class="mi">105</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">stars_sp</span> <span class="o">=</span> <span class="n">add_spoiler</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mag_err</span><span class="o">=</span><span class="n">mag_err</span><span class="p">)</span>
    <span class="n">stars_sp</span> <span class="o">=</span> <span class="n">add_spoiler</span><span class="p">(</span><span class="n">stars_sp</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mag_err</span><span class="o">=</span><span class="n">mag_err</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars_sp</span><span class="p">,</span> <span class="n">dark_imp</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">ACABox</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">box_sizes</span><span class="p">]</span>

    <span class="c1">#  Box size:                160   140   120    100   80   60  arcsec</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.3334</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_calc_p_brightest_same_bright_asymm_dither"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_calc_p_brightest_same_bright_asymm_dither">[docs]</a><span class="k">def</span> <span class="nf">test_calc_p_brightest_same_bright_asymm_dither</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test for an easy situation of three spoiler/imposters with exactly</span>
<span class="sd">    the same brightness as acq star so that p_brighter is always 0.5.</span>
<span class="sd">    As each one comes into the box you add another coin toss to the</span>
<span class="sd">    odds of the acq star being brightest.</span>

<span class="sd">    Use an asymmetric dither to test the handling of this.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">get_test_stars</span><span class="p">()</span>

    <span class="n">acq</span> <span class="o">=</span> <span class="n">get_test_cand_acqs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># See test_calc_p_brightest_same_bright() for explanation of mag_err</span>
    <span class="n">mag_err</span> <span class="o">=</span> <span class="mf">0.032234</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;mag_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_err</span>

    <span class="n">dither</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>

    <span class="c1"># Add a spoiler star to stars and leave dark map the same.</span>
    <span class="c1"># Spoiler stars don&#39;t care about dither.</span>
    <span class="n">stars_sp</span> <span class="o">=</span> <span class="n">add_spoiler</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=-</span><span class="mi">105</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">105</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">mag_err</span><span class="o">=</span><span class="n">mag_err</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars_sp</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span>
                              <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">,</span> <span class="n">man_err</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">box_sizes</span><span class="p">]</span>

    <span class="c1">#  Box size:               160  140  120  100   80   60  arcsec</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Add an imposter to dark map and leave stars the same</span>
    <span class="c1"># 80&quot; box + dither = (100, 140), so (105, 145) pixel is not included</span>
    <span class="c1"># 100&quot; box + dither = (120, 160), so (105, 145) pixel is included</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;imposters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;spoilers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dark_imp</span> <span class="o">=</span> <span class="n">add_imposter</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=</span><span class="mi">105</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">145</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark_imp</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span>
                              <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">,</span> <span class="n">man_err</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">box_sizes</span><span class="p">]</span>

    <span class="c1">#  Box size:               160  140  120  100  80   60  arcsec</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Both together</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;imposters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;spoilers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars_sp</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark_imp</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span>
                              <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">,</span> <span class="n">man_err</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">box_sizes</span><span class="p">]</span>

    <span class="c1">#  Box size:                160    140    120  100   80   60  arcsec</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_calc_p_brightest_1mag_brighter"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_calc_p_brightest_1mag_brighter">[docs]</a><span class="k">def</span> <span class="nf">test_calc_p_brightest_1mag_brighter</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test for the situation of spoiler/imposter that is 1 mag brighter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">box_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">get_test_stars</span><span class="p">()</span>

    <span class="c1"># Bright spoiler at 65 arcsec</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">get_test_cand_acqs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stars_sp</span> <span class="o">=</span> <span class="n">add_spoiler</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars_sp</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">ACABox</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">box_sizes</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="c1"># Comparable spoiler at 65 arcsec (within mag_err)</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">get_test_cand_acqs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stars_sp</span> <span class="o">=</span> <span class="n">add_spoiler</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mag_err</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars_sp</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">ACABox</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">box_sizes</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.158974</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1"># Bright imposter at 85 arcsec</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">get_test_cand_acqs</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dark_imp</span> <span class="o">=</span> <span class="n">add_imposter</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="n">acq</span><span class="p">,</span> <span class="n">dyang</span><span class="o">=-</span><span class="mi">85</span><span class="p">,</span> <span class="n">dzang</span><span class="o">=-</span><span class="mi">85</span><span class="p">,</span> <span class="n">dmag</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">calc_p_brightest</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="n">box_size</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">dark_imp</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">ACABox</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">box_sizes</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_calc_p_on_ccd"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_calc_p_on_ccd">[docs]</a><span class="k">def</span> <span class="nf">test_calc_p_on_ccd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the calculation of probability of star being on usable area on the CCD.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These lines mimic the code in calc_p_on_ccd() which requires that</span>
    <span class="c1"># track readout box is fully within the usable part of CCD.</span>
    <span class="n">max_ccd_row</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_row</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">max_ccd_col</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">4</span>

    <span class="c1"># Halfway off in both row and col, (1/4 of area remaining)</span>
    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">60</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">120</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="c1"># 3 of 8 pixels off in row (5/8 of area remaining)</span>
    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span>

    <span class="c1"># Same but for col</span>
    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span>

    <span class="c1"># Same but for a negative col number</span>
    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ACABox</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_calc_p_on_ccd_asymmetric_dither"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_calc_p_on_ccd_asymmetric_dither">[docs]</a><span class="k">def</span> <span class="nf">test_calc_p_on_ccd_asymmetric_dither</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test the calculation of probability of star being on usable area on the CCD</span>
<span class="sd">    for the case of asymmetric dither.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># These lines mimic the code in calc_p_on_ccd() which requires that</span>
    <span class="c1"># track readout box is fully within the usable part of CCD.</span>
    <span class="n">max_ccd_row</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_row</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">max_ccd_col</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">4</span>

    <span class="c1"># Halfway off in both row and col, (1/4 of area remaining).  These checks</span>
    <span class="c1"># don&#39;t change from symmetric case because of the placement of row, col.</span>
    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">((</span><span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">((</span><span class="mi">120</span><span class="p">,</span> <span class="mi">60</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="c1"># 3 of 8 pixels off in row (5/8 of area remaining).  Dither_z (col) does not</span>
    <span class="c1"># matter here because only rows are off CCD.</span>
    <span class="k">for</span> <span class="n">dither_z</span> <span class="ow">in</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">max_ccd_row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="n">dither_z</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span>

    <span class="c1"># Same but for col</span>
    <span class="k">for</span> <span class="n">dither_y</span> <span class="ow">in</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">((</span><span class="n">dither_y</span><span class="p">,</span> <span class="mi">20</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span>

        <span class="c1"># Same but for a negative col number</span>
        <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">max_ccd_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ACABox</span><span class="p">((</span><span class="n">dither_y</span><span class="p">,</span> <span class="mi">20</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="mf">0.625</span><span class="p">)</span>

    <span class="c1"># Show expected asymmetric behavior, starting right at the physical CCD edge.</span>
    <span class="c1"># In this case the only chance to get on the CCD is for dither to bring it</span>
    <span class="c1"># there.  (Note: the model assumes the dither spatial distribution is</span>
    <span class="c1"># flat, but it is not).</span>

    <span class="c1"># First, with dither_y &lt;= 25 or dither_z &lt;= 20, p_in_box is exactly zero</span>
    <span class="k">for</span> <span class="n">dither</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">25</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">60</span><span class="p">)):</span>
        <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">dither</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">p_in_box</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># Now some asymmetric cases.  p_in_ccd increases with larger dither.</span>
    <span class="k">for</span> <span class="n">dither</span><span class="p">,</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">[((</span><span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="mf">0.02083333</span><span class="p">),</span>
                        <span class="p">((</span><span class="mi">40</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="mf">0.03125</span><span class="p">),</span>
                        <span class="p">((</span><span class="mi">40</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="mf">0.084375</span><span class="p">),</span>
                        <span class="p">((</span><span class="mi">200</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span> <span class="mf">0.109375</span><span class="p">)]:</span>
        <span class="n">p_in_box</span> <span class="o">=</span> <span class="n">calc_p_on_ccd</span><span class="p">(</span><span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_row</span><span class="p">,</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_ccd_col</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">dither</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">p_in_box</span><span class="p">,</span> <span class="n">exp</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_get_acq_catalog_19387"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_acq_catalog_19387">[docs]</a><span class="k">def</span> <span class="nf">test_get_acq_catalog_19387</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Put it all together.  Regression test for selected stars.  This obsid</span>
<span class="sd">    actually changes out one of the initial catalog candidates.</span>

<span class="sd">    From ipython:</span>
<span class="sd">    &gt;&gt;&gt; from proseco.acq import AcqTable</span>
<span class="sd">    &gt;&gt;&gt; acqs = get_acq_catalog(19387)</span>
<span class="sd">    &gt;&gt;&gt; TEST_COLS = (&#39;idx&#39;, &#39;slot&#39;, &#39;id&#39;, &#39;yang&#39;, &#39;zang&#39;, &#39;halfw&#39;)</span>
<span class="sd">    &gt;&gt;&gt; repr(acqs.cand_acqs[TEST_COLS]).splitlines()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">OBS_INFO</span><span class="p">[</span><span class="mi">19387</span><span class="p">])</span>
    <span class="c1"># Expected</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=13&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot    id      yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64  int32   float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- -------- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0 38280776 -2254.09 -2172.43    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1 37879960  -567.34  -632.27    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2 37882072  2197.62  1608.89    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3 37879992   318.47 -1565.92    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4   -99 37882416   481.80  2204.44    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     4 37880176   121.33 -1068.25    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6     5 37881728  2046.89  1910.79    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7     6 37880376 -1356.71  1071.32    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    8     7 38276824 -1822.26 -1813.66    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    9   -99 37882776  1485.00   127.97    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   10   -99 37880152 -1542.43   970.39    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   11   -99 37880584 -2005.80  2449.74    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   12   -99 38273720  -672.32 -2474.85    60&#39;</span><span class="p">]</span>

    <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span></div>


<div class="viewcode-block" id="test_get_acq_catalog_21007"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_get_acq_catalog_21007">[docs]</a><span class="k">def</span> <span class="nf">test_get_acq_catalog_21007</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Put it all together.  Regression test for selected stars.</span>

<span class="sd">    From ipython::</span>

<span class="sd">      &gt;&gt;&gt; from proseco.acq import AcqTable</span>
<span class="sd">      &gt;&gt;&gt; acqs = get_acq_catalog(21007)</span>
<span class="sd">      &gt;&gt;&gt; TEST_COLS = (&#39;idx&#39;, &#39;slot&#39;, &#39;id&#39;, &#39;yang&#39;, &#39;zang&#39;, &#39;halfw&#39;)</span>
<span class="sd">      &gt;&gt;&gt; repr(acqs.cand_acqs[TEST_COLS]).splitlines()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">OBS_INFO</span><span class="p">[</span><span class="mi">21007</span><span class="p">])</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=14&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot     id      yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64   int32   float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- --------- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0 189417400 -2271.86 -1634.77   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1 189410928   -62.52  1763.04   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2 189409160 -2223.75  1998.69   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3 189417920  1482.94   243.72   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4     4 189015480  2222.47  -580.99    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     5 189417752  1994.07   699.55    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6     6 189406216 -2311.90  -240.18    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7     7 189416328  1677.88   137.11   100&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    8   -99 189416496   333.11   -63.30   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    9   -99 189410280  -495.21  1712.02   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   10   -99 189416808  2283.31  2007.54   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   11   -99 189017968  1612.35 -1117.76   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   12   -99 189417000    52.31  -769.11   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   13   -99 189011576   553.50 -2473.81   120&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=8&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot     id      yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64   int32   float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- --------- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0 189417400 -2271.86 -1634.77   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1 189410928   -62.52  1763.04   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2 189409160 -2223.75  1998.69   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3 189417920  1482.94   243.72   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4     4 189015480  2222.47  -580.99   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     5 189417752  1994.07   699.55    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6     6 189406216 -2311.90  -240.18    60&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7     7 189416328  1677.88   137.11    60&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span></div>


<div class="viewcode-block" id="test_box_strategy_20603"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_box_strategy_20603">[docs]</a><span class="k">def</span> <span class="nf">test_box_strategy_20603</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for PR #32 that doesn&#39;t allow p_acq to be reduced below 0.1.</span>

<span class="sd">    The idx=8 (mag=10.50) star was previously selected with 160 arsec box.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">OBS_INFO</span><span class="p">[</span><span class="mi">20603</span><span class="p">])</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=13&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot     id      yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64   int32   float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- --------- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0  40113544   102.74  1133.37   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1 116923496 -1337.79  1049.27   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2 116791824   622.00  -953.60   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3  40114416   394.22  1204.43   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4     4  40112304 -1644.35  2032.47    80&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     5 116923528 -2418.65  1088.40   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6     6 116791744   985.38 -1210.19   140&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7     7  40108048     2.21  1619.17   100&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    8   -99 116785920  -673.94 -1575.87   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    9   -99 116923744  -853.18   937.73   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   10   -99 116792320   941.59 -1784.10   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   11   -99 116918232 -2074.91 -1769.96   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   12   -99 116923672 -2307.80  1442.43   120&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=8&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot     id      yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64   int32   float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- --------- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0  40113544   102.74  1133.37   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1 116923496 -1337.79  1049.27   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2 116791824   622.00  -953.60   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3  40114416   394.22  1204.43   140&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4     4  40112304 -1644.35  2032.47   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     5 116923528 -2418.65  1088.40   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6     6 116791744   985.38 -1210.19   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7     7  40108048     2.21  1619.17    60&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span></div>


<div class="viewcode-block" id="test_make_report"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_make_report">[docs]</a><span class="k">def</span> <span class="nf">test_make_report</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Test making an acquisition report.</span>

<span class="sd">    Use a big-box dither here to test handling of that in report (after passing</span>
<span class="sd">    through pickle).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">obsid</span> <span class="o">=</span> <span class="mi">19387</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">OBS_INFO</span><span class="p">[</span><span class="n">obsid</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dither&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">OBS_INFO</span><span class="p">[</span><span class="n">obsid</span><span class="p">])</span>

    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
    <span class="n">obsdir</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;obs</span><span class="si">{</span><span class="n">obsid</span><span class="si">:</span><span class="s1">05</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">outdir</span> <span class="o">=</span> <span class="n">obsdir</span> <span class="o">/</span> <span class="s1">&#39;acq&#39;</span>

    <span class="n">acqs</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">rootdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="n">acqs2</span> <span class="o">=</span> <span class="n">make_report</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;index.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;acq_stars.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">outdir</span> <span class="o">/</span> <span class="s1">&#39;candidate_stars.png&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">outdir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.png&#39;</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs2</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">event2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">log_info</span><span class="p">,</span> <span class="n">acqs2</span><span class="o">.</span><span class="n">log_info</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">event</span> <span class="o">==</span> <span class="n">event2</span>

    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;att&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;t_ccd&#39;</span><span class="p">,</span> <span class="s1">&#39;man_angle&#39;</span><span class="p">,</span> <span class="s1">&#39;dither&#39;</span><span class="p">,</span> <span class="s1">&#39;p_safe&#39;</span><span class="p">]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">acqs</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="n">val2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">acqs2</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="n">val2</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">val</span> <span class="o">==</span> <span class="n">val2</span></div>


<div class="viewcode-block" id="test_cand_acqs_include_exclude"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_cand_acqs_include_exclude">[docs]</a><span class="k">def</span> <span class="nf">test_cand_acqs_include_exclude</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test include and exclude stars.</span>

<span class="sd">    This uses a catalog with 11 stars:</span>

<span class="sd">    - 8 bright stars from 7.0 to 7.7 mag, where the 7.0 is EXCLUDED</span>
<span class="sd">    - 2 faint (but OK) stars 10.0, 10.1 where the 10.0 is INCLUDED</span>
<span class="sd">    - 1 very faint (bad) stars 12.0 mag is INCLUDED</span>

<span class="sd">    Both the 7.0 and 10.1 would normally get picked either initially</span>
<span class="sd">    or swapped in during optimization, and 12.0 would never get picked.</span>
<span class="sd">    Check that the final catalog is [7.1 .. 7.7, 10.0, 12.0]</span>

<span class="sd">    Finally, starting from the catalog chosen with the include/exclude</span>
<span class="sd">    constraints applied, remove those constraints and re-optimize.</span>
<span class="sd">    This must come back to the original catalog of the 8 bright stars.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>

    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">7.1</span><span class="p">,</span> <span class="mf">7.2</span><span class="p">,</span> <span class="mf">7.3</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">7.6</span><span class="p">,</span> <span class="mf">7.7</span><span class="p">],</span>
                                 <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
                                 <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">],</span>
                                 <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
                                 <span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Put in a neighboring star that will keep star 9 out of the cand_acqs table</span>
    <span class="n">star9</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">star9</span><span class="p">[</span><span class="s1">&#39;ASPQ1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="n">star9</span><span class="p">[</span><span class="s1">&#39;yang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="n">star9</span><span class="p">[</span><span class="s1">&#39;zang&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="n">mag</span><span class="o">=</span><span class="n">star9</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="c1"># Make sure baseline catalog is working like expected</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">160</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

    <span class="c1"># Define includes and excludes. id=9 is in nominal cand_acqs but not in acqs.</span>
    <span class="n">include_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
    <span class="n">include_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">89</span><span class="p">]</span>
    <span class="n">exp_include_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
    <span class="n">exclude_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">optimize</span> <span class="ow">in</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="n">optimize</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span>
                               <span class="n">include_ids</span><span class="o">=</span><span class="n">include_ids</span><span class="p">,</span> <span class="n">include_halfws</span><span class="o">=</span><span class="n">include_halfws</span><span class="p">,</span>
                               <span class="n">exclude_ids</span><span class="o">=</span><span class="n">exclude_ids</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">include_ids</span> <span class="o">==</span> <span class="n">include_ids</span>
        <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">include_halfws</span> <span class="o">==</span> <span class="n">exp_include_halfws</span>
        <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">exclude_ids</span> <span class="o">==</span> <span class="n">exclude_ids</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">id_</span> <span class="ow">in</span> <span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">include_ids</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">id_</span> <span class="ow">in</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">include_ids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">id_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">exclude_ids</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.1</span><span class="p">,</span> <span class="mf">7.2</span><span class="p">,</span> <span class="mf">7.3</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">7.6</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">])</span>

    <span class="c1"># Re-optimize catalog now after removing include and exclude</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">exclude_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">include_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">include_halfws</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Now starting from the catalog chosen with the include/exclude</span>
    <span class="c1"># constraints applied, remove those constraints and re-optimize.</span>
    <span class="c1"># This must come back to the original catalog of the 8 bright stars.</span>
    <span class="k">del</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">optimize_catalog</span><span class="p">()</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">160</span><span class="p">)</span>

    <span class="c1"># Finally include all 8 stars</span>
    <span class="n">include_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>
    <span class="n">include_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">45</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="n">exp_include_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span>
                           <span class="n">include_ids</span><span class="o">=</span><span class="n">include_ids</span><span class="p">,</span> <span class="n">include_halfws</span><span class="o">=</span><span class="n">include_halfws</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">include_ids</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp_include_halfws</span></div>


<div class="viewcode-block" id="test_dither_as_sequence"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_dither_as_sequence">[docs]</a><span class="k">def</span> <span class="nf">test_dither_as_sequence</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that calling get_acq_catalog with a 2-element sequence (dither_y, dither_z)</span>
<span class="sd">    gives the expected response.  (Basically that it still returns a catalog).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">STD_INFO</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dither&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>

    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">dither</span> <span class="o">==</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_n_acq"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_n_acq">[docs]</a><span class="k">def</span> <span class="nf">test_n_acq</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that specifying n_acq with a value less than 8 gives the expected result.</span>
<span class="sd">    This test ensures that the optimization code that is testing against n_acq is</span>
<span class="sd">    also getting exercised by selecting a catalog where at least one candidate swap</span>
<span class="sd">    occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.07</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">10.005</span><span class="p">,</span> <span class="mf">10.035</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;AcqTable length=12&gt;&#39;</span><span class="p">,</span>
           <span class="s1">&#39; idx   slot   id    yang     zang   halfw&#39;</span><span class="p">,</span>
           <span class="s1">&#39;int64 int64 int32 float64  float64  int64&#39;</span><span class="p">,</span>
           <span class="s1">&#39;----- ----- ----- -------- -------- -----&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    0     0   100  2000.00     0.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    1     1   108  1500.00     0.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    2     2   101     0.00  2000.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    3     3   109     0.00  1500.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    4     4   102 -2000.00     0.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    5     5   110 -1500.00     0.00   160&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    6   -99   103     0.00 -2000.00   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    7   -99   111     0.00 -1500.00   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    8   -99   104  1000.00  1000.00   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;    9   -99   105  1000.00 -1000.00   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   10   -99   106 -1000.00  1000.00   120&#39;</span><span class="p">,</span>
           <span class="s1">&#39;   11   -99   107 -1000.00 -1000.00   120&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">repr</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">cand_acqs</span><span class="p">[</span><span class="n">TEST_COLS</span><span class="p">])</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span></div>


<div class="viewcode-block" id="test_warnings"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_warnings">[docs]</a><span class="k">def</span> <span class="nf">test_warnings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the ACACatalogTable warnings infrastructure works via a</span>
<span class="sd">    specific expected warning in get_acq_catalog (too few stars selected).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">n_stars</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">warnings</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;WARNING: Selected only 6 acq stars versus requested 8&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_no_candidates"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_no_candidates">[docs]</a><span class="k">def</span> <span class="nf">test_no_candidates</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that get_acq_catalog returns a well-formed but zero-length table for</span>
<span class="sd">    a star field with no acceptable candidates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="mf">13.0</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">STD_INFO</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">acqs</span><span class="o">.</span><span class="n">colnames</span>
    <span class="k">assert</span> <span class="s1">&#39;halfw&#39;</span> <span class="ow">in</span> <span class="n">acqs</span><span class="o">.</span><span class="n">colnames</span></div>


<div class="viewcode-block" id="get_dark_stars_simple"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.get_dark_stars_simple">[docs]</a><span class="k">def</span> <span class="nf">get_dark_stars_simple</span><span class="p">(</span><span class="n">box_size_thresh</span><span class="p">,</span> <span class="n">dither</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set-up for tests of optimized acq and fid selection::</span>

<span class="sd">      id    mag  status</span>
<span class="sd">      100   9.5  ok</span>
<span class="sd">      101   9.6  ok</span>
<span class="sd">      102   9.7  ok</span>
<span class="sd">      103    10  ok</span>
<span class="sd">        2   8.2  spoiled by fid 2 for box &gt; 90</span>
<span class="sd">        3  11.5  yellow spoiler for fid 3</span>
<span class="sd">        4  11.5  yellow spoiler for fid 4</span>

<span class="sd">    All fid sets have spoiler sum = 1 or 2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">box_size_thresh</span> <span class="o">+</span> <span class="n">FID</span><span class="o">.</span><span class="n">spoiler_margin</span> <span class="o">+</span> <span class="n">dither</span>

    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">9.6</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Add stars near fid light positions.  For fids 3, 4 put in fid spoilers</span>
    <span class="c1"># so the initial fid set is empty.</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_stars_from_fid</span><span class="p">(</span><span class="n">fid_id</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                                  <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                                  <span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">8.2</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">],</span>
                                  <span class="n">offset_y</span><span class="o">=</span><span class="p">[</span><span class="n">offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-S&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dark</span><span class="p">,</span> <span class="n">stars</span></div>


<div class="viewcode-block" id="test_acq_fid_catalog_probs_low_level"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_fid_catalog_probs_low_level">[docs]</a><span class="k">def</span> <span class="nf">test_acq_fid_catalog_probs_low_level</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Low-level tests of machinery to handle different fid light sets within</span>
<span class="sd">    acquisition probabilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Put an acq star at an offset from fid light id=2 such that for a search</span>
    <span class="c1"># box size larger than box_size_thresh, that star will be spoiled.  This</span>
    <span class="c1"># uses the equation in FidTable.spoils().</span>
    <span class="n">dither</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">box_size_thresh</span> <span class="o">=</span> <span class="mi">90</span>

    <span class="n">dark</span><span class="p">,</span> <span class="n">stars</span> <span class="o">=</span> <span class="n">get_dark_stars_simple</span><span class="p">(</span><span class="n">dither</span><span class="p">,</span> <span class="n">box_size_thresh</span><span class="p">)</span>

    <span class="c1"># Get the catalogs (n_guide=0 so skip guide selection)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-S&#39;</span><span class="p">,</span> <span class="n">optimize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">dark</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">]</span> <span class="o">==</span> <span class="mi">40</span><span class="p">)</span>

    <span class="c1"># Initial fid set is empty () and we check baseline p_safe</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_safe</span><span class="p">()),</span> <span class="o">-</span><span class="mf">2.4</span><span class="p">,</span>
                       <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># This is the acq star spoiled by fid_id=2</span>
    <span class="n">acq</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_id_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fid_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>  <span class="c1"># OK</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_id_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fid_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span>  <span class="c1"># spoiled</span>

    <span class="c1"># Caching of values</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">_p_fid_id_spoiler</span> <span class="o">==</span> <span class="p">{(</span><span class="n">box_size_thresh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mf">1.0</span><span class="p">,</span>
                                    <span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="mf">0.0</span><span class="p">}</span>

    <span class="c1"># With fid_set = (), the probability multiplier for any fid in the fid set</span>
    <span class="c1"># spoiling this star is 1.0, i.e. no fids spoil this star (since there</span>
    <span class="c1"># are no fids).</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>

    <span class="c1"># Now change the fid set to include ones (in particular fid_id=2) that</span>
    <span class="c1"># spoils an acq star.  This makes the p_safe value much worse.</span>
    <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># gets sorted when set</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_safe</span><span class="p">()),</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">,</span>
                       <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># With fid_set = (1, 2, 4), the probability multiplier for catalog</span>
    <span class="c1"># ids 2 and 4 are spoiled.  This test checks for star id=2 (which is</span>
    <span class="c1"># near fid_id=2).</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span>
    <span class="k">assert</span> <span class="n">p0</span><span class="o">.</span><span class="n">p_fid_spoiler</span><span class="p">(</span><span class="n">box_size_thresh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span>

    <span class="c1"># Reverting fid set also revert the p_safe value.  Note the (1, 3, 4)</span>
    <span class="c1"># set does not spoil an acq star.</span>
    <span class="k">for</span> <span class="n">fid_set</span> <span class="ow">in</span> <span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">()):</span>
        <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="n">fid_set</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_safe</span><span class="p">()),</span> <span class="o">-</span><span class="mf">2.4</span><span class="p">,</span>
                           <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="c1"># Check that p_acqs() method responds to fid_set in expected way</span>
    <span class="k">for</span> <span class="n">box_size</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">box_sizes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">man_err</span> <span class="ow">in</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">man_errs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">man_err</span> <span class="o">&gt;</span> <span class="n">box_size</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># p_acq always zero in this case, see AcqProbs.__init__()</span>

            <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">p_acq0</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">p_acqs</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">man_err</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span>

            <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">p_acq1</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;probs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">p_acqs</span><span class="p">(</span><span class="n">box_size</span><span class="p">,</span> <span class="n">man_err</span><span class="p">,</span> <span class="n">acqs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">box_size</span> <span class="o">&gt;</span> <span class="n">box_size_thresh</span><span class="p">:</span>
                <span class="c1"># Box includes spoiler so p_acq1 is 0</span>
                <span class="k">assert</span> <span class="n">p_acq0</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">assert</span> <span class="n">p_acq1</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># No spoiler, so no change in p_acq</span>
                <span class="k">assert</span> <span class="n">p_acq0</span> <span class="o">==</span> <span class="n">p_acq1</span></div>


<div class="viewcode-block" id="test_acq_fid_catalog_n_fid"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_fid_catalog_n_fid">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;n_fid_exp_fid_ids&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                               <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]),</span>
                                               <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])])</span>
<span class="k">def</span> <span class="nf">test_acq_fid_catalog_n_fid</span><span class="p">(</span><span class="n">n_fid_exp_fid_ids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test optimizing acq and fid in a simple case (which does exercise acq-fid</span>
<span class="sd">    optimization) with n_fid=1, 2, 3::</span>

<span class="sd">      id    mag  status</span>
<span class="sd">      100   9.5  ok</span>
<span class="sd">      101   9.6  ok</span>
<span class="sd">      102   9.7  ok</span>
<span class="sd">      103    10  ok</span>
<span class="sd">        2   8.2  spoiled by fid 2 for box &gt; 90</span>
<span class="sd">        3  11.5  yellow spoiler for fid 3</span>
<span class="sd">        4  11.5  yellow spoiler for fid 4</span>

<span class="sd">    For n_fid=1, this chooses fid_set=[1] because that is not spoiled and is</span>
<span class="sd">    not a spoiler.</span>

<span class="sd">    For n_fid=2, this chooses fid_set=[1, 4] to allow star id=2 to have a</span>
<span class="sd">    160&quot; box (maintaining the no-fid opt_P2).  Set [1, 3] would be the same</span>
<span class="sd">    but the [1, 3] separation is less than the [1, 4] separation.</span>

<span class="sd">    For n_fid=3, this choose fid_set=[1, 3, 4], again so star id=2 is free to</span>
<span class="sd">    have a 160&quot; box.  From the stage perspective the spoiler_score=1 fid sets</span>
<span class="sd">    have sufficiently degraded P2 that it moves on to the spoiler_score=2 set</span>
<span class="sd">    that includes fids 3 and 4.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Put an acq star at an offset from fid light id=2 such that for a search</span>
    <span class="c1"># box size larger than box_size_thresh, that star will be spoiled.  This</span>
    <span class="c1"># uses the equation in FidTable.spoils().</span>
    <span class="n">n_fid</span><span class="p">,</span> <span class="n">exp_fid_ids</span> <span class="o">=</span> <span class="n">n_fid_exp_fid_ids</span>  <span class="c1"># this is a 2-tuple</span>

    <span class="n">dither</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">box_size_thresh</span> <span class="o">=</span> <span class="mi">90</span>

    <span class="n">dark</span><span class="p">,</span> <span class="n">stars</span> <span class="o">=</span> <span class="n">get_dark_stars_simple</span><span class="p">(</span><span class="n">dither</span><span class="p">,</span> <span class="n">box_size_thresh</span><span class="p">)</span>

    <span class="c1"># Get the catalogs (n_guide=0 so skip guide selection)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="n">n_fid</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-S&#39;</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span>

    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp_fid_ids</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exp_fid_ids</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_acq_fid_catalog_zero_cand_fid"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_fid_catalog_zero_cand_fid">[docs]</a><span class="k">def</span> <span class="nf">test_acq_fid_catalog_zero_cand_fid</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test catalog selection with n_fid=3 requested but zero candidate fids.</span>
<span class="sd">    This should not happen in practice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dither</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">n_stars</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-S&#39;</span><span class="p">,</span> <span class="n">sim_offset</span><span class="o">=</span><span class="mi">300000</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="o">.</span><span class="n">cand_fids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="p">()</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span></div>


<div class="viewcode-block" id="test_acq_fid_catalog_one_cand_fid"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_fid_catalog_one_cand_fid">[docs]</a><span class="k">def</span> <span class="nf">test_acq_fid_catalog_one_cand_fid</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test optimizing acq and fid for an ACIS-S observation with large sim_offset</span>
<span class="sd">    (-55000) such that only ACIS-6 is still on the ACA CCD.  Add a couple of stars:</span>

<span class="sd">    - id=1 is 8.2 mag star that should be selected but is spoiled by fid id=6</span>
<span class="sd">      for box size &gt; 90.  Expect optimized size to be 80&quot;.</span>
<span class="sd">    - id=2 is 11.5 mag star that is a yellow spoiler for fid id=6.  Expect</span>
<span class="sd">      fid_set == (6,).</span>

<span class="sd">    This test is good because with fid_set=(6,) the final catalog does not meet</span>
<span class="sd">    stage requirements and thus excercise the path of never finding a good fid set.</span>
<span class="sd">    In that case the best available is selected with a warning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">box_size_thresh</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="n">dither</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">sim_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">55000</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">box_size_thresh</span> <span class="o">+</span> <span class="n">FID</span><span class="o">.</span><span class="n">spoiler_margin</span> <span class="o">+</span> <span class="n">dither</span>

    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">9.6</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Add stars near fid light positions.  For fids 3, 4 put in fid spoilers</span>
    <span class="c1"># so the initial fid set is empty.</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_stars_from_fid</span><span class="p">(</span><span class="n">fid_id</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                                  <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># assigned catalog ID</span>
                                  <span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">8.2</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">],</span>
                                  <span class="n">offset_y</span><span class="o">=</span><span class="p">[</span><span class="n">offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                                  <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;ACIS-S&#39;</span><span class="p">,</span> <span class="n">sim_offset</span><span class="o">=</span><span class="n">sim_offset</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;ACIS-S&#39;</span><span class="p">,</span> <span class="n">sim_offset</span><span class="o">=</span><span class="n">sim_offset</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,)</span>

    <span class="c1"># Not enough fids</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">warnings</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;WARNING: No acq-fid combination was &#39;</span>
                            <span class="s1">&#39;found that met stage requirements&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_acq_fid_catalog_two_cand_fid"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_fid_catalog_two_cand_fid">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;n_fid&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">test_acq_fid_catalog_two_cand_fid</span><span class="p">(</span><span class="n">n_fid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test optimizing acq and fid for an HRC-I observation with large sim_offset</span>
<span class="sd">    (29829) such that only two fids id=(1, 2) are still on the ACA CCD.  This</span>
<span class="sd">    is an ACIS undercover observation (obsid 19793 from DEC0516B).</span>

<span class="sd">    Add a couple of stars:</span>

<span class="sd">    - id=1 is 8.2 mag star that should be selected but is spoiled by fid id=1</span>
<span class="sd">      for box size &gt; 90.  Expect optimized size to be 80&quot;.</span>
<span class="sd">    - id=2 is 11.5 mag star that is a yellow spoiler for fid id=2.  Expect</span>
<span class="sd">      fid_set == (1, 2) with spoiler_score=1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">box_size_thresh</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="n">dither</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">sim_offset</span> <span class="o">=</span> <span class="mi">29829</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">box_size_thresh</span> <span class="o">+</span> <span class="n">FID</span><span class="o">.</span><span class="n">spoiler_margin</span> <span class="o">+</span> <span class="n">dither</span>

    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">9.6</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="c1"># Add stars near fid light positions.</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_stars_from_fid</span><span class="p">(</span><span class="n">fid_id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                  <span class="nb">id</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>  <span class="c1"># assigned catalog ID</span>
                                  <span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">8.2</span><span class="p">,</span> <span class="mf">11.5</span><span class="p">],</span>
                                  <span class="n">offset_y</span><span class="o">=</span><span class="p">[</span><span class="n">offset</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                                  <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-I&#39;</span><span class="p">,</span> <span class="n">sim_offset</span><span class="o">=</span><span class="n">sim_offset</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="n">dither</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="n">n_fid</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">detector</span><span class="o">=</span><span class="s1">&#39;HRC-I&#39;</span><span class="p">,</span> <span class="n">sim_offset</span><span class="o">=</span><span class="n">sim_offset</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">]</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">==</span> <span class="n">n_fid</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_0_5_degree_man_angle_bin"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_0_5_degree_man_angle_bin">[docs]</a><span class="k">def</span> <span class="nf">test_0_5_degree_man_angle_bin</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It was decided at the 2018-09-26 SSAWG to set the probability of</span>
<span class="sd">    man_err &gt; 60 to 0.0 for the 0-5 degree maneuver angle bin.  This tests</span>
<span class="sd">    that.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">7.99</span><span class="p">,</span> <span class="mf">8.01</span><span class="p">,</span> <span class="mf">8.99</span><span class="p">,</span> <span class="mf">9.01</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">t_ccd</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mf">4.8</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;box_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;box_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;box_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="s1">&#39;box_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="s1">&#39;box_sizes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">60</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_0_5_degree_man_angle_bin_diff_t_ccd"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_0_5_degree_man_angle_bin_diff_t_ccd">[docs]</a><span class="k">def</span> <span class="nf">test_0_5_degree_man_angle_bin_diff_t_ccd</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It was decided at the 2018-09-26 SSAWG to set the probability of</span>
<span class="sd">    man_err &gt; 60 to 0.0 for the 0-5 degree maneuver angle bin.  This tests</span>
<span class="sd">    that.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="p">[</span><span class="mf">7.99</span><span class="p">,</span> <span class="mf">8.01</span><span class="p">,</span> <span class="mf">8.99</span><span class="p">,</span> <span class="mf">9.01</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t_ccd</span><span class="p">,</span> <span class="n">halfws</span> <span class="ow">in</span> <span class="p">[(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">]),</span>
                          <span class="p">(</span><span class="o">-</span><span class="mi">11</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">])]:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">t_ccd</span><span class="o">=</span><span class="n">t_ccd</span><span class="p">,</span>
                              <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mf">4.8</span><span class="p">)</span>
        <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="n">halfws</span></div>


<div class="viewcode-block" id="test_bad_star_list"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_bad_star_list">[docs]</a><span class="k">def</span> <span class="nf">test_bad_star_list</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that a star with ID in the bad star list is not selected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bad_id</span> <span class="o">=</span> <span class="mi">39980640</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mf">10.3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="c1"># Bright star that would normally be selected</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">6.5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">bad_id</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mf">4.8</span><span class="p">)</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">bad_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">stars</span><span class="o">.</span><span class="n">get_id_idx</span><span class="p">(</span><span class="n">bad_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">acqs</span><span class="o">.</span><span class="n">bad_stars_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_acq_include_optimize_halfw_ids"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_include_optimize_halfw_ids">[docs]</a><span class="k">def</span> <span class="nf">test_acq_include_optimize_halfw_ids</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that force-include acq stars with halfw=0 get halfw optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">10.5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">zang</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">10.99</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">202</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                          <span class="n">include_ids_acq</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">202</span><span class="p">],</span>
                          <span class="n">include_halfws_acq</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">140</span><span class="p">])</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Confirm that halfw values are good</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">160</span>  <span class="c1"># Large box for a bright star</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span>  <span class="c1"># Small box for faint star</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">202</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">140</span>  <span class="c1"># Specified box size (not optimized)</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">include_optimize_halfw_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_acq_include_ids_no_halfws"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_include_ids_no_halfws">[docs]</a><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">&#39;halfw_kwargs&#39;</span><span class="p">,</span> <span class="p">({},</span> <span class="p">{</span><span class="s1">&#39;include_halfws_acq&#39;</span><span class="p">:</span> <span class="p">[]}))</span>
<span class="k">def</span> <span class="nf">test_acq_include_ids_no_halfws</span><span class="p">(</span><span class="n">halfw_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that force-include acq stars with no halfw provides works.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">10.99</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span>
                          <span class="n">n_guide</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                          <span class="n">include_ids_acq</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">],</span>
                          <span class="o">**</span><span class="n">halfw_kwargs</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Confirm that halfw values are good</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">160</span>  <span class="c1"># Large box for a bright star</span>
    <span class="n">star</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="mi">201</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">star</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span>  <span class="c1"># Small box for faint star</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">include_optimize_halfw_ids</span> <span class="o">==</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">]</span></div>


<div class="viewcode-block" id="test_acq_include_ids_no_halfws_full_catalog"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_include_ids_no_halfws_full_catalog">[docs]</a><span class="k">def</span> <span class="nf">test_acq_include_ids_no_halfws_full_catalog</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for all 8 acq_ids provided with no include_halfws provided&quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">10.6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">n_guide</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">exp_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">exp_halfws</span><span class="p">)</span>

    <span class="c1"># Now force-include all acq stars but with halfws re-optimized.</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;include_ids_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">aca2</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Not exactly the same, but close enough.</span>
    <span class="n">exp_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca2</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">exp_halfws</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_acq_include_ids_all_halfws_full_catalog"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_include_ids_all_halfws_full_catalog">[docs]</a><span class="k">def</span> <span class="nf">test_acq_include_ids_all_halfws_full_catalog</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for all 8 acq_ids provided with no include_halfws provided&quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">9.5</span><span class="p">,</span> <span class="mf">10.6</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">n_guide</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">man_angle</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">exp_halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">exp_halfws</span><span class="p">)</span>

    <span class="c1"># Now force-include all acq stars but with halfws re-optimized.</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;include_ids_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;include_halfws_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span>
    <span class="n">aca2</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca2</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_safe</span><span class="p">()</span> <span class="o">==</span> <span class="n">aca2</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">calc_p_safe</span><span class="p">()</span></div>


<div class="viewcode-block" id="test_acq_include_ids_all_halfws_full_catalog_with_spoiler"><a class="viewcode-back" href="../../../unit_tests.html#proseco.tests.test_acq.test_acq_include_ids_all_halfws_full_catalog_with_spoiler">[docs]</a><span class="k">def</span> <span class="nf">test_acq_include_ids_all_halfws_full_catalog_with_spoiler</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Test for all 8 acq_ids provided with all include_halfws provided.</span>

<span class="sd">    Importantly include stars for which the p_acq is not increasing in the</span>
<span class="sd">    same order as mag. This is the root cause of #323.  For this test two</span>
<span class="sd">    bright acq stars with a strong spoiler are included.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
    <span class="n">dark</span> <span class="o">=</span> <span class="n">DARK40</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">108</span><span class="p">)</span>
    <span class="n">halfws</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">]</span>
    <span class="n">mags</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.6</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">,</span> <span class="mf">9.8</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mf">8.5</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span>

    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_constellation</span><span class="p">(</span><span class="n">mag</span><span class="o">=</span><span class="n">mags</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">ids</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="n">mags</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="n">mags</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="n">ids</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">stars</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="n">yang</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>  <span class="c1"># Strong spoiler for 106 and 107</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">mod_std_info</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">stars</span><span class="p">,</span> <span class="n">dark</span><span class="o">=</span><span class="n">dark</span><span class="p">,</span> <span class="n">n_guide</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_fid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_acq</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                          <span class="n">man_angle</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">include_ids_acq</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">include_halfws_acq</span><span class="o">=</span><span class="n">halfws</span><span class="p">)</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ids</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">],</span> <span class="n">mags</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">halfws</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.1.2. &nbsp;
  </p>
</footer>
  </body>
</html>