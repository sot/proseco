
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>proseco.guide &#8212; proseco 5.8.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">proseco</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">proseco 5.8.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for proseco.guide</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="kn">import</span> <span class="nn">chandra_aca.aca_image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">chandra_aca.aca_image</span> <span class="kn">import</span> <span class="n">ACAImage</span><span class="p">,</span> <span class="n">AcaPsfLibrary</span>
<span class="kn">from</span> <span class="nn">chandra_aca.transform</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">count_rate_to_mag</span><span class="p">,</span>
    <span class="n">mag_to_count_rate</span><span class="p">,</span>
    <span class="n">snr_mag_for_t_ccd</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">proseco.characteristics</span> <span class="kn">import</span> <span class="n">MonFunc</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">characteristics</span> <span class="k">as</span> <span class="n">ACA</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">characteristics_guide</span> <span class="k">as</span> <span class="n">GUIDE</span>
<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ACACatalogTable</span><span class="p">,</span>
    <span class="n">AliasAttribute</span><span class="p">,</span>
    <span class="n">MetaAttribute</span><span class="p">,</span>
    <span class="n">bin2x2</span><span class="p">,</span>
    <span class="n">get_dim_res</span><span class="p">,</span>
    <span class="n">get_img_size</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">CCD</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">CCD</span>
<span class="n">APL</span> <span class="o">=</span> <span class="n">AcaPsfLibrary</span><span class="p">()</span>

<span class="n">STAR_PAIR_DIST_CACHE</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="get_guide_catalog"><a class="viewcode-back" href="../../api.html#proseco.guide.get_guide_catalog">[docs]</a><span class="k">def</span> <span class="nf">get_guide_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a catalog of guide stars</span>

<span class="sd">    If ``obsid`` corresponds to an already-scheduled obsid then the parameters</span>
<span class="sd">    ``att``, ``t_ccd``, ``date``, and ``dither`` will</span>
<span class="sd">    be fetched via ``mica.starcheck`` if not explicitly provided here.</span>

<span class="sd">    :param obsid: obsid (default=0)</span>
<span class="sd">    :param att: attitude (any object that can initialize Quat)</span>
<span class="sd">    :param t_ccd: ACA CCD temperature (degC)</span>
<span class="sd">    :param date: date of acquisition (any DateTime-compatible format)</span>
<span class="sd">    :param dither: dither size 2-element tuple: (dither_y, dither_z) (float, arcsec)</span>
<span class="sd">    :param n_guide: number of guide stars to attempt to get</span>
<span class="sd">    :param fids: selected fids (used for guide star exclusion)</span>
<span class="sd">    :param stars: astropy.Table of AGASC stars (will be fetched from agasc if None)</span>
<span class="sd">    :param include_ids: list of AGASC IDs of stars to include in guide catalog</span>
<span class="sd">    :param exclude_ids: list of AGASC IDs of stars to exclude from guide catalog</span>
<span class="sd">    :param dark: ACAImage of dark map (fetched based on time and t_ccd if None)</span>
<span class="sd">    :param print_log: print the run log to stdout (default=False)</span>

<span class="sd">    :returns: GuideTable of acquisition stars</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">STAR_PAIR_DIST_CACHE</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">guides</span> <span class="o">=</span> <span class="n">GuideTable</span><span class="p">()</span>
    <span class="n">guides</span><span class="o">.</span><span class="n">set_attrs_from_kwargs</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">guides</span><span class="o">.</span><span class="n">set_stars</span><span class="p">()</span>

    <span class="c1"># Process monitor window requests, converting them into fake stars that</span>
    <span class="c1"># are added to the include_ids list.</span>
    <span class="n">guides</span><span class="o">.</span><span class="n">process_monitors_pre</span><span class="p">()</span>

    <span class="c1"># Do a first cut of the stars to get a set of reasonable candidates</span>
    <span class="n">guides</span><span class="o">.</span><span class="n">cand_guides</span> <span class="o">=</span> <span class="n">guides</span><span class="o">.</span><span class="n">get_initial_guide_candidates</span><span class="p">()</span>

    <span class="c1"># Process guide-from-monitor requests by finding corresponding star in</span>
    <span class="c1"># cand_guides and adding to the include_ids list.</span>
    <span class="c1"># guides.process_monitors_pre2()</span>

    <span class="c1"># Run through search stages to select stars</span>
    <span class="n">selected</span> <span class="o">=</span> <span class="n">guides</span><span class="o">.</span><span class="n">run_search_stages</span><span class="p">()</span>

    <span class="c1"># Transfer to table (which at this point is an empty table)</span>
    <span class="n">guides</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">selected</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">guides</span><span class="o">.</span><span class="n">n_guide</span><span class="p">:</span>
        <span class="n">guides</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Selected only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span><span class="si">}</span><span class="s2"> guide stars versus requested </span><span class="si">{</span><span class="n">guides</span><span class="o">.</span><span class="n">n_guide</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">img_size</span> <span class="o">=</span> <span class="n">guides</span><span class="o">.</span><span class="n">get_img_size</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;sz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">img_size</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img_size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GUI&quot;</span>
        <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;maxmag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_maxmag</span><span class="p">)</span>
        <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;dim&quot;</span><span class="p">],</span> <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dim_res</span><span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">])</span>

        <span class="n">guides</span><span class="o">.</span><span class="n">process_monitors_post</span><span class="p">()</span>

    <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">guides</span></div>


<span class="k">class</span> <span class="nc">ImgSizeMetaAttribute</span><span class="p">(</span><span class="n">MetaAttribute</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;img_size must be 4, 6, 8, or None&quot;</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<div class="viewcode-block" id="GuideTable"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable">[docs]</a><span class="k">class</span> <span class="nc">GuideTable</span><span class="p">(</span><span class="n">ACACatalogTable</span><span class="p">):</span>
    <span class="c1"># Define base set of allowed keyword args to __init__. Subsequent MetaAttribute</span>
    <span class="c1"># or AliasAttribute properties will add to this.</span>
    <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="n">ACACatalogTable</span><span class="o">.</span><span class="n">allowed_kwargs</span> <span class="o">|</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;fids&quot;</span><span class="p">])</span>

    <span class="c1"># Catalog type when plotting (None | &#39;FID&#39; | &#39;ACQ&#39; | &#39;GUI&#39;)</span>
    <span class="n">catalog_type</span> <span class="o">=</span> <span class="s2">&quot;GUI&quot;</span>

    <span class="c1"># Elements of meta that should not be directly serialized to pickle.</span>
    <span class="c1"># (either too big or requires special handling).</span>
    <span class="n">pickle_exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;stars&quot;</span><span class="p">,</span> <span class="s2">&quot;dark&quot;</span><span class="p">)</span>

    <span class="c1"># Name of table.  Use to define default file names where applicable.</span>
    <span class="c1"># (e.g. `obs19387/guide.pkl`).</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;guide&quot;</span>

    <span class="c1"># Required attributes</span>
    <span class="n">required_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;att&quot;</span><span class="p">,</span> <span class="s2">&quot;t_ccd_guide&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;dither_guide&quot;</span><span class="p">,</span> <span class="s2">&quot;n_guide&quot;</span><span class="p">)</span>

    <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">reject_info</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">img_size</span> <span class="o">=</span> <span class="n">ImgSizeMetaAttribute</span><span class="p">()</span>

<div class="viewcode-block" id="GuideTable.reject"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.reject">[docs]</a>    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a reject dict to self.reject_info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reject_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reject_info</span>
        <span class="n">reject_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reject</span><span class="p">)</span></div>

    <span class="n">t_ccd</span> <span class="o">=</span> <span class="n">AliasAttribute</span><span class="p">()</span>  <span class="c1"># Maps t_ccd to t_ccd_guide attribute from base class</span>
    <span class="n">dither</span> <span class="o">=</span> <span class="n">AliasAttribute</span><span class="p">()</span>  <span class="c1"># .. and likewise.</span>
    <span class="n">include_ids</span> <span class="o">=</span> <span class="n">AliasAttribute</span><span class="p">()</span>
    <span class="n">exclude_ids</span> <span class="o">=</span> <span class="n">AliasAttribute</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process_monitors_pre</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># No action required if there are no monitor stars requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span><span class="o">.</span><span class="n">monitors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">monitors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span><span class="o">.</span><span class="n">monitors</span>
        <span class="n">is_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">monitors</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">MonFunc</span><span class="o">.</span><span class="n">MON_FIXED</span><span class="p">,</span> <span class="n">MonFunc</span><span class="o">.</span><span class="n">MON_TRACK</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">is_mon</span><span class="p">):</span>
            <span class="c1"># For MON fixed and tracked, the dark cal map gets hacked to make a</span>
            <span class="c1"># local blob of hot pixels. Make a copy to avoid modifying the global</span>
            <span class="c1"># dark map which is shared by reference between acqs, guides and fids.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="n">monitors</span><span class="p">[</span><span class="n">is_mon</span><span class="p">]:</span>
            <span class="c1"># Make a square blob of saturated pixels that will keep away any</span>
            <span class="c1"># star selection.</span>
            <span class="n">is_track</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">MonFunc</span><span class="o">.</span><span class="n">MON_TRACK</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">row</span> <span class="k">if</span> <span class="n">is_track</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">col</span> <span class="k">if</span> <span class="n">is_track</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">512</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">[</span>
                <span class="n">row</span> <span class="o">-</span> <span class="n">dr</span> <span class="p">:</span> <span class="n">row</span> <span class="o">+</span> <span class="n">dr</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="n">dc</span> <span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="n">dc</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">bad_pixel_dark_current</span>  <span class="c1"># noqa</span>

            <span class="c1"># Reduce n_guide for each MON. On input the n_guide arg is the</span>
            <span class="c1"># number of GUI + MON, but for guide selection we need to make the</span>
            <span class="c1"># MON slots unavailable.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;too many MON requests leaving &lt; 2 guide stars&quot;</span><span class="p">)</span>

        <span class="n">is_guide</span> <span class="o">=</span> <span class="n">monitors</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">MonFunc</span><span class="o">.</span><span class="n">GUIDE</span>
        <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="n">monitors</span><span class="p">[</span><span class="n">is_guide</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="GuideTable.process_monitors_post"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.process_monitors_post">[docs]</a>    <span class="k">def</span> <span class="nf">process_monitors_post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Post-processing of monitor windows.</span>

<span class="sd">        - Clean up fake stars from stars and cand_guides</span>
<span class="sd">        - Restore the dark current map</span>
<span class="sd">        - Set type, sz, res, dim columns for relevant entries to reflect</span>
<span class="sd">          status as monitor or guide-from-monitor in the guides catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No action required if there are no monitor stars requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span><span class="o">.</span><span class="n">monitors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Mon window processing munges the dark cal to impose a keep-out zone.</span>
        <span class="c1"># Put the dark current back to the standard one if possible</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acqs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">dark</span>

        <span class="c1"># Find the guide stars that are actually from a MON request (converted</span>
        <span class="c1"># to guide) and set the size and type.</span>
        <span class="k">for</span> <span class="n">monitor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mons</span><span class="o">.</span><span class="n">monitors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">MonFunc</span><span class="o">.</span><span class="n">GUIDE</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">monitor</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;8x8&quot;</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GFM&quot;</span>  <span class="c1"># Guide From Monitor, changed in merge_catalog</span></div>

<div class="viewcode-block" id="GuideTable.get_img_size"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.get_img_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_img_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_fids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get guide image readout size from ``img_size`` and ``n_fids``.</span>

<span class="sd">        If img_size is None (typical case) then this uses the default rules</span>
<span class="sd">        defined in ``core.get_img_size()``, namely 8x8 for all guide stars</span>
<span class="sd">        unless overridden by the PROSECO_OR_IMAGE_SIZE environment variable.</span>

<span class="sd">        This requires that the ``fids`` attribute has been set, normally by</span>
<span class="sd">        providing the table as an arg to ``get_guide_catalog()``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n_fids : int or None</span>
<span class="sd">            Number of fids in the catalog</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        int</span>
<span class="sd">            Guide star image readout size to be used in a catalog</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_fids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_fids</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">)</span>

        <span class="n">img_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_size</span>

        <span class="k">if</span> <span class="n">img_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Call the function from core as the single source for the rule.</span>
            <span class="n">img_size</span> <span class="o">=</span> <span class="n">get_img_size</span><span class="p">(</span><span class="n">n_fids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">img_size</span></div>

<div class="viewcode-block" id="GuideTable.make_report"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.make_report">[docs]</a>    <span class="k">def</span> <span class="nf">make_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make summary HTML report for guide selection process and outputs.</span>

<span class="sd">        Output is in ``&lt;rootdir&gt;/obs&lt;obsid&gt;/guide/index.html`` plus related images</span>
<span class="sd">        in that directory.</span>

<span class="sd">        :param rootdir: root directory for outputs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.report_guide</span> <span class="kn">import</span> <span class="n">make_report</span>

        <span class="n">make_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="n">rootdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="GuideTable.run_search_stages"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.run_search_stages">[docs]</a>    <span class="k">def</span> <span class="nf">run_search_stages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run search stages as necessary to select up to the requested number of guide stars.</span>

<span class="sd">        This routine first force selects any guide stars supplied as ``include_ids``, marking</span>
<span class="sd">        these as selected in stage 0 in the &#39;stage&#39; column in the candidate table, and then</span>
<span class="sd">        runs search stages.</span>

<span class="sd">        In each &quot;search stage&quot;, checks are run on each candidate to exclude candidates that</span>
<span class="sd">        do not meet the selection criteria in the stage.  Candidates that satisfy the</span>
<span class="sd">        stage requirements are marked with the allowed stage of selection (by its integer id)</span>
<span class="sd">        in the &#39;stage&#39; column in the candidate table.</span>

<span class="sd">        The run_search_stages method loops over the search stages until at least the</span>
<span class="sd">        ``n_guide`` requested stars are marked with a stage &gt;= 0 or until all stage checks have</span>
<span class="sd">        been exhausted.  This run_search_stages routine then sorts the candidates by</span>
<span class="sd">        selected stage and magnitude and returns up to the n requested guide stars as</span>
<span class="sd">        the selected stars.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cand_guides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Starting search stages&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;There are no candidates to check in stages.  Exiting&quot;</span><span class="p">)</span>
            <span class="c1"># Since there are no candidate stars, this returns the empty set of</span>
            <span class="c1"># cand_guides as the &#39;selected&#39; stars.</span>
            <span class="k">return</span> <span class="n">cand_guides</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># Force stars in include_ids to be selected at stage 0</span>
        <span class="k">for</span> <span class="n">star_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_ids</span><span class="p">:</span>
            <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">][</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">star_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">star_id</span><span class="si">}</span><span class="s2"> selected in stage 0 via include_ids&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_guide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">stages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">already_selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If we don&#39;t have enough stage-selected candidates, keep going.</span>
            <span class="c1"># Enough is defined as the requested n_guide + a &quot;surplus&quot; value</span>
            <span class="c1"># in characteristics</span>
            <span class="k">if</span> <span class="n">already_selected</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_guide</span> <span class="o">+</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">surplus_stars</span><span class="p">):</span>
                <span class="n">stage_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">][</span><span class="n">stage_ok</span> <span class="o">&amp;</span> <span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">stage_selected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">stage_ok</span> <span class="o">&amp;</span> <span class="n">sel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_selected</span><span class="si">}</span><span class="s2"> stars selected in stage </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Quitting after stage </span><span class="si">{</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">already_selected</span><span class="si">}</span><span class="s2"> stars&quot;</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Done with search stages&quot;</span><span class="p">)</span>
        <span class="n">stage_cands</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">stage_cands</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;stage&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">])</span>
        <span class="n">stage_cands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_overlaps</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">)</span>
        <span class="n">guides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_catalog</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">n_guide</span> <span class="o">+</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">surplus_stars</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_bgd_n_faint</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_excess_bonus_stars</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span><span class="si">}</span><span class="s2"> candidates after all search stages&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">guides</span></div>

<div class="viewcode-block" id="GuideTable.drop_excess_bonus_stars"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.drop_excess_bonus_stars">[docs]</a>    <span class="k">def</span> <span class="nf">drop_excess_bonus_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">guides</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drop excess dynamic background faint &quot;bonus&quot; stars if necessary.</span>

<span class="sd">        For dyn bgd with dyn_bgd_n_faint &gt; 0, candidates fainter then the</span>
<span class="sd">        nominal faint limit can be selected. However, only at most</span>
<span class="sd">        dyn_bgd_n_faint of these bonus faint stars are allowed in the final</span>
<span class="sd">        catalog.</span>

<span class="sd">        This method removes faint bonus stars (in-place within ``guides``) in</span>
<span class="sd">        excess of the allowed dyn_bgd_n_faint number. It is assumed that the</span>
<span class="sd">        catalog order is by star preference (&#39;stage&#39;, &#39;mag&#39;), so bonus stars</span>
<span class="sd">        that come first are kept.</span>

<span class="sd">        :param guides: Table of guide stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_bonus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Compute the non-bonus faint_mag_limit</span>
        <span class="n">faint_mag_limit</span> <span class="o">=</span> <span class="n">snr_mag_for_t_ccd</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span><span class="p">,</span> <span class="n">ref_mag</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">ref_faint_mag</span><span class="p">,</span> <span class="n">ref_t_ccd</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">ref_faint_mag_t_ccd</span>
        <span class="p">)</span>
        <span class="n">idxs_drop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">faint_mag_limit</span><span class="p">:</span>
                <span class="n">n_bonus</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">n_bonus</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_bgd_n_faint</span><span class="p">:</span>
                    <span class="n">idxs_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idxs_drop</span><span class="p">:</span>
            <span class="n">guides</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">idxs_drop</span><span class="p">)</span></div>

<div class="viewcode-block" id="GuideTable.exclude_overlaps"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.exclude_overlaps">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_cands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Review the stars selected at any stage and exclude stars that overlap in</span>
<span class="sd">        tracking space with another. Overlap is defined as being within 12 pixels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Checking for guide star overlap in stage-selected stars&quot;</span><span class="p">)</span>
        <span class="n">nok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">star</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">):</span>

            <span class="c1"># If the star was manually-selected, don&#39;t bother checking to possibly exclude it.</span>
            <span class="k">if</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_ids</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">jdx</span><span class="p">,</span> <span class="n">other_star</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">):</span>

                <span class="c1"># The stage_cands are supplied in the order of preference (currently by mag)</span>
                <span class="c1"># Check and exclude a guide star only if it would spoil a lower index (better) star.</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">jdx</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">drow</span> <span class="o">=</span> <span class="n">other_star</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span>
                <span class="n">dcol</span> <span class="o">=</span> <span class="n">other_star</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">drow</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">12</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dcol</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Rejecting star </span><span class="si">{</span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with track overlap (12 pixels) &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;with star </span><span class="si">{</span><span class="n">other_star</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;overlap&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> has track overlap (12 pixels) &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;with star </span><span class="si">{</span><span class="n">other_star</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">nok</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">stage_cands</span><span class="p">[</span><span class="o">~</span><span class="n">nok</span><span class="p">]</span></div>

<div class="viewcode-block" id="GuideTable.select_catalog"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.select_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">select_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_cands</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the candidates selected at any stage (stage-assigned candidates?) select the</span>
<span class="sd">        first combination that satisfies the most number of extra tests.</span>
<span class="sd">        Here the extra tests are just the 3 checks for guide stars that are</span>
<span class="sd">        too tightly clustered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selecting catalog from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">)</span><span class="si">}</span><span class="s2"> stage-selected stars&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">index_combinations</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n_tmp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_tmp</span><span class="p">),</span> <span class="n">m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">comb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">comb</span>

        <span class="c1"># Set a dictionary to save the first combination of that satisfies N tests.</span>
        <span class="c1"># This will be used if no combination satisfies all the tests.</span>
        <span class="n">select_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># I should come back to this and see if the &quot;min&quot; is needed or if the combinations</span>
        <span class="c1"># code runs fine even if we have fewer-than-expected stage_cands to start</span>
        <span class="n">choose_m</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span><span class="p">)</span>

        <span class="n">n_tries</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n_tries</span><span class="p">,</span> <span class="n">comb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">index_combinations</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stage_cands</span><span class="p">),</span> <span class="n">choose_m</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">cands</span> <span class="o">=</span> <span class="n">stage_cands</span><span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span>
            <span class="p">]</span>  <span class="c1"># (note that [(1,2)] is not the same as list((1,2))</span>
            <span class="n">n_pass</span><span class="p">,</span> <span class="n">n_tests</span> <span class="o">=</span> <span class="n">run_select_checks</span><span class="p">(</span>
                <span class="n">cands</span>
            <span class="p">)</span>  <span class="c1"># This function knows how many tests get run</span>
            <span class="k">if</span> <span class="n">n_pass</span> <span class="o">==</span> <span class="n">n_tests</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Selected stars passing all tests at combination </span><span class="si">{</span><span class="n">n_tries</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">tried_combinations</span><span class="o">=</span><span class="n">n_tries</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">cands</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n_pass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">select_results</span><span class="p">:</span>
                    <span class="c1"># Keep a copy of the first cands table with n_pass passing tests</span>
                    <span class="n">select_results</span><span class="p">[</span><span class="n">n_pass</span><span class="p">]</span> <span class="o">=</span> <span class="n">cands</span>

        <span class="c1"># Return the catalog with the maximum n_pass key value</span>
        <span class="n">max_n_pass</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">select_results</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Settled for combination that satisfied </span><span class="si">{</span><span class="n">max_n_pass</span><span class="si">}</span><span class="s2"> cluster checks&quot;</span><span class="p">,</span>
            <span class="n">warning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">tried_combinations</span><span class="o">=</span><span class="n">n_tries</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">select_results</span><span class="p">[</span><span class="n">max_n_pass</span><span class="p">]</span></div>

<div class="viewcode-block" id="GuideTable.search_stage"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.search_stage">[docs]</a>    <span class="k">def</span> <span class="nf">search_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Review the candidates with the criteria defined in ``stage`` and return a mask that</span>
<span class="sd">        marks the candidates that are &quot;ok&quot; for this search stage.  This is used to then</span>
<span class="sd">        annotate the candidate table when called from run_search_stages to mark the stars that could</span>
<span class="sd">        be selected in a stage.  As candidate stars are &quot;rejected&quot; in the stage, details</span>
<span class="sd">        of that rejection are also added to self.reject_info .</span>

<span class="sd">        Additionally, candidate stars that do not pass a check in the stage get their error</span>
<span class="sd">        bitmask in &#39;stat_{n_stage}&#39; marked up with the error.</span>

<span class="sd">        Candidates are not removed from the tble in this routine; the length of the candidate</span>
<span class="sd">        table should not change after get_initial_guide_candidates (called before this routine).</span>
<span class="sd">        Instead, as mentioned, this routine marks up informational columns in the table and returns</span>
<span class="sd">        a mask of the &quot;ok&quot; stars in the stage.</span>

<span class="sd">        **Details**:</span>

<span class="sd">        In each stage, the dictionary of characteristics for the stage is used to run the checks to</span>
<span class="sd">        see which candidates would be allowed. For example, the Stage 1 dictionary looks like::</span>

<span class="sd">          {&quot;Stage&quot;: 1,</span>
<span class="sd">            &quot;SigErrMultiplier&quot;: 3,</span>
<span class="sd">            &quot;ASPQ1Lim&quot;: 0,</span>
<span class="sd">            &quot;MagLimit&quot;: [5.6, 10.2],</span>
<span class="sd">            &quot;DoBminusVcheck&quot;: 1,</span>
<span class="sd">            &quot;Spoiler&quot;: {</span>
<span class="sd">             &quot;BgPixThresh&quot;: 25,</span>
<span class="sd">             &quot;RegionFrac&quot;: .05,</span>
<span class="sd">             },</span>
<span class="sd">            &quot;Imposter&quot;: {</span>
<span class="sd">             &quot;CentroidOffsetLim&quot;: .2,</span>
<span class="sd">             }}</span>

<span class="sd">        In each stage these checks are run:</span>

<span class="sd">        1. Candidate star magnitude is checked to see if it is within the range plus error.</span>
<span class="sd">        For stage 1 for example , each candidate star is checked to see if it is within the</span>
<span class="sd">        5.6 to 10.2 mag range, minus padding for error (SigErrMultiplier * cand[&#39;mag_err&#39;]).</span>

<span class="sd">        2. Candidates with ASPQ1 &gt; stage ASPQ1Lim are marked for exclusion.</span>

<span class="sd">        3. Candidates with local dark current that suggests that the candidate centroid could</span>
<span class="sd">        be shifted more that CentroidOffsetLim (in arcsecs) are marked for exclusion.  The value of</span>
<span class="sd">        the local dark current was previously saved during &quot;get_initial_guide_candidates&quot; as</span>
<span class="sd">        &quot;imp_mag&quot;.</span>

<span class="sd">        4. check_mag_spoilers is used to mark candidate stars that have spoilers that are too</span>
<span class="sd">        close for the magnitude delta to the candidate as defined by the &quot;line&quot; used by that check.</span>
<span class="sd">        The &quot;line&quot; basically works as a check that requires a minimum position separation for</span>
<span class="sd">        a delta magnitude.  A candidate star with a spoiler of the same magnitude would require</span>
<span class="sd">        that spoiler star to be Intercept (9 pixels) away.  A candidate star with a spoiler with</span>
<span class="sd">        no separation would require the spoiler to be 18 mags fainter::</span>

<span class="sd">          (9 pixels +</span>
<span class="sd">          (cand[&#39;mag&#39;] - spoiler[&#39;mag&#39;] + SigErrMultiplier * mag_err_sum) * 0.5 pix / dmag)</span>

<span class="sd">        The parameters of the check are not stage dependent, but the mag err there is defined as</span>
<span class="sd">        SigErrMultiplier * mag_err_sum (MAG_ACA_ERR of candidate and spoiler added in quadrature).</span>

<span class="sd">        5. check_spoil_contrib is used to mark candidate stars that have spoilers that contribute</span>
<span class="sd">        too much light onto either the the 8x8 image window or to the 8 background pixels.  &quot;Too</span>
<span class="sd">        much&quot; is defined by the Spoiler parameters of the stage, where in stage 1 a candidate</span>
<span class="sd">        star will be excluded if either:</span>

<span class="sd">           - the sum of the light from spoiler stars in the 8x8 contribute more than</span>
<span class="sd">              (candidate star magnitude in counts) * (RegionFrac).</span>

<span class="sd">           - the sum of the light from spoiler stars on any background pixel is greater</span>
<span class="sd">             that the BgPixThresh percentile of the current dark current.</span>

<span class="sd">        6. check_column_spoilers marks candidates for exclusion if they have column spoilers</span>
<span class="sd">        defined as spoilers between the candidate and the readout register, within</span>
<span class="sd">        characterstics.col_spoiler_pix_sep (10 columns), and 4.5 mags brighter (minus error)</span>
<span class="sd">        than the candidate.  The error is the stage-dependent term where it is set as</span>
<span class="sd">        SigErrMultiplier * (the candidate MAG_ACA_ERR and the spoiler MAG_ACA_ERR added in</span>
<span class="sd">        quadrature).</span>

<span class="sd">        7. Candidates are then screened for &quot;bad&quot; color (COLOR1 == 0.700) if DoBMinusVCheck</span>
<span class="sd">        is set for the stage.</span>

<span class="sd">        :param stage: dictionary of search stage parameters</span>
<span class="sd">        :returns: bool mask of the length of self.meta.cand_guides with true set for &quot;ok&quot; stars</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cand_guides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cand_guides</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span>
        <span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Adopt the SAUSAGE convention of a bit array for errors</span>
        <span class="c1"># Not all items will be checked for each star (allow short circuit)</span>
        <span class="n">scol</span> <span class="o">=</span> <span class="s2">&quot;stat_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">])</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">n_sigma</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;SigErrMultiplier&quot;</span><span class="p">]</span>

        <span class="c1"># And for bright stars, use a local mag_err that is lower bounded at 0.1</span>
        <span class="c1"># for the mag selection.</span>
        <span class="n">mag_err</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag_err&quot;</span><span class="p">]</span>
        <span class="n">bright</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">7.0</span>
        <span class="n">mag_err</span><span class="p">[</span><span class="n">bright</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_err</span><span class="p">[</span><span class="n">bright</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="c1"># Also set any color=0.7 stars to have lower bound mag err of 0.5</span>
        <span class="n">bad_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">],</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="n">mag_err</span><span class="p">[</span><span class="n">bad_color</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_err</span><span class="p">[</span><span class="n">bad_color</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Check reasonable mag</span>
        <span class="n">bright_lim</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;MagLimit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">faint_lim</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;MagLimit&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Confirm that the star mag is not outside the limits when padded by error.</span>
        <span class="c1"># For the bright end of the check, set a lower bound to always use at least 1</span>
        <span class="c1"># mag_err, but do not bother with this bound at the faint end of the check.</span>
        <span class="c1"># Also explicitly confirm that the star is not within 2 * mag_err of the hard</span>
        <span class="c1"># bright limit (which is basically 5.2, but if bright lim set to less than 5.2</span>
        <span class="c1"># in the stage, take that).</span>
        <span class="n">bad_mag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">((</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_sigma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">mag_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">bright_lim</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">((</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_sigma</span> <span class="o">*</span> <span class="n">mag_err</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">faint_lim</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">((</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mag_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">bright_lim</span><span class="p">,</span> <span class="mf">5.2</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bad_mag</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;mag outside range&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;bright_lim&quot;</span><span class="p">:</span> <span class="n">bright_lim</span><span class="p">,</span>
                    <span class="s2">&quot;faint_lim&quot;</span><span class="p">:</span> <span class="n">faint_lim</span><span class="p">,</span>
                    <span class="s2">&quot;cand_mag&quot;</span><span class="p">:</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;cand_mag_err_times_sigma&quot;</span><span class="p">:</span> <span class="n">n_sigma</span> <span class="o">*</span> <span class="n">mag_err</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1"> rejected with &#39;</span>
                        <span class="s2">&quot;mag outside range for stage&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">bad_mag</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;mag range&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad_mag</span>

        <span class="c1"># Check stage ASPQ1</span>
        <span class="n">bad_aspq1</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;ASPQ1&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;ASPQ1Lim&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bad_aspq1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;aspq1 outside range&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;aspq1_lim&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;ASPQ1Lim&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1"> rejected with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;aspq1 &gt; </span><span class="si">{</span><span class="n">stage</span><span class="p">[</span><span class="s2">&quot;ASPQ1Lim&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">bad_aspq1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;aspq1&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad_aspq1</span>

        <span class="c1"># Check for bright pixels</span>
        <span class="n">pixmag_lims</span> <span class="o">=</span> <span class="n">get_pixmag_for_offset</span><span class="p">(</span>
            <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">],</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Imposter&quot;</span><span class="p">][</span><span class="s2">&quot;CentroidOffsetLim&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Which candidates have an &#39;imposter&#39; brighter than the limit for this stage</span>
        <span class="n">imp_spoil</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;imp_mag&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pixmag_lims</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">imp_spoil</span><span class="p">):</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">cen_limit</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Imposter&quot;</span><span class="p">][</span><span class="s2">&quot;CentroidOffsetLim&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;hot pixel&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;centroid_offset_thresh&quot;</span><span class="p">:</span> <span class="n">cen_limit</span><span class="p">,</span>
                    <span class="s2">&quot;pseudo_mag_for_thresh&quot;</span><span class="p">:</span> <span class="n">pixmag_lims</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;imposter_mag&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;imp_mag&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;imp_row_start&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;imp_r&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;imp_col_start&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;imp_c&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> mag </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> imposter with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;&quot;mag&quot; </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;imp_mag&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s2">&quot;limit </span><span class="si">{</span><span class="n">pixmag_lims</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> with offset lim </span><span class="si">{</span><span class="n">cen_limit</span><span class="si">}</span><span class="s2"> at stage&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">imp_spoil</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;hot pix&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">imp_spoil</span>

        <span class="c1"># Check for &#39;direct catalog search&#39; spoilers</span>
        <span class="n">mag_spoil</span><span class="p">,</span> <span class="n">mag_rej</span> <span class="o">=</span> <span class="n">check_mag_spoilers</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">n_sigma</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">mag_rej</span><span class="p">:</span>
            <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">mag_spoil</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;spoiler (line)&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mag_spoil</span>

        <span class="c1"># Check for star spoilers (by light) background and edge</span>
        <span class="k">if</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;ASPQ1Lim&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bg_pix_thresh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dark</span><span class="p">,</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Spoiler&quot;</span><span class="p">][</span><span class="s2">&quot;BgPixThresh&quot;</span><span class="p">])</span>
            <span class="n">reg_frac</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Spoiler&quot;</span><span class="p">][</span><span class="s2">&quot;RegionFrac&quot;</span><span class="p">]</span>
            <span class="n">bg_spoil</span><span class="p">,</span> <span class="n">reg_spoil</span><span class="p">,</span> <span class="n">light_rej</span> <span class="o">=</span> <span class="n">check_spoil_contrib</span><span class="p">(</span>
                <span class="n">cand_guides</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">reg_frac</span><span class="p">,</span> <span class="n">bg_pix_thresh</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">light_rej</span><span class="p">:</span>
                <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
            <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">bg_spoil</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;spoiler (bgd)&quot;</span><span class="p">]</span>
            <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">reg_spoil</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;spoiler (frac)&quot;</span><span class="p">]</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bg_spoil</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">reg_spoil</span>

        <span class="c1"># Check for column spoiler</span>
        <span class="n">col_spoil</span><span class="p">,</span> <span class="n">col_rej</span> <span class="o">=</span> <span class="n">check_column_spoilers</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">n_sigma</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">col_rej</span><span class="p">:</span>
            <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">col_spoil</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;col spoiler&quot;</span><span class="p">]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">col_spoil</span>

        <span class="k">if</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;DoBminusVcheck&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">bad_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">],</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bad_color</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bad color&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">[</span><span class="s2">&quot;Stage&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1"> has bad color (0.7)&#39;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="n">cand_guides</span><span class="p">[</span><span class="n">scol</span><span class="p">][</span><span class="n">bad_color</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">errs</span><span class="p">[</span><span class="s2">&quot;bad color&quot;</span><span class="p">]</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad_color</span>
        <span class="k">return</span> <span class="n">ok</span></div>

<div class="viewcode-block" id="GuideTable.process_include_ids"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.process_include_ids">[docs]</a>    <span class="k">def</span> <span class="nf">process_include_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cand_guides</span><span class="p">,</span> <span class="n">stars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ensure that the cand_guides table has stars that were forced to be included.</span>

<span class="sd">        :param cand_guides: candidate guide stars table</span>
<span class="sd">        :param stars: stars table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">row_max</span> <span class="o">=</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_pad&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;window_pad&quot;</span><span class="p">]</span>
        <span class="n">col_max</span> <span class="o">=</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_pad&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;window_pad&quot;</span><span class="p">]</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">row_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">col_max</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_include_ids</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">])</span></div>

<div class="viewcode-block" id="GuideTable.get_candidates_mask"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.get_candidates_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_candidates_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get base filter for acceptable candidates.</span>

<span class="sd">        This does not include spatial filtering.</span>

<span class="sd">        :param stars: StarsTable</span>
<span class="sd">        :returns: bool mask of acceptable stars</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If dyn_bgd is active then apply the T_ccd bonus to the effective</span>
        <span class="c1"># CCD temperature. This will bring in fainter stars to the candidates.</span>
        <span class="n">t_ccd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_bgd_n_faint</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t_ccd</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_bgd_dt_ccd</span>

        <span class="c1"># Scale the reference ACA faint mag limit to the CCD temperature keeping</span>
        <span class="c1"># expected signal-to-noise constant.</span>
        <span class="n">faint_mag_limit</span> <span class="o">=</span> <span class="n">snr_mag_for_t_ccd</span><span class="p">(</span>
            <span class="n">t_ccd</span><span class="p">,</span> <span class="n">ref_mag</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">ref_faint_mag</span><span class="p">,</span> <span class="n">ref_t_ccd</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">ref_faint_mag_t_ccd</span>
        <span class="p">)</span>

        <span class="c1"># Without dynamic background, ensure faint limit is no larger (fainter)</span>
        <span class="c1"># than ref_faint_mag (10.3 mag).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dyn_bgd_n_faint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">faint_mag_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">faint_mag_limit</span><span class="p">,</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">ref_faint_mag</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;CLASS&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">5.2</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">faint_mag_limit</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag_err&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;ASPQ1&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># Mag err &lt; 1.0 mag</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;ASPQ2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Less than 1 arcsec offset from nearby spoiler</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;POS_ERR&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1250</span><span class="p">)</span>  <span class="c1"># Proper motion less than 0.5 arcsec/yr</span>
            <span class="o">&amp;</span> <span class="p">(</span>  <span class="c1"># Position error &lt; 1.25 arcsec</span>
                <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;VAR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;VAR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># Not known to vary &gt; 0.2 mag</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span></div>

<div class="viewcode-block" id="GuideTable.get_initial_guide_candidates"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.get_initial_guide_candidates">[docs]</a>    <span class="k">def</span> <span class="nf">get_initial_guide_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a candidate list from the available stars in the field.</span>

<span class="sd">        As the initial list of candidates is created this:</span>

<span class="sd">        1. Runs get_candidate_mask to limit the &quot;ok&quot; mask to the list of candidates to only those</span>
<span class="sd">        that at least mee the minimum filter (based fields of the AGASC).</span>

<span class="sd">        2. Sets the &quot;ok&quot; mask to limit to stars that are on the CCD (with minimum edge padding</span>
<span class="sd">        but no dither padding)</span>

<span class="sd">        3. Adds a column (&#39;offchip&#39;) to the table of all stars to mark those that aren&#39;t on the</span>
<span class="sd">        CCD at all (offchip = True).</span>

<span class="sd">        4. Makes one more position filter of the possible candidate stars that limits to those</span>
<span class="sd">        stars that are on the CCD with edge minimum padding, readout window padding, and padding</span>
<span class="sd">        for dither.</span>

<span class="sd">        5. Filters the supplied star table (self.stars) using the filters in 1), 2) and 4), to</span>
<span class="sd">        produce a candidate list.</span>

<span class="sd">        6. Filters the candidate list to remove any that are spoiled by bad pixel.</span>

<span class="sd">        7. Filters the candidate list to remove any that are in the bad stars list.</span>

<span class="sd">        8. Filters the candidates to remove any that have a spoiler in a NxN box centered</span>
<span class="sd">        on the star brighter than M magnitudes fainter than the candidate (N is 5 and M is -4</span>
<span class="sd">        from the box_spoiler section of guide characteristics).  This check uses the</span>
<span class="sd">        `has_spoiler_in_box` method and is the first of many spoiler checks.  This spoiler</span>
<span class="sd">        check is not stage dependent.</span>

<span class="sd">        9. Filters the candidates to remova any that are spoiled by the fid trap (using</span>
<span class="sd">        `check_fid_trap` method).</span>

<span class="sd">        10. Puts any force include candidates from the include_ids parameter back in the candidate</span>
<span class="sd">        list if they were filtered out by an earlier filter in this routine.</span>

<span class="sd">        11. Filters/removes any candidates that are force excluded (in exclude_ids).</span>

<span class="sd">        12. Uses the local dark current around each candidate to calculate an &quot;imposter mag&quot;</span>
<span class="sd">        describing the brightest 2x2 in the region the star would dither over.  This is</span>
<span class="sd">        saved to the candidate star table.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span>
        <span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span>

        <span class="c1"># Mark stars that are off chip</span>
        <span class="n">offchip</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_max&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_max&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offchip</span>

        <span class="c1"># Add a filter for stars that are too close to the chip edge including dither</span>
        <span class="n">r_dith_pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">row</span>
        <span class="n">c_dith_pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="o">.</span><span class="n">col</span>
        <span class="n">row_max</span> <span class="o">=</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;window_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;guide_extra_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r_dith_pad</span>
        <span class="p">)</span>
        <span class="n">col_max</span> <span class="o">=</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
            <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;window_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;guide_extra_pad&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">c_dith_pad</span>
        <span class="p">)</span>
        <span class="n">outofbounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">row_max</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">col_max</span>
        <span class="p">)</span>

        <span class="c1"># Set the candidates to be the set of stars that is both *not* out of bounds</span>
        <span class="c1"># and satisfies the rules in &#39;get_candidates_mask&#39; (which uses the primary</span>
        <span class="c1"># selection filter from acq, but allows bad color and limits to brighter stars).</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_candidates_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">outofbounds</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Filtering on CLASS, mag, row/col, &quot;</span> <span class="s2">&quot;mag_err, ASPQ1/2, POS_ERR:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reduced star list from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidate guide stars&quot;</span>
        <span class="p">)</span>

        <span class="n">bp</span><span class="p">,</span> <span class="n">bp_rej</span> <span class="o">=</span> <span class="n">spoiled_by_bad_pixel</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">bp_rej</span><span class="p">:</span>
            <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="o">~</span><span class="n">bp</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Filtering on candidates near bad (not just bright/hot) pixels&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reduced star list from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bp</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidate guide stars&quot;</span>
        <span class="p">)</span>

        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_bad_star_list</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span>
                    <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bad star list&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1"> in bad star list&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="o">~</span><span class="n">bs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Filtering stars on bad star list&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reduced star list from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidate guide stars&quot;</span>
        <span class="p">)</span>

        <span class="n">box_spoiled</span><span class="p">,</span> <span class="n">box_rej</span> <span class="o">=</span> <span class="n">has_spoiler_in_box</span><span class="p">(</span>
            <span class="n">cand_guides</span><span class="p">,</span>
            <span class="n">stars</span><span class="p">,</span>
            <span class="n">halfbox</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">box_spoiler</span><span class="p">[</span><span class="s2">&quot;halfbox&quot;</span><span class="p">],</span>
            <span class="n">magdiff</span><span class="o">=</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">box_spoiler</span><span class="p">[</span><span class="s2">&quot;magdiff&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">box_rej</span><span class="p">:</span>
            <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="o">~</span><span class="n">box_spoiled</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Filtering stars that have bright spoilers with centroids near/in 8x8&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reduced star list from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">box_spoiled</span><span class="p">)</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidate guide stars&quot;</span>
        <span class="p">)</span>

        <span class="n">fid_trap_spoilers</span><span class="p">,</span> <span class="n">fid_rej</span> <span class="o">=</span> <span class="n">check_fid_trap</span><span class="p">(</span>
            <span class="n">cand_guides</span><span class="p">,</span> <span class="n">fids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">,</span> <span class="n">dither</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dither</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">rej</span> <span class="ow">in</span> <span class="n">fid_rej</span><span class="p">:</span>
            <span class="n">rej</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span><span class="n">rej</span><span class="p">)</span>
        <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="o">~</span><span class="n">fid_trap_spoilers</span><span class="p">]</span>

        <span class="c1"># Deal with include_ids by putting them back in candidate table if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_include_ids</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">stars</span><span class="p">)</span>

        <span class="c1"># Deal with exclude_ids by cutting from the candidate list</span>
        <span class="k">for</span> <span class="n">star_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">star_id</span> <span class="ow">in</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reject</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;exclude_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">star_id</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Cand </span><span class="si">{</span><span class="n">star_id</span><span class="si">}</span><span class="s2"> rejected.  In exclude_ids&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">cand_guides</span> <span class="o">=</span> <span class="n">cand_guides</span><span class="p">[</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">star_id</span><span class="p">]</span>

        <span class="c1"># Get the brightest 2x2 in the dark map for each candidate and save value and location</span>
        <span class="n">imp_mag</span><span class="p">,</span> <span class="n">imp_row</span><span class="p">,</span> <span class="n">imp_col</span> <span class="o">=</span> <span class="n">get_imposter_mags</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dither</span><span class="p">)</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;imp_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp_mag</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;imp_r&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp_row</span>
        <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;imp_c&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imp_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Getting pseudo-mag of brightest pixel 2x2 in candidate region&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cand_guides</span></div>

<div class="viewcode-block" id="GuideTable.in_bad_star_list"><a class="viewcode-back" href="../../api.html#proseco.guide.GuideTable.in_bad_star_list">[docs]</a>    <span class="k">def</span> <span class="nf">in_bad_star_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cand_guides</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mark star bad if candidate AGASC ID in bad star list.</span>

<span class="sd">        :param cand_guides: Table of candidate stars</span>
<span class="sd">        :returns: boolean mask where True means star is in bad star list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">ACA</span><span class="o">.</span><span class="n">bad_star_set</span><span class="p">))</span>

        <span class="c1"># Set any matching bad stars as bad for plotting</span>
        <span class="k">for</span> <span class="n">bad_id</span> <span class="ow">in</span> <span class="n">cand_guides</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">bad</span><span class="p">]:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span><span class="o">.</span><span class="n">get_id_idx</span><span class="p">(</span><span class="n">bad_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad_stars_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">bad</span></div></div>


<div class="viewcode-block" id="check_fid_trap"><a class="viewcode-back" href="../../api.html#proseco.guide.check_fid_trap">[docs]</a><span class="k">def</span> <span class="nf">check_fid_trap</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">,</span> <span class="n">fids</span><span class="p">,</span> <span class="n">dither</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for guide stars that would cause the fid trap issue and mark as spoilers.</span>

<span class="sd">    :param cand_stars: candidate star Table</span>
<span class="sd">    :param fids: fid Table</span>
<span class="sd">    :param dither: dither ACABox</span>
<span class="sd">    :returns: mask on cand_stars of fid trap spoiled stars, list of rejection info dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spoilers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">fids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spoilers</span><span class="p">,</span> <span class="p">[]</span>

    <span class="n">bad_row</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">fid_trap</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span>
    <span class="n">bad_col</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">fid_trap</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span>
    <span class="n">fid_margin</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">fid_trap</span><span class="p">[</span><span class="s2">&quot;margin&quot;</span><span class="p">]</span>

    <span class="c1"># Check to see if the fid is in the zone that&#39;s a problem for the trap and if there&#39;s</span>
    <span class="c1"># a star that can cause the effect in the readout regiser</span>
    <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">fids</span><span class="p">:</span>
        <span class="n">incol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fid</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bad_col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fid_margin</span>
        <span class="n">inrow</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fid</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bad_row</span>
        <span class="k">if</span> <span class="n">incol</span> <span class="ow">and</span> <span class="n">inrow</span><span class="p">:</span>
            <span class="n">fid_dist_to_trap</span> <span class="o">=</span> <span class="n">fid</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bad_row</span>
            <span class="n">star_dist_to_register</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span>
            <span class="n">spoils</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fid_dist_to_trap</span> <span class="o">-</span> <span class="n">star_dist_to_register</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span>
                <span class="n">fid_margin</span> <span class="o">+</span> <span class="n">dither</span><span class="o">.</span><span class="n">row</span>
            <span class="p">)</span>
            <span class="n">spoilers</span> <span class="o">=</span> <span class="n">spoilers</span> <span class="o">|</span> <span class="n">spoils</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">spoils</span><span class="p">):</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="n">cand_stars</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fid trap effect&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;fid_id&quot;</span><span class="p">:</span> <span class="n">fid</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;fid_dist_to_trap&quot;</span><span class="p">:</span> <span class="n">fid_dist_to_trap</span><span class="p">,</span>
                        <span class="s2">&quot;star_dist_to_register&quot;</span><span class="p">:</span> <span class="n">star_dist_to_register</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> in trap zone for fid </span><span class="si">{</span><span class="n">fid</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">spoilers</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="check_spoil_contrib"><a class="viewcode-back" href="../../api.html#proseco.guide.check_spoil_contrib">[docs]</a><span class="k">def</span> <span class="nf">check_spoil_contrib</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">regfrac</span><span class="p">,</span> <span class="n">bgthresh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that there are no spoiler stars contributing more than a fraction</span>
<span class="sd">    of the candidate star to the candidate star&#39;s 8x8 pixel region or more than bgthresh</span>
<span class="sd">    to any of the background pixels.</span>

<span class="sd">    :param cand_stars: candidate star Table</span>
<span class="sd">    :param ok: mask on cand_stars of candidates that are still &#39;ok&#39;</span>
<span class="sd">    :param stars: Table of agasc stars for this field</span>
<span class="sd">    :param regfrac: fraction of candidate star mag that may fall on the 8x8 due to spoilers</span>
<span class="sd">                    A sum above this fraction will mark the cand_star as spoiled</span>
<span class="sd">    :param bgthresh: background pixel threshold (in e-/sec).  If spoilers contribute more</span>
<span class="sd">                    than this value to any background pixel, mark the cand_star as spoiled.</span>
<span class="sd">    :returns: reg_spoiled, bg_spoiled, rej - two masks on cand_stars and a list of reject</span>
<span class="sd">              debug dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fraction</span> <span class="o">=</span> <span class="n">regfrac</span>
    <span class="n">bg_spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
    <span class="n">reg_spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
    <span class="n">bgpix</span> <span class="o">=</span> <span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;bgpix&quot;</span><span class="p">]</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">cand_stars</span><span class="p">[</span><span class="n">ok</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;ASPQ1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">spoilers</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">9</span>
        <span class="p">)</span>

        <span class="c1"># If there is only one match, it is the candidate so there&#39;s nothing to do</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">spoilers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">cand_counts</span> <span class="o">=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span>

        <span class="c1"># Get a reasonable AcaImage for the location of the 8x8 for the candidate</span>
        <span class="n">cand_img_region</span> <span class="o">=</span> <span class="n">ACAImage</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)),</span>
            <span class="n">row0</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">col0</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">on_region</span> <span class="o">=</span> <span class="n">cand_img_region</span>
        <span class="k">for</span> <span class="n">spoil</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">[</span><span class="n">spoilers</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">spoil_img</span> <span class="o">=</span> <span class="n">APL</span><span class="o">.</span><span class="n">get_psf_image</span><span class="p">(</span>
                <span class="n">row</span><span class="o">=</span><span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span>
                <span class="n">col</span><span class="o">=</span><span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span>
                <span class="n">pix_zero_loc</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">on_region</span> <span class="o">=</span> <span class="n">on_region</span> <span class="o">+</span> <span class="n">spoil_img</span><span class="o">.</span><span class="n">aca</span>

        <span class="c1"># Consider it spoiled if the star contribution on the 8x8 is over a fraction</span>
        <span class="n">frac_limit</span> <span class="o">=</span> <span class="n">cand_counts</span> <span class="o">*</span> <span class="n">fraction</span>
        <span class="n">sum_in_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">on_region</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sum_in_region</span> <span class="o">&gt;</span> <span class="n">frac_limit</span><span class="p">:</span>
            <span class="n">reg_spoiled</span><span class="p">[</span><span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;region sum spoiled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;limit_for_star&quot;</span><span class="p">:</span> <span class="n">frac_limit</span><span class="p">,</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="n">fraction</span><span class="p">,</span>
                    <span class="s2">&quot;sum_in_region&quot;</span><span class="p">:</span> <span class="n">sum_in_region</span><span class="p">,</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> has too much contribution &#39;</span>
                        <span class="s2">&quot;to region from spoilers&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Or consider it spoiled if the star contribution to any background pixel</span>
        <span class="c1"># is more than the Nth percentile of the dark current</span>
        <span class="k">for</span> <span class="n">pixlabel</span> <span class="ow">in</span> <span class="n">bgpix</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">on_region</span><span class="p">[</span><span class="n">pixlabel</span> <span class="o">==</span> <span class="n">chandra_aca</span><span class="o">.</span><span class="n">aca_image</span><span class="o">.</span><span class="n">EIGHT_LABELS</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">bgthresh</span><span class="p">:</span>
                <span class="n">bg_spoiled</span><span class="p">[</span><span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;region background spoiled&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;bg_thresh&quot;</span><span class="p">:</span> <span class="n">bgthresh</span><span class="p">,</span>
                        <span class="s2">&quot;bg_pix_val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span>
                        <span class="s2">&quot;pix_id&quot;</span><span class="p">:</span> <span class="n">pixlabel</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> has bg pix spoiled by spoilers&#39;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">bg_spoiled</span><span class="p">,</span> <span class="n">reg_spoiled</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="check_mag_spoilers"><a class="viewcode-back" href="../../api.html#proseco.guide.check_mag_spoilers">[docs]</a><span class="k">def</span> <span class="nf">check_mag_spoilers</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">n_sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the slope-intercept mag-spoiler relationship to exclude all</span>
<span class="sd">    stars that have a &quot;mag spoiler&quot;.  This is basically equivalent to the</span>
<span class="sd">    &quot;direct catalog search&quot; for spoilers in SAUSAGE, but does not forbid</span>
<span class="sd">    all stars within 7 pixels (spoilers must be faint to be close).</span>

<span class="sd">    The n-sigma changes by stage for the mags/magerrs used in the check.</span>

<span class="sd">    :param cand_stars: Table of candidate stars</span>
<span class="sd">    :param ok: mask on cand_stars describing those that are still &quot;ok&quot;</span>
<span class="sd">    :param stars: Table of AGASC stars in this field</span>
<span class="sd">    :param n_sigma: multiplier use for MAG_ACA_ERR when reviewing spoilers</span>
<span class="sd">    :returns: bool mask of length cand_stars marking mag_spoiled stars, list of reject debug dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">mag_spoiler</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
    <span class="n">spoilslope</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">mag_spoiler</span><span class="p">[</span><span class="s2">&quot;Slope&quot;</span><span class="p">]</span>
    <span class="n">magdifflim</span> <span class="o">=</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">mag_spoiler</span><span class="p">[</span><span class="s2">&quot;MagDiffLimit&quot;</span><span class="p">]</span>

    <span class="c1"># If there are already no candidates, there isn&#39;t anything to do</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ok</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span> <span class="p">[]</span>

    <span class="n">mag_spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ok</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cand_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cand_idx</span> <span class="ow">in</span> <span class="n">cand_idxs</span><span class="p">:</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="n">cand_stars</span><span class="p">[</span><span class="n">cand_idx</span><span class="p">]</span>
        <span class="n">spoil_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If there is only one match, it is the candidate so there&#39;s nothing to do</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spoil_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">spoil_idx</span> <span class="ow">in</span> <span class="n">spoil_idxs</span><span class="p">:</span>
            <span class="n">spoil</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">spoil_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">magdifflim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mag_err_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">delmag</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">n_sigma</span> <span class="o">*</span> <span class="n">mag_err_sum</span>
            <span class="n">thsep</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">delmag</span> <span class="o">*</span> <span class="n">spoilslope</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">((</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">((</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">thsep</span><span class="p">:</span>
                <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;spoiler&quot;</span><span class="p">:</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;spoiler_mag&quot;</span><span class="p">:</span> <span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">],</span>
                        <span class="s2">&quot;dmag_with_err&quot;</span><span class="p">:</span> <span class="n">delmag</span><span class="p">,</span>
                        <span class="s2">&quot;min_dist_for_dmag&quot;</span><span class="p">:</span> <span class="n">thsep</span><span class="p">,</span>
                        <span class="s2">&quot;actual_dist&quot;</span><span class="p">:</span> <span class="n">dist</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;spoiler by distance-mag line&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> spoiled by </span><span class="si">{</span><span class="n">spoil</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">, &#39;</span>
                            <span class="sa">f</span><span class="s2">&quot;too close (</span><span class="si">{</span><span class="n">dist</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">) pix for magdiff (</span><span class="si">{</span><span class="n">delmag</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">mag_spoiled</span><span class="p">[</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>

    <span class="k">return</span> <span class="n">mag_spoiled</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="check_column_spoilers"><a class="viewcode-back" href="../../api.html#proseco.guide.check_column_spoilers">[docs]</a><span class="k">def</span> <span class="nf">check_column_spoilers</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">n_sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For each candidate, check for stars &#39;MagDiff&#39; brighter and within &#39;Separation&#39; columns</span>
<span class="sd">    between the star and the readout register, i.e. Column Spoilers.</span>

<span class="sd">    :param cand_stars: Table of candidate stars</span>
<span class="sd">    :param ok: mask on cand_stars describing still &quot;ok&quot; candidates</span>
<span class="sd">    :param stars: Table of AGASC stars</span>
<span class="sd">    :param n_sigma: multiplier used when checking mag with MAG_ACA_ERR</span>
<span class="sd">    :returns: bool mask on cand_stars marking column spoiled stars, list of debug reject dicts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">column_spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="c1"># Get possible column spoiling stars by position that are that are</span>
        <span class="c1"># on the same side of the CCD as the candidate</span>
        <span class="c1"># AND between the candidate star and readout register</span>
        <span class="c1"># AND in the column &quot;band&quot; for the candidate</span>
        <span class="n">pos_spoil</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]]))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]]))</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]])</span>
                <span class="o">&lt;=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">col_spoiler_pix_sep</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">pos_spoil</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">mag_errs</span> <span class="o">=</span> <span class="n">n_sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]][</span><span class="n">pos_spoil</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">][</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]][</span><span class="n">pos_spoil</span><span class="p">]</span> <span class="o">+</span> <span class="n">mag_errs</span>
        <span class="n">spoils</span> <span class="o">=</span> <span class="n">dm</span> <span class="o">&gt;</span> <span class="n">ACA</span><span class="o">.</span><span class="n">col_spoiler_mag_diff</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spoils</span><span class="p">):</span>
            <span class="n">column_spoiled</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">spoiler</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="o">~</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;offchip&quot;</span><span class="p">]][</span><span class="n">pos_spoil</span><span class="p">][</span><span class="n">spoils</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;column spoiled&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;spoiler&quot;</span><span class="p">:</span> <span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;spoiler_mag&quot;</span><span class="p">:</span> <span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;dmag_with_err&quot;</span><span class="p">:</span> <span class="n">dm</span><span class="p">[</span><span class="n">spoils</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s2">&quot;dmag_lim&quot;</span><span class="p">:</span> <span class="n">ACA</span><span class="o">.</span><span class="n">col_spoiler_mag_diff</span><span class="p">,</span>
                    <span class="s2">&quot;dcol&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> has column spoiler </span><span class="si">{</span><span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;at (</span><span class="si">{</span><span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">), &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;mag </span><span class="si">{</span><span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">column_spoiled</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="get_ax_range"><a class="viewcode-back" href="../../api.html#proseco.guide.get_ax_range">[docs]</a><span class="k">def</span> <span class="nf">get_ax_range</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a float pixel row or col value and an &quot;extent&quot; in float pixels,</span>
<span class="sd">    generally 4 + 1.6 for 8&quot; dither and 4 + 5.0 for 20&quot; dither,</span>
<span class="sd">    return a range for the row or col that is divisible by 2 and contains</span>
<span class="sd">    at least the requested extent.</span>

<span class="sd">    :param rc: row or col float value (edge pixel coords)</span>
<span class="sd">    :param extent: half of desired range from n (should include pixel dither)</span>
<span class="sd">    :returns: tuple of range as (minus, plus)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rc</span> <span class="o">-</span> <span class="n">extent</span><span class="p">))</span>
    <span class="n">plus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">rc</span> <span class="o">+</span> <span class="n">extent</span><span class="p">))</span>
    <span class="c1"># If there isn&#39;t an even range of pixels, add or subtract one from the range</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plus</span> <span class="o">-</span> <span class="n">minus</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># If the &quot;rc&quot; value in on the &#39;right&#39; side of a pixel, add one to the plus</span>
        <span class="k">if</span> <span class="n">rc</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">plus</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Otherwise subtract one from the minus</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minus</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">minus</span><span class="p">,</span> <span class="n">plus</span></div>


<div class="viewcode-block" id="get_imposter_mags"><a class="viewcode-back" href="../../api.html#proseco.guide.get_imposter_mags">[docs]</a><span class="k">def</span> <span class="nf">get_imposter_mags</span><span class="p">(</span><span class="n">cand_stars</span><span class="p">,</span> <span class="n">dark</span><span class="p">,</span> <span class="n">dither</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get &quot;pseudo-mag&quot; of max pixel value in each candidate star region</span>

<span class="sd">    :param cand_stars: Table of candidate stars</span>
<span class="sd">    :param dark: full CCD dark map</span>
<span class="sd">    :param dither: observation dither to be used to determine pixels a star could use</span>
<span class="sd">    :returns: np.array pixmags, np.array pix_r, np.array pix_c all of length cand_stars</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pixmags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pix_r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pix_c</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Define the 1/2 pixel region as half the 8x8 plus a pad plus dither</span>
    <span class="n">row_extent</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">dither_pix_pad</span> <span class="o">+</span> <span class="n">dither</span><span class="o">.</span><span class="n">row</span>
    <span class="n">col_extent</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">GUIDE</span><span class="o">.</span><span class="n">dither_pix_pad</span> <span class="o">+</span> <span class="n">dither</span><span class="o">.</span><span class="n">col</span>
    <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">cand_stars</span><span class="p">:</span>
        <span class="n">rminus</span><span class="p">,</span> <span class="n">rplus</span> <span class="o">=</span> <span class="n">get_ax_range</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">row_extent</span><span class="p">)</span>
        <span class="n">cminus</span><span class="p">,</span> <span class="n">cplus</span> <span class="o">=</span> <span class="n">get_ax_range</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span> <span class="n">col_extent</span><span class="p">)</span>
        <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dark</span><span class="p">[</span><span class="n">rminus</span> <span class="o">+</span> <span class="mi">512</span> <span class="p">:</span> <span class="n">rplus</span> <span class="o">+</span> <span class="mi">512</span><span class="p">,</span> <span class="n">cminus</span> <span class="o">+</span> <span class="mi">512</span> <span class="p">:</span> <span class="n">cplus</span> <span class="o">+</span> <span class="mi">512</span><span class="p">])</span>
        <span class="n">pixmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_r</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">max_c</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check the 2x2 bins for the max 2x2 region.  Search the &quot;offset&quot; versions as well</span>
        <span class="k">for</span> <span class="n">pix_chunk</span><span class="p">,</span> <span class="n">row_off</span><span class="p">,</span> <span class="n">col_off</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pix</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">bin_image</span> <span class="o">=</span> <span class="n">bin2x2</span><span class="p">(</span><span class="n">pix_chunk</span><span class="p">)</span>
            <span class="n">pixsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bin_image</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pixsum</span> <span class="o">&gt;</span> <span class="n">pixmax</span><span class="p">:</span>
                <span class="n">pixmax</span> <span class="o">=</span> <span class="n">pixsum</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">bin_image</span><span class="p">),</span> <span class="n">bin_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">max_r</span> <span class="o">=</span> <span class="n">rminus</span> <span class="o">+</span> <span class="n">row_off</span> <span class="o">+</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">max_c</span> <span class="o">=</span> <span class="n">cminus</span> <span class="o">+</span> <span class="n">col_off</span> <span class="o">+</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="c1"># Get the mag equivalent to pixmax.  If pixmax is zero (for a synthetic dark map)</span>
        <span class="c1"># clip lower bound at 1.0 to avoid &#39;inf&#39; mag and warnings from chandra_aca.transform</span>
        <span class="n">pixmax_mag</span> <span class="o">=</span> <span class="n">count_rate_to_mag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">pixmax</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">pixmags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pixmax_mag</span><span class="p">)</span>
        <span class="n">pix_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_r</span><span class="p">)</span>
        <span class="n">pix_c</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixmags</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pix_r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pix_c</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pixmag_for_offset"><a class="viewcode-back" href="../../api.html#proseco.guide.get_pixmag_for_offset">[docs]</a><span class="k">def</span> <span class="nf">get_pixmag_for_offset</span><span class="p">(</span><span class="n">cand_mag</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the magnitude an individual bad pixel would need to spoil the centroid of</span>
<span class="sd">    the candidate star by ``offset``.  This just constructs the worst case as the bad pixel</span>
<span class="sd">    3 pixels away (edge of box).  The offset in this case would be</span>
<span class="sd">    offset = spoil_cnts * 3 * 5 / (spoil_cnts + cand_counts), where 3 is the distance to</span>
<span class="sd">    the edge pixel in pixels and 5 is the conversion to arcsec.</span>
<span class="sd">    Solving for spoil_cnts gives:</span>
<span class="sd">    spoil_cnts = mag_to_count_rate(cand_mag) * (offset / (15 - offset))</span>

<span class="sd">    :param cand_mag: candidate star magnitude</span>
<span class="sd">    :param offset: centroid offset in arcsec</span>
<span class="sd">    :returns: &#39;magnitude&#39; of bad pixel needed to for offset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spoil_cnts</span> <span class="o">=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">cand_mag</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">offset</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">count_rate_to_mag</span><span class="p">(</span><span class="n">spoil_cnts</span><span class="p">)</span></div>


<div class="viewcode-block" id="has_spoiler_in_box"><a class="viewcode-back" href="../../api.html#proseco.guide.has_spoiler_in_box">[docs]</a><span class="k">def</span> <span class="nf">has_spoiler_in_box</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">halfbox</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">magdiff</span><span class="o">=-</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check each candidate star for spoilers that would fall in a box centered on the star.</span>
<span class="sd">    Mark candidate spoiled if there&#39;s a spoiler in the box and brighter than magdiff fainter</span>
<span class="sd">    than the candidate&#39;s mag.</span>

<span class="sd">    :param cand_guides: Table of candidate stars</span>
<span class="sd">    :param stars: Table of AGASC stars in the field</span>
<span class="sd">    :param halfbox: half of the length of a side of the box used for check (pixels)</span>
<span class="sd">    :param magdiff: magnitude difference threshold</span>
<span class="sd">    :returns: mask on cand_guides set to True if star spoiled by another star in the pixel box,</span>
<span class="sd">              and a list of dicts with reject debug info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">box_spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">):</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span>
        <span class="n">inbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">dr</span> <span class="o">&lt;=</span> <span class="n">halfbox</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dc</span> <span class="o">&lt;=</span> <span class="n">halfbox</span><span class="p">)</span>
        <span class="n">itself</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">box_spoilers</span> <span class="o">=</span> <span class="o">~</span><span class="n">itself</span> <span class="o">&amp;</span> <span class="n">inbox</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">magdiff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">box_spoilers</span><span class="p">):</span>
            <span class="n">box_spoiled</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">box_spoilers</span><span class="p">)</span>
            <span class="n">boxsize</span> <span class="o">=</span> <span class="n">halfbox</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">bright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="n">box_spoilers</span><span class="p">][</span><span class="s2">&quot;mag&quot;</span><span class="p">])</span>
            <span class="n">spoiler</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">box_spoilers</span><span class="p">][</span><span class="n">bright</span><span class="p">]</span>
            <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;in-box spoiler star&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;boxsize&quot;</span><span class="p">:</span> <span class="n">boxsize</span><span class="p">,</span>
                    <span class="s2">&quot;magdiff_thresh&quot;</span><span class="p">:</span> <span class="n">magdiff</span><span class="p">,</span>
                    <span class="s2">&quot;spoiler&quot;</span><span class="p">:</span> <span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;dmag&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> spoiled by </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> stars in </span><span class="si">{</span><span class="n">boxsize</span><span class="si">}</span><span class="s1">x</span><span class="si">{</span><span class="n">boxsize</span><span class="si">}</span><span class="s1"> &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39; including </span><span class="si">{</span><span class="n">spoiler</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">box_spoiled</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="spoiled_by_bad_pixel"><a class="viewcode-back" href="../../api.html#proseco.guide.spoiled_by_bad_pixel">[docs]</a><span class="k">def</span> <span class="nf">spoiled_by_bad_pixel</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">,</span> <span class="n">dither</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mark star bad if spoiled by a bad pixel in the bad pixel list (not hot)</span>

<span class="sd">    :param cand_guides: Table of candidate stars</span>
<span class="sd">    :param dither: dither ACABox</span>
<span class="sd">    :returns: boolean mask on cand_guides where True means star is spoiled by bad pixel,</span>
<span class="sd">              list of dicts of reject debug info</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">raw_bp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ACA</span><span class="o">.</span><span class="n">bad_pixels</span><span class="p">)</span>
    <span class="n">bp_row</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bp_col</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Bad pixel entries are [row_min, row_max, col_min, col_max]</span>
    <span class="c1"># Convert this to lists of the row and col coords of the bad pixels</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">raw_bp</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">bp_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
                <span class="n">bp_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
    <span class="n">bp_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bp_row</span><span class="p">)</span>
    <span class="n">bp_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bp_col</span><span class="p">)</span>

    <span class="c1"># Then for the pixel region of each candidate, see if there is a bad</span>
    <span class="c1"># pixel in the region.</span>
    <span class="n">spoiled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="c1"># Also save an array of rejects to pass back</span>
    <span class="n">rej</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row_extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">dither</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
    <span class="n">col_extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">dither</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cand</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cand_guides</span><span class="p">):</span>
        <span class="n">rminus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row_extent</span><span class="p">))</span>
        <span class="n">rplus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row_extent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cminus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">col_extent</span><span class="p">))</span>
        <span class="n">cplus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">col_extent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># If any bad pixel is in the guide star pixel region, mark as spoiled</span>
        <span class="n">bps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">bp_row</span> <span class="o">&gt;=</span> <span class="n">rminus</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">bp_row</span> <span class="o">&lt;=</span> <span class="n">rplus</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">bp_col</span> <span class="o">&gt;=</span> <span class="n">cminus</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">bp_col</span> <span class="o">&lt;=</span> <span class="n">cplus</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bps</span><span class="p">):</span>
            <span class="n">spoiled</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">rej</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bad pixel&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pixel&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">bp_row</span><span class="p">[</span><span class="n">bps</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bp_col</span><span class="p">[</span><span class="n">bps</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s2">&quot;n_bad&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">bps</span><span class="p">),</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Cand </span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> spoiled by </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">bps</span><span class="p">)</span><span class="si">}</span><span class="s1"> bad pixels &#39;</span>
                        <span class="sa">f</span><span class="s2">&quot;including </span><span class="si">{</span><span class="p">(</span><span class="n">bp_row</span><span class="p">[</span><span class="n">bps</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bp_col</span><span class="p">[</span><span class="n">bps</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">spoiled</span><span class="p">,</span> <span class="n">rej</span></div>


<div class="viewcode-block" id="dist2"><a class="viewcode-back" href="../../api.html#proseco.guide.dist2">[docs]</a><span class="k">def</span> <span class="nf">dist2</span><span class="p">(</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate squared distance between a pair of stars in a star table.</span>

<span class="sd">    This local version of the method uses a cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">STAR_PAIR_DIST_CACHE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">STAR_PAIR_DIST_CACHE</span><span class="p">[(</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">STAR_PAIR_DIST_CACHE</span><span class="p">[(</span><span class="n">g1</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="check_single_cluster"><a class="viewcode-back" href="../../api.html#proseco.guide.check_single_cluster">[docs]</a><span class="k">def</span> <span class="nf">check_single_cluster</span><span class="p">(</span><span class="n">cand_guide_set</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">n_minus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Confirm that a set of stars satisfies the minimum separation threshold when n_minus</span>
<span class="sd">    stars are removed from the set.  For example, for a threshold of 1000, n_minus of 1,</span>
<span class="sd">    and an input set of candidates stars with 5 candidates, confirm that, for any 4 of</span>
<span class="sd">    the 5 stars (5 minus n_minus = 1), one pair of those stars is separated by at</span>
<span class="sd">    least 1000 arcsecs.</span>

<span class="sd">    :returns: bool (True for check passing threshold)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">min_dist</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="n">min_dist2</span> <span class="o">=</span> <span class="n">min_dist</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">guide_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cand_guide_set</span><span class="p">))</span>
    <span class="n">n_guide</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guide_idxs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">guide_idxs</span><span class="p">,</span> <span class="n">n_guide</span> <span class="o">-</span> <span class="n">n_minus</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dist2</span><span class="p">(</span><span class="n">cand_guide_set</span><span class="p">[</span><span class="n">idx0</span><span class="p">],</span> <span class="n">cand_guide_set</span><span class="p">[</span><span class="n">idx1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">min_dist2</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="run_select_checks"><a class="viewcode-back" href="../../api.html#proseco.guide.run_select_checks">[docs]</a><span class="k">def</span> <span class="nf">run_select_checks</span><span class="p">(</span><span class="n">cand_guide_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run boolean checks on a combination of candidate guide stars.</span>
<span class="sd">    Returns a sum of the status of the checks and the number of checks run.</span>

<span class="sd">    Presently this runs three checks to confirm that the set of stars</span>
<span class="sd">    is not too tightly packed.</span>

<span class="sd">    :returns: tuple (status sum, number of tests run)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n_minus</span><span class="p">,</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">GUIDE</span><span class="o">.</span><span class="n">cluster_thresholds</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_minus</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cand_guide_set</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">check_single_cluster</span><span class="p">(</span>
                    <span class="n">cand_guide_set</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">n_minus</span><span class="o">=</span><span class="n">n_minus</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>