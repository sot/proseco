
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>proseco.core &#8212; proseco 5.11.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">proseco</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">proseco 5.11.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for proseco.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">agasc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">chandra_aca.aca_image</span> <span class="kn">import</span> <span class="n">AcaPsfLibrary</span>
<span class="kn">from</span> <span class="nn">chandra_aca.transform</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">count_rate_to_mag</span><span class="p">,</span>
    <span class="n">mag_to_count_rate</span><span class="p">,</span>
    <span class="n">pixels_to_yagzag</span><span class="p">,</span>
    <span class="n">radec_to_yagzag</span><span class="p">,</span>
    <span class="n">yagzag_to_pixels</span><span class="p">,</span>
    <span class="n">yagzag_to_radec</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mica.archive.aca_dark</span> <span class="kn">import</span> <span class="n">get_dark_cal_id</span><span class="p">,</span> <span class="n">get_dark_cal_image</span>
<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">characteristics</span> <span class="k">as</span> <span class="n">ACA</span>

<span class="c1"># For testing this is used to cache fid tables for a detector</span>
<span class="n">FIDS_CACHE</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">APL</span> <span class="o">=</span> <span class="n">AcaPsfLibrary</span><span class="p">()</span>

<span class="c1"># Cache recently retrieved images which are called with the same args/kwargs</span>
<span class="n">get_dark_cal_image</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)(</span><span class="n">get_dark_cal_image</span><span class="p">)</span>
<span class="n">get_dark_cal_id</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)(</span><span class="n">get_dark_cal_id</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="c1"># Row and column indices of ACA image background pixels</span>
<span class="n">_ROWB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<span class="n">_COLB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>


<div class="viewcode-block" id="table_to_html"><a class="viewcode-back" href="../../api.html#proseco.core.table_to_html">[docs]</a><span class="k">def</span> <span class="nf">table_to_html</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make an HTML representation of a table</span>

<span class="sd">    :param tbl: astropy Table</span>
<span class="sd">    :returns: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">_base_repr_</span><span class="p">(</span>
        <span class="n">html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_width</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">show_dtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">descr_vals</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">max_lines</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">tableclass</span><span class="o">=</span><span class="s2">&quot;table-striped&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Undo HTML sanitizing to allow raw HTML in table elements</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<span class="k">def</span> <span class="nf">_get_bgd</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to compute the mean of the two largest values in</span>
<span class="sd">    the background pixels.  This is a very conservative upper limit and</span>
<span class="sd">    imagines that there are other warm/hot pixels that allow the top-2</span>
<span class="sd">    seen here to not get rejected in the flight background algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bgds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="n">_ROWB</span><span class="p">,</span> <span class="n">_COLB</span><span class="p">])</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="p">(</span><span class="n">bgds</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">bgds</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">bgd</span>


<div class="viewcode-block" id="calc_spoiler_impact"><a class="viewcode-back" href="../../api.html#proseco.core.calc_spoiler_impact">[docs]</a><span class="k">def</span> <span class="nf">calc_spoiler_impact</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">dark_bgd</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the centroid shift and relative image brightness change</span>
<span class="sd">    for ``star`` when nearby ``stars`` are included.  The assumption</span>
<span class="sd">    is that ``star`` has ASPQ1 &gt; 0 so it is known to have some spoiler.</span>

<span class="sd">    The returned norm_frac is the ratio of the summed (mouse-bitten)</span>
<span class="sd">    counts in the original image over the spoiled image, so a value less</span>
<span class="sd">    than 1.0 is a problem since it indicates a high background.</span>

<span class="sd">    :param star: object with row, col, mag keys/cols</span>
<span class="sd">    :param stars: StarsTable</span>
<span class="sd">    :returns: d_yang, d_zang, norm_frac</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span>

    <span class="n">s_rows</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">]</span>
    <span class="n">s_cols</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span>
    <span class="n">s_mags</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span>

    <span class="c1"># Find potential spoilers with centroid within a 9-pixel halfw box</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_rows</span> <span class="o">-</span> <span class="n">row</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_cols</span> <span class="o">-</span> <span class="n">col</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">star</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span>

    <span class="c1"># Make an image of the candidate star</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">APL</span><span class="o">.</span><span class="n">get_psf_image</span><span class="p">(</span><span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">pix_zero_loc</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">+=</span> <span class="n">dark_bgd</span>

    <span class="c1"># Centroid the candidate star image, using an upper-limit to the</span>
    <span class="c1"># flight background algorithm.</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">_get_bgd</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">row0</span><span class="p">,</span> <span class="n">col0</span><span class="p">,</span> <span class="n">norm0</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">centroid_fm</span><span class="p">(</span><span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>

    <span class="c1"># Select spoilers</span>
    <span class="n">s_rows</span> <span class="o">=</span> <span class="n">s_rows</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">s_cols</span> <span class="o">=</span> <span class="n">s_cols</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">s_mags</span> <span class="o">=</span> <span class="n">s_mags</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

    <span class="c1"># If there are multiple spoilers, put them all in the same quadrant</span>
    <span class="c1"># to guard against canceling centroid offsets.</span>
    <span class="n">s_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">s_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_rows</span><span class="p">)</span>
    <span class="n">s_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">s_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s_cols</span><span class="p">)</span>

    <span class="c1"># Shine spoiler stars onto image</span>
    <span class="k">for</span> <span class="n">s_row</span><span class="p">,</span> <span class="n">s_col</span><span class="p">,</span> <span class="n">s_mag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s_rows</span><span class="p">,</span> <span class="n">s_cols</span><span class="p">,</span> <span class="n">s_mags</span><span class="p">):</span>
        <span class="n">s_norm</span> <span class="o">=</span> <span class="n">mag_to_count_rate</span><span class="p">(</span><span class="n">s_mag</span><span class="p">)</span>
        <span class="n">s_img</span> <span class="o">=</span> <span class="n">APL</span><span class="o">.</span><span class="n">get_psf_image</span><span class="p">(</span>
            <span class="n">row</span><span class="o">=</span><span class="n">s_row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">s_col</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">s_norm</span><span class="p">,</span> <span class="n">pix_zero_loc</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span>
        <span class="p">)</span>
        <span class="n">img</span> <span class="o">+=</span> <span class="n">s_img</span><span class="o">.</span><span class="n">aca</span>

    <span class="c1"># Centroid the candidate + spoilers image.  This might raise an exception</span>
    <span class="c1"># if the background is high enough to result in a negative norm.  In that</span>
    <span class="c1"># case return values that will certainly exceed any spoiler thresholds.</span>
    <span class="n">bgd</span> <span class="o">=</span> <span class="n">_get_bgd</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bgd&quot;</span><span class="p">,</span> <span class="n">bgd</span><span class="p">,</span> <span class="n">count_rate_to_mag</span><span class="p">(</span><span class="n">bgd</span> <span class="o">*</span> <span class="mi">32</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">row1</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">norm1</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">centroid_fm</span><span class="p">(</span><span class="n">bgd</span><span class="o">=</span><span class="n">bgd</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;non-positive image norm&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Some other code other, not expected</span>
            <span class="k">raise</span>

    <span class="c1"># Final results</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">row1</span> <span class="o">-</span> <span class="n">row0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="p">(</span><span class="n">col1</span> <span class="o">-</span> <span class="n">col0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span>
    <span class="n">frac_norm</span> <span class="o">=</span> <span class="n">norm1</span> <span class="o">/</span> <span class="n">norm0</span>

    <span class="k">return</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">frac_norm</span></div>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_starcheck_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">mica.starcheck</span> <span class="kn">import</span> <span class="n">get_starcheck_catalog</span>

    <span class="k">return</span> <span class="n">get_starcheck_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ACABox</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to represent a box half width amplitude.  Can be initialized with</span>
<span class="sd">        either a two-element sequence (y, z) or a scalar (which applies</span>
<span class="sd">        to both y and z.</span>

<span class="sd">        :param size: scalar or 2-element sequence (y, z), (arcsec, default=20)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">z</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># len(scalar) raises TypeError</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="c1"># Has a length but it is not 2</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;size arg must be either a scalar or a two-element sequence&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="mi">5</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">col</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">/</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if either component is larger.  This is somewhat</span>
<span class="sd">        specific to how boxes are used in intruder processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ACABox</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;ACABox y=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2"> z=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="si">}</span><span class="s2">&gt;&quot;</span>


<div class="viewcode-block" id="AliasAttribute"><a class="viewcode-back" href="../../api.html#proseco.core.AliasAttribute">[docs]</a><span class="k">class</span> <span class="nc">AliasAttribute</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Descriptor to define class attributes which can be accessed via</span>
<span class="sd">    either &lt;name&gt; or &lt;name&gt;_&lt;subclass&gt;.</span>

<span class="sd">    For instance the ``dither`` attribute is found in both AcqTable and</span>
<span class="sd">    GuideTable, but in general these can be different for the two cases.</span>

<span class="sd">    The ``get_aca_catalog()`` function handles this by accepting ``dither_acq``</span>
<span class="sd">    and ``dither_guide``.  In order to be able to generically pass the</span>
<span class="sd">    same commmon kwargs to ``get_acq_catalog`` and ``get_guide_catalog``,</span>
<span class="sd">    we define the AliasAttribute to allow set/get of either ``dither``</span>
<span class="sd">    or ``dither_acq`` (or ``dither_guide``).</span>

<span class="sd">    The &lt;subclass&gt; name is the lower case version of everything before</span>
<span class="sd">    ``Table`` in the subclass name, so GuideTable =&gt; &#39;guide&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># When called without an instance, return self to allow access</span>
            <span class="c1"># to descriptor attributes.</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">owner</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Table&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">owner</span><span class="o">.</span><span class="vm">__name__</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">owner</span><span class="o">.</span><span class="n">allowed_kwargs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;can only be used in classes named *Table&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> alias=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="si">}</span><span class="s2">&quot;</span></div>


<span class="k">class</span> <span class="nc">MetaAttribute</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_kwarg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Descriptor to define ACACatalogTable class attributes which get stored in</span>
<span class="sd">        the table meta dict and have defined defaults.  Also includes a flag to</span>
<span class="sd">        specify whether the attribute will be included when pickling.  Some</span>
<span class="sd">        attributes (like dark current map) are too big and not necessary.</span>

<span class="sd">        :param default: default value</span>
<span class="sd">        :param is_kwarg: include in list of allow kwargs to class init</span>
<span class="sd">        :param pickle: store correspoding meta attribute in pickle</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_kwarg</span> <span class="o">=</span> <span class="n">is_kwarg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span> <span class="o">=</span> <span class="n">pickle</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># When called without an instance, return self to allow access</span>
            <span class="c1"># to descriptor attributes.</span>
            <span class="c1"># AttributeError: &#39;NoneType&#39; object has no attribute &#39;meta&#39;</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__set_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_kwarg</span><span class="p">:</span>
            <span class="n">owner</span><span class="o">.</span><span class="n">allowed_kwargs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> default=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pickle=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">MonitorsMetaAttribute</span><span class="p">(</span><span class="n">MetaAttribute</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;coord0&quot;</span><span class="p">,</span> <span class="s2">&quot;coord1&quot;</span><span class="p">,</span> <span class="s2">&quot;coord_type&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">colnames</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;monitors input table must have </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span><span class="si">}</span><span class="s1"> columns&#39;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;monitors input must have shape (N, 5)&quot;</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;coord0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;coord1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;coord_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">out</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;coord_type&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;coord_type&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;monitors coord type must be 0, 1, or 2&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;monitors function must be 0, 1, 2, or 3&quot;</span><span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">QuatMetaAttribute</span><span class="p">(</span><span class="n">MetaAttribute</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Quat</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">IntMetaAttribute</span><span class="p">(</span><span class="n">MetaAttribute</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IntListMetaAttribute</span><span class="p">(</span><span class="n">MetaAttribute</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<div class="viewcode-block" id="BaseCatalogTable"><a class="viewcode-back" href="../../api.html#proseco.core.BaseCatalogTable">[docs]</a><span class="k">class</span> <span class="nc">BaseCatalogTable</span><span class="p">(</span><span class="n">Table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for representing star catalogs or ACA (guide/acq/fid) catalogs.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Inherits from astropy Table</span>
<span class="sd">    - Predefined formatting for nicer representations</span>
<span class="sd">    - Indexing on &#39;id&#39; column</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Catalog type when plotting (None | &#39;FID&#39; | &#39;ACQ&#39; | &#39;GUI&#39;)</span>
    <span class="n">catalog_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Make printed table look nicer.  This is defined in advance</span>
        <span class="c1"># and will be applied the first time the table is represented.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_formats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s2">&quot;p_acq&quot;</span><span class="p">,):</span> <span class="s2">&quot;5.3f&quot;</span><span class="p">,</span>  <span class="c1"># 0.912</span>
            <span class="p">(</span><span class="s2">&quot;yang&quot;</span><span class="p">,</span> <span class="s2">&quot;zang&quot;</span><span class="p">):</span> <span class="s2">&quot;8.2f&quot;</span><span class="p">,</span>  <span class="c1"># -2500.12</span>
            <span class="p">(</span><span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;maxmag&quot;</span><span class="p">,</span> <span class="s2">&quot;mag_err&quot;</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">,</span> <span class="s2">&quot;COLOR1&quot;</span><span class="p">):</span> <span class="s2">&quot;5.2f&quot;</span><span class="p">,</span>  <span class="c1"># -1.12</span>
            <span class="p">(</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">):</span> <span class="s2">&quot;7.2f&quot;</span><span class="p">,</span>  <span class="c1"># -500.12</span>
            <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">):</span> <span class="s2">&quot;11.6f&quot;</span><span class="p">,</span>  <span class="c1"># -160.123561</span>
            <span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">):</span> <span class="s2">&quot;10.5f&quot;</span><span class="p">,</span>  <span class="c1"># -89.12345</span>
            <span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">):</span> <span class="s2">&quot;2d&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="s2">&quot;halfw&quot;</span><span class="p">,):</span> <span class="s2">&quot;3d&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">names</span><span class="p">,</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_default_formats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the pickle state from self.</span>

<span class="sd">        The main functionality here is munging ``meta`` to exclude any</span>
<span class="sd">        MetaAttributes that are marked for exclusion from pickling (e.g. stars,</span>
<span class="sd">        dark).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>

        <span class="c1"># For everything in meta that is a MetaAttribute, check if it should</span>
        <span class="c1"># be pickled.</span>
        <span class="n">pickle_excludes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">descr</span><span class="p">,</span> <span class="n">MetaAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">descr</span><span class="o">.</span><span class="n">pickle</span><span class="p">:</span>
                <span class="n">pickle_excludes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">pickle_excludes</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">meta</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">columns</span><span class="p">,</span> <span class="n">meta</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Restore object from pickle state.</span>

<span class="sd">        This fixes an upstream issue in astropy.table (as of 3.1) where the</span>
<span class="sd">        Table __setstate__ does ``self.__init__(columns, meta)``, which makes a</span>
<span class="sd">        deepcopy of ``meta``.  That is inefficient but more importantly does</span>
<span class="sd">        not preserve the ``acqs`` weakref in cand_acqs[&#39;probs&#39;].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">columns</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Low-tech index to quickly get a row or the row index by `id` column.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_index</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_index_mon</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">has_type</span> <span class="o">=</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">has_type</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MON&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id_index_mon</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_id_index</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">idx</span>

<div class="viewcode-block" id="BaseCatalogTable.get_id"><a class="viewcode-back" href="../../api.html#proseco.core.BaseCatalogTable.get_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return row corresponding to ``id`` in id column.</span>

<span class="sd">        :param id: int</span>
<span class="sd">            row ``id`` column value</span>
<span class="sd">        :param mon: bool</span>
<span class="sd">            return ID for corresponding MON star (default=False)</span>
<span class="sd">        :returns: table Row</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_id_idx</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">mon</span><span class="p">)]</span></div>

<div class="viewcode-block" id="BaseCatalogTable.get_id_idx"><a class="viewcode-back" href="../../api.html#proseco.core.BaseCatalogTable.get_id_idx">[docs]</a>    <span class="k">def</span> <span class="nf">get_id_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return row corresponding to ``id`` in id column.</span>

<span class="sd">        :param id: int</span>
<span class="sd">            row ``id`` column value</span>
<span class="sd">        :param mon: bool</span>
<span class="sd">            return ID for corresponding MON star (default=False)</span>
<span class="sd">        :returns: table row index (int)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_id_index&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_index</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_index_mon</span> <span class="k">if</span> <span class="n">mon</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_index</span><span class="p">)[</span><span class="nb">id</span><span class="p">]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_index</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id_index_mon</span> <span class="k">if</span> <span class="n">mon</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_index</span><span class="p">)[</span><span class="nb">id</span><span class="p">]</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is not in table&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idx</span></div>

<div class="viewcode-block" id="BaseCatalogTable.get_candidates_mask"><a class="viewcode-back" href="../../api.html#proseco.core.BaseCatalogTable.get_candidates_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_candidates_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a boolean mask indicating which ``stars`` are acceptable candidates</span>
<span class="sd">        for the parent class.  This basically applies to guide and acq, though</span>
<span class="sd">        ACACatalog uses a hybrid of those two.</span>

<span class="sd">        This is used directly in selection of candidates.  For the base class all</span>
<span class="sd">        stars are considered acceptable.</span>

<span class="sd">        :param stars: StarsTable of stars</span>
<span class="sd">        :returns: bool mask</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bad_stars_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mask of stars that are not acceptable candidates for the parent class.  This</span>
<span class="sd">        basically applies to guide and acq, though ACACatalog uses a hybrid of</span>
<span class="sd">        those two.</span>

<span class="sd">        This is mostly used for plotting, corresponding to the ``bad_stars``</span>
<span class="sd">        arg of plot_stars where bad stars are plotting in a distinctive color.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_bad_stars_mask&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bad_stars_mask</span> <span class="o">=</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">get_candidates_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bad_stars_mask</span>

    <span class="nd">@bad_stars_mask</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bad_stars_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bad_stars_mask</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bad_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Back-compatibility property for bad_stars_mask&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_stars_mask</span>

<div class="viewcode-block" id="BaseCatalogTable.plot"><a class="viewcode-back" href="../../api.html#proseco.core.BaseCatalogTable.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the catalog and background stars.</span>

<span class="sd">        :param ax: matplotlib axes object for plotting to (optional)</span>
<span class="sd">        :param kwargs: other keyword args for plot_stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">chandra_aca.plot</span> <span class="kn">import</span> <span class="n">plot_stars</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;stars&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>

        <span class="c1"># Explicitly set bad_stars so that plot_stars does not apply its</span>
        <span class="c1"># internal version (which is no lot always the right answer).</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bad_stars&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stars&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_stars</span><span class="p">(</span><span class="n">attitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">att</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;agg&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="ACACatalogTable"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable">[docs]</a><span class="k">class</span> <span class="nc">ACACatalogTable</span><span class="p">(</span><span class="n">BaseCatalogTable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for representing ACA catalogs in star selection.  This</span>
<span class="sd">    can apply to acq, guide and fid entries.</span>

<span class="sd">    Features:</span>
<span class="sd">    - Inherits from astropy Table</span>
<span class="sd">    - Logging</span>
<span class="sd">    - Serialization to/from pickle</span>
<span class="sd">    - Predefined formatting for nicer representations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Name of table.  Use to define default file names where applicable.</span>
    <span class="c1"># Should be set by subclass, e.g. ``name = &#39;acqs&#39;`` for AcqTable.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;aca_cat&quot;</span>

    <span class="c1"># Catalog attributes, gets set in MetaAttribute or AliasAttribute</span>
    <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;dark&quot;</span><span class="p">])</span>

    <span class="n">required_attrs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;dither_acq&quot;</span><span class="p">,</span> <span class="s2">&quot;dither_guide&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">)</span>

    <span class="n">obsid</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">att</span> <span class="o">=</span> <span class="n">QuatMetaAttribute</span><span class="p">()</span>
    <span class="n">n_acq</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">n_guide</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">n_fid</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">monitors</span> <span class="o">=</span> <span class="n">MonitorsMetaAttribute</span><span class="p">()</span>
    <span class="n">man_angle</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">man_angle_next</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">180.0</span><span class="p">)</span>
    <span class="n">t_ccd_acq</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">t_ccd_guide</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">dark_date</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">dither_acq</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">dither_guide</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">sim_offset</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">focus_offset</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>
    <span class="n">target_offset</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="n">dyn_bgd_n_faint</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dyn_bgd_dt_ccd</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">include_ids_acq</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">include_halfws_acq</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">exclude_ids_acq</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">include_ids_guide</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">exclude_ids_guide</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">include_ids_fid</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">exclude_ids_fid</span> <span class="o">=</span> <span class="n">IntListMetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">[])</span>
    <span class="n">optimize</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">print_log</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">log_info</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">{},</span> <span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_dark&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dark</span>

        <span class="c1"># If self.dark_date is already set (most likely after unpickling an existing</span>
        <span class="c1"># catalog), then use that instead of the observation date for getting the dark map.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="p">:</span>
            <span class="n">dark_id</span> <span class="o">=</span> <span class="n">get_dark_cal_id</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found dark cal image </span><span class="si">{</span><span class="n">dark_id</span><span class="si">}</span><span class="s2"> nearest self.dark_date=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Warn if the pickled dark_date is not the same as we would have gotten based</span>
            <span class="c1"># on the observation date.</span>
            <span class="n">dark_id_for_date</span> <span class="o">=</span> <span class="n">get_dark_cal_id</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dark_id</span> <span class="o">!=</span> <span class="n">dark_id_for_date</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected dark_date: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;dark_id nearest dark_date=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">dark_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but dark_id before obs date=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">dark_id_for_date</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dark_id</span> <span class="o">=</span> <span class="n">get_dark_cal_id</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found dark cal image </span><span class="si">{</span><span class="n">dark_id</span><span class="si">}</span><span class="s2"> before self.date=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># In all cases set self.dark_date to be the actual date of the dark cal</span>
        <span class="c1"># we are using, not what might have been set on input.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span> <span class="o">=</span> <span class="n">dark_id</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">dark_id</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>

        <span class="c1"># Dark current map handling.  If asking for `dark` attribute without having set</span>
        <span class="c1"># it then auto-fetch from mica.  Note that get_dark_cal_image caches returned values</span>
        <span class="c1"># using LRU cache on all params, so this is efficient for the different</span>
        <span class="c1"># catalog tables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Getting dark cal image at date=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="si">}</span><span class="s2"> t_ccd=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark</span> <span class="o">=</span> <span class="n">get_dark_cal_image</span><span class="p">(</span>
            <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_date</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="n">t_ccd_ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span><span class="p">,</span> <span class="n">aca_image</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dark</span>

    <span class="nd">@dark</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dark</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Set pixel regions from ACA.bad_pixels to have acqs.dark=700000 (5.0 mag</span>
        <span class="c1"># star) per pixel.</span>
        <span class="k">for</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">ACA</span><span class="o">.</span><span class="n">bad_pixels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dark</span><span class="p">[</span>
                <span class="n">r0</span> <span class="o">+</span> <span class="mi">512</span> <span class="p">:</span> <span class="n">r1</span> <span class="o">+</span> <span class="mi">513</span><span class="p">,</span> <span class="n">c0</span> <span class="o">+</span> <span class="mi">512</span> <span class="p">:</span> <span class="n">c1</span> <span class="o">+</span> <span class="mi">513</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">bad_pixel_dark_current</span>

    <span class="k">def</span> <span class="nf">set_attrs_from_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># If name is an allowed keyword arg or a settable property on the class</span>
            <span class="c1"># then set now.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_kwargs</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isdatadescriptor</span><span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unexpected keyword argument &quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># If an explicit obsid is not provided to all getting parameters via mica</span>
        <span class="c1"># then all other params must be supplied.</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_attrs</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;missing required parameters </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># If not all params supplied then get via mica for the obsid.</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;getting starcheck catalog for obsid </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obsid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">obs</span> <span class="o">=</span> <span class="n">get_starcheck_catalog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsid</span><span class="p">)</span>
                <span class="n">obso</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;obs&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Probably AttributeError for a non-existent obsid, where</span>
                <span class="c1"># get_starcheck_catalog returns None. But catch anything in case</span>
                <span class="c1"># something else happened. Exception chaining will help here.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;missing required parameters </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> and &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;could not fill them in from obsid </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obsid</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">att</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">att</span> <span class="o">=</span> <span class="p">[</span><span class="n">obso</span><span class="p">[</span><span class="s2">&quot;point_ra&quot;</span><span class="p">],</span> <span class="n">obso</span><span class="p">[</span><span class="s2">&quot;point_dec&quot;</span><span class="p">],</span> <span class="n">obso</span><span class="p">[</span><span class="s2">&quot;point_roll&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">obso</span><span class="p">[</span><span class="s2">&quot;mp_starcat_time&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pred_temp&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">man_angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">man_angle</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;manvr&quot;</span><span class="p">][</span><span class="s2">&quot;angle_deg&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">obso</span><span class="p">[</span><span class="s2">&quot;sci_instr&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_offset</span> <span class="o">=</span> <span class="n">obso</span><span class="p">[</span><span class="s2">&quot;sim_z_offset_steps&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">focus_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">focus_offset</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FID&quot;</span><span class="p">)</span>

            <span class="n">n_mon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MON&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n_mon</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found </span><span class="si">{</span><span class="n">n_mon</span><span class="si">}</span><span class="s2"> MON stars in catalog, ignoring them&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Replicate the number of guide stars in the original catalog.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_guide</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">-</span> <span class="n">n_mon</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="s2">&quot;HRC-S&quot;</span>

            <span class="k">for</span> <span class="n">dither_attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dither_acq&quot;</span><span class="p">,</span> <span class="s2">&quot;dither_guide&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dither_attr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dither_y_amp</span> <span class="o">=</span> <span class="n">obso</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dither_y_amp&quot;</span><span class="p">)</span>
                    <span class="n">dither_z_amp</span> <span class="o">=</span> <span class="n">obso</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dither_z_amp&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dither_y_amp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dither_z_amp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dither_attr</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">((</span><span class="n">dither_y_amp</span><span class="p">,</span> <span class="n">dither_z_amp</span><span class="p">)))</span>

                        <span class="c1"># Special rule for handling big dither from mica.starcheck,</span>
                        <span class="c1"># which does not yet know about dither_acq vs. dither_guide.</span>
                        <span class="c1"># Use the most common dither size for ACIS / HRC.</span>
                        <span class="k">if</span> <span class="n">dither_attr</span> <span class="o">==</span> <span class="s2">&quot;dither_acq&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dither_acq</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                            <span class="n">dither</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ACIS&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">20</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dither_acq</span> <span class="o">=</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">dither</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">starcheck_catalog</span> <span class="o">=</span> <span class="n">obs</span>

        <span class="k">for</span> <span class="n">dither_attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dither_acq&quot;</span><span class="p">,</span> <span class="s2">&quot;dither_guide&quot;</span><span class="p">):</span>
            <span class="n">dither</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dither_attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dither</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dither_attr</span><span class="p">,</span> <span class="n">ACABox</span><span class="p">(</span><span class="n">dither</span><span class="p">))</span>

<div class="viewcode-block" id="ACACatalogTable.set_stars"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.set_stars">[docs]</a>    <span class="k">def</span> <span class="nf">set_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_near_fov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the object ``stars`` attribute to an appropriate StarsTable object.</span>

<span class="sd">        If ``acqs`` is defined that will be a previously computed AcqTable with</span>
<span class="sd">        ``stars`` already available, so use that.</span>

<span class="sd">        :param acqs: AcqTable for same observation</span>
<span class="sd">        :param filter_near_fov: include only stars in or near ACA FOV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">acqs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_agasc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_stars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stars</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">stars</span>

        <span class="k">if</span> <span class="n">filter_near_fov</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ACA</span><span class="o">.</span><span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;row_max&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ACA</span><span class="o">.</span><span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;fov_pad&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ACA</span><span class="o">.</span><span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;col_max&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ACA</span><span class="o">.</span><span class="n">CCD</span><span class="p">[</span><span class="s2">&quot;fov_pad&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span>  <span class="c1"># type: StarsTable</span></div>

<div class="viewcode-block" id="ACACatalogTable.get_catalog_for_plot"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.get_catalog_for_plot">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog_for_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return value of ``catalog`` for plot_stars() call for this object</span>

<span class="sd">        For ACACatalogTable this is the self Table object but with the possibility</span>
<span class="sd">        of changing all the `type` column values to self.catalog_type (e.g. &#39;ACQ&#39;).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_type</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_type</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">catalog</span></div>

<div class="viewcode-block" id="ACACatalogTable.plot"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the catalog and background stars.</span>

<span class="sd">        :param ax: matplotlib axes object for plotting to (optional)</span>
<span class="sd">        :param kwargs: other keyword args for plot_stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;catalog&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_catalog_for_plot</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_stars</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;stars&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;bad_stars&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_stars_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;starcat_time&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dither</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@dither</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dither</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dither_acq</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dither_guide</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Subclasses must implement.</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@t_ccd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

<div class="viewcode-block" id="ACACatalogTable.empty"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.empty">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a minimal ACACatalogTable which satisfies API requirements.  Currently</span>
<span class="sd">        this means that it has an &#39;id&#39; column which can be examined for length.</span>

<span class="sd">        :returns: StarsTable of stars (empty)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">acqs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;acqs&quot;</span><span class="p">)</span>

    <span class="nd">@acqs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">acqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;acqs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fids&quot;</span><span class="p">)</span>

    <span class="nd">@fids</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">fids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;fids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">guides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;guides&quot;</span><span class="p">)</span>

    <span class="nd">@guides</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">guides</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;guides&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mons&quot;</span><span class="p">)</span>

    <span class="nd">@mons</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;mons&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="ACACatalogTable.process_include_ids"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.process_include_ids">[docs]</a>    <span class="k">def</span> <span class="nf">process_include_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cand_stars</span><span class="p">,</span> <span class="n">stars</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that the candidate acqs/guides table has stars that were forced to be included.</span>

<span class="sd">        Updates ``cand_stars`` in place.</span>

<span class="sd">        :param cand_stars: candidate acquisition or guide stars table</span>
<span class="sd">        :param stars: stars table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">include_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cand_stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">star</span> <span class="o">=</span> <span class="n">stars</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">include_id</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;cannot include star id=</span><span class="si">{</span><span class="n">include_id</span><span class="si">}</span><span class="s2"> that is not &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;a valid star in the ACA field of view&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cand_stars</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Included star id=</span><span class="si">{</span><span class="n">include_id</span><span class="si">}</span><span class="s2"> in candidates table&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACACatalogTable.log"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a log event to self.log_info[&#39;events&#39;] include ``data`` (which</span>
<span class="sd">        is typically, but not required to be, a string).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Name of calling functions, starting from top (outermost) and</span>
        <span class="c1"># ending with function that called log()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

        <span class="c1"># Possible extension later to include calling context, but this</span>
        <span class="c1"># currently includes a whole bunch more, need to filter to just</span>
        <span class="c1"># this module.</span>
        <span class="c1"># framerecs = inspect.stack()[1:-1]</span>
        <span class="c1"># funcs = [framerec[3] for framerec in reversed(framerecs)]</span>
        <span class="c1"># func = funcs[-1]</span>
        <span class="n">log_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span>

        <span class="n">tm</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">tm</span> <span class="o">-</span> <span class="n">log_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;unix_run_time&quot;</span><span class="p">,</span> <span class="n">tm</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">to_python</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WARNING: &quot;</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;events&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">log_info</span><span class="p">:</span>
            <span class="n">log_info</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_info</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_log</span><span class="p">:</span>
            <span class="n">data_str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">7.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">func</span><span class="si">:</span><span class="s2">20s</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">data_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return list of warnings in the event log.  This returns just the</span>
<span class="sd">        string message without context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span><span class="p">[</span><span class="s2">&quot;events&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warning&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">warns</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return string traceback of a top-level caught exception, or &quot;&quot; (empty</span>
<span class="sd">        string) if no exception has been caught.  Mostly for use in Matlab</span>
<span class="sd">        interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nd">@exception</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;exception&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_set_formats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Apply default formats to applicable columns and delete</span>
        <span class="c1"># that default format so it doesn&#39;t get set again next time.</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_formats</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_formats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="ACACatalogTable.pformat"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.pformat">[docs]</a>    <span class="k">def</span> <span class="nf">pformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_formats</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACACatalogTable.pprint"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.pprint">[docs]</a>    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_formats</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_base_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_formats</span><span class="p">()</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;O&quot;</span><span class="p">]</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">BaseCatalogTable</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">_base_repr_</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ACACatalogTable.to_pickle"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the catalog table as pickle to:</span>
<span class="sd">          ``&lt;rootdir&gt;/obs&lt;obsid&gt;/&lt;name&gt;.pkl``</span>

<span class="sd">        :param rootdir: root directory (default=&#39;.&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rootdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rootdir</span><span class="p">)</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">rootdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;obs</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">05</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outdir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACACatalogTable.from_pickle"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.from_pickle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">obsid</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct table from pickle file in</span>
<span class="sd">          ``&lt;rootdir&gt;/obs&lt;obsid&gt;/&lt;name&gt;.pkl``</span>

<span class="sd">        :param obsid: Obsid</span>
<span class="sd">        :param rootdir: root directory (default=&#39;.&#39;)</span>
<span class="sd">        :returns: catalog table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rootdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rootdir</span><span class="p">)</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">rootdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;obs</span><span class="si">{</span><span class="n">obsid</span><span class="si">:</span><span class="s2">05</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACACatalogTable.has_column_spoiler"><a class="viewcode-back" href="../../api.html#proseco.core.ACACatalogTable.has_column_spoiler">[docs]</a>    <span class="k">def</span> <span class="nf">has_column_spoiler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cand</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if ``cand`` has a column spoiler downstream toward readout</span>
<span class="sd">        register which is:</span>
<span class="sd">        - at least 4.5 mag brighter (ACA.col_spoiler_mag_diff)</span>
<span class="sd">        - within 10 pixels in column (ACA.col_spoiler_pix_sep)</span>

<span class="sd">        Also records a log entry for detected spoilers</span>

<span class="sd">        :param cand: object with &#39;row&#39;, &#39;col&#39;, and &#39;mag&#39; items</span>
<span class="sd">        :param stars: StarsTable</span>
<span class="sd">        :param mask: boolean mask of stars to check (default=None =&gt; no mask)</span>
<span class="sd">        :returns: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">()</span>  <span class="c1"># No mask</span>

        <span class="c1"># Star further from readout register than candidate</span>
        <span class="c1"># AND on same side of CCD</span>
        <span class="c1"># AND within column separation limit</span>
        <span class="c1"># AND within mag limit</span>
        <span class="n">bads</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ACA</span><span class="o">.</span><span class="n">col_spoiler_pix_sep</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ACA</span><span class="o">.</span><span class="n">col_spoiler_mag_diff</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bads</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Candidate object id=</span><span class="si">{</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> rejected due to column spoiler(s) &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">][</span><span class="n">bads</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">cand</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<span class="c1"># AGASC columns not needed (at this moment) for acq star selection.</span>
<span class="c1"># Change as needed.</span>
<span class="n">AGASC_COLS_DROP</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;RA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DEC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;POS_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EPOCH&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PM_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PLX&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PLX_ERR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PLX_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAG_ERR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAG_BAND&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MAG_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C1_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COLOR2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;COLOR2_ERR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VAR_CATID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ACQQ6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XREF_ID1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XREF_ID2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XREF_ID3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XREF_ID4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;XREF_ID5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;RSV6&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Define a function that returns the observed standard deviation in ACA mag</span>
<span class="c1"># as a function of catalog mag.  This is about the std-dev for samples</span>
<span class="c1"># within an observation, NOT the error on the catalog mag (which is about</span>
<span class="c1"># the error on mean of the sample, not the std-dev of the sample).</span>
<span class="c1">#</span>
<span class="c1"># See ASPECT/ipynb/star_selection/star-mag-std-dev.ipynb for the source of numbers.</span>
<span class="c1">#</span>
<span class="c1"># Note that get_mag_std is a function that is called with get_mag_std(mag_aca).</span>
<span class="n">get_mag_std</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mf">6.7</span><span class="p">,</span> <span class="mf">7.3</span><span class="p">,</span> <span class="mf">7.8</span><span class="p">,</span> <span class="mf">8.3</span><span class="p">,</span> <span class="mf">8.8</span><span class="p">,</span> <span class="mf">9.2</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>  <span class="c1"># mag</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[</span>
        <span class="mf">0.015</span><span class="p">,</span>
        <span class="mf">0.015</span><span class="p">,</span>
        <span class="mf">0.022</span><span class="p">,</span>
        <span class="mf">0.029</span><span class="p">,</span>
        <span class="mf">0.038</span><span class="p">,</span>
        <span class="mf">0.055</span><span class="p">,</span>
        <span class="mf">0.077</span><span class="p">,</span>
        <span class="mf">0.109</span><span class="p">,</span>
        <span class="mf">0.141</span><span class="p">,</span>
        <span class="mf">0.23</span><span class="p">,</span>
        <span class="mf">1.0</span><span class="p">,</span>
    <span class="p">],</span>  <span class="c1"># std-dev</span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="StarsTable"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable">[docs]</a><span class="k">class</span> <span class="nc">StarsTable</span><span class="p">(</span><span class="n">BaseCatalogTable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Table of stars for use in proseco.</span>

<span class="sd">    This is meant to be created only with available class methods:</span>

<span class="sd">    - from_agasc() : calls agasc.get_agasc_cone()</span>
<span class="sd">    - from_stars() : init from the results of a call to get_agasc_cone()</span>
<span class="sd">    - from_agasc_ids() : calls agasc.get_stars()</span>
<span class="sd">    - empty() : empty catalog, then use add_* methods to add stars</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">att</span> <span class="o">=</span> <span class="n">QuatMetaAttribute</span><span class="p">()</span>

    <span class="c1"># StarsTable attributes, gets set in MetaAttribute or AliasAttribute</span>
    <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">logger</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">null_logger</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">return</span> <span class="n">null_logger</span>

<div class="viewcode-block" id="StarsTable.get_catalog_for_plot"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.get_catalog_for_plot">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog_for_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return value of ``catalog`` for plot_stars() call for this object</span>

<span class="sd">        For StarsTable this is None (no catalog).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="StarsTable.plot"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the star field.</span>

<span class="sd">        :param ax: matplotlib axes object for plotting to (optional)</span>
<span class="sd">        :param kwargs: other keywords for plot_stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;stars&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="StarsTable.from_agasc"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.from_agasc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_agasc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get AGASC stars in the ACA FOV.  This uses the proseco-AGASC, so only stars</span>
<span class="sd">        within 3-sigma of 11.5 mag or those nearby a potential guide/acq star are</span>
<span class="sd">        included.</span>

<span class="sd">        This uses an AGASC file path defined by the AGASC_HDF_FILE env var or the latest</span>
<span class="sd">        version of proseco_agasc in the default AGASC directory. The AGASC directory can</span>
<span class="sd">        be set with the AGASC_DIR env var.</span>

<span class="sd">        :param att: any Quat-compatible attitude</span>
<span class="sd">        :param date: DateTime compatible date for star proper motion (default=NOW)</span>
<span class="sd">        :param radius: star cone radius [deg] (default=1.2)</span>
<span class="sd">        :param logger: logger object (default=None)</span>

<span class="sd">        :returns: StarsTable of stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q_att</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>
        <span class="c1"># The AGASC file being used is delegated to the agasc module default, which</span>
        <span class="c1"># is the latest proseco_agasc file unless overridden by the  AGASC_HDF5_FILE.</span>
        <span class="c1"># The AGASC_DIR env vars controls where the AGASC files are located.</span>
        <span class="n">agasc_stars</span> <span class="o">=</span> <span class="n">agasc</span><span class="o">.</span><span class="n">get_agasc_cone</span><span class="p">(</span>
            <span class="n">q_att</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">q_att</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span>
        <span class="p">)</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_stars</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">agasc_stars</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="si">}</span><span class="s2"> stars from AGASC at &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ra=</span><span class="si">{</span><span class="n">q_att</span><span class="o">.</span><span class="n">ra</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> dec=</span><span class="si">{</span><span class="n">q_att</span><span class="o">.</span><span class="n">dec</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">stars</span></div>

<div class="viewcode-block" id="StarsTable.from_agasc_ids"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.from_agasc_ids">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_agasc_ids</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">agasc_ids</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get AGASC stars in the ACA FOV using a list of AGASC IDs.</span>

<span class="sd">        :param att: any Quat-compatible attitude</span>
<span class="sd">        :param agasc_ids: sequence of AGASC ID values</span>
<span class="sd">        :param date: DateTime compatible date for star proper motion (default=NOW)</span>
<span class="sd">        :param logger: logger object (default=None)</span>

<span class="sd">        :returns: StarsTable of stars</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agasc_stars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">agasc_id</span> <span class="ow">in</span> <span class="n">agasc_ids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">star</span> <span class="o">=</span> <span class="n">agasc</span><span class="o">.</span><span class="n">get_star</span><span class="p">(</span><span class="n">agasc_id</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to get AGASC ID=</span><span class="si">{</span><span class="n">agasc_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">agasc_stars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
        <span class="n">agasc_stars</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">agasc_stars</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">agasc_stars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_stars</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">stars</span><span class="o">=</span><span class="n">agasc_stars</span><span class="p">)</span></div>

<div class="viewcode-block" id="StarsTable.from_stars"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.from_stars">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_stars</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;StarsTable&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a StarsTable from an existing AGASC stars query.  This just updates</span>
<span class="sd">        columns in place.</span>

<span class="sd">        If ``stars`` is a StarsTable, the attitude of that object ``stars.att`` must</span>
<span class="sd">        match ``att`` to within 0.001 arcsec in pitch, yaw, and roll.</span>

<span class="sd">        :param att: any Quat-compatible attitude</span>
<span class="sd">        :param stars: Table of stars</span>
<span class="sd">        :param logger: logger object (default=None)</span>
<span class="sd">        :param copy: copy ``stars`` table columns</span>

<span class="sd">        :returns: StarsTable of stars</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

        <span class="n">q_att</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">att</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">StarsTable</span><span class="p">):</span>
            <span class="c1"># Check for consistency between stars att and supplied att</span>
            <span class="c1"># if att is not the same object as stars.att.</span>
            <span class="k">if</span> <span class="n">att</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">stars</span><span class="o">.</span><span class="n">att</span><span class="p">:</span>
                <span class="n">q_att_stars</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">stars</span><span class="o">.</span><span class="n">att</span><span class="p">)</span>
                <span class="n">dq</span> <span class="o">=</span> <span class="n">q_att</span><span class="o">.</span><span class="n">dq</span><span class="p">(</span><span class="n">q_att_stars</span><span class="p">)</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">/</span> <span class="mi">3600</span>  <span class="c1"># 0.001 arcsec</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">lim</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;yaw&quot;</span><span class="p">,</span> <span class="s2">&quot;roll0&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;supplied att </span><span class="si">{</span><span class="n">att</span><span class="si">}</span><span class="s2"> does not match stars att </span><span class="si">{</span><span class="n">stars</span><span class="o">.</span><span class="n">att</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">stars</span>

        <span class="n">stars</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="n">copy</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">att</span>

        <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating star columns for attitude and convenience&quot;</span><span class="p">)</span>

        <span class="n">stars</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;q_att&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_att</span>
        <span class="n">yag</span><span class="p">,</span> <span class="n">zag</span> <span class="o">=</span> <span class="n">radec_to_yagzag</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">],</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">],</span> <span class="n">q_att</span><span class="p">)</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span><span class="n">yag</span><span class="p">,</span> <span class="n">zag</span><span class="p">,</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pix_zero_loc</span><span class="o">=</span><span class="s2">&quot;edge&quot;</span><span class="p">)</span>

        <span class="n">stars</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">(</span>
            <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">AGASC_COLS_DROP</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">stars</span><span class="o">.</span><span class="n">colnames</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">stars</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="s2">&quot;AGASC_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ra&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;dec&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">yag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;yang&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">zag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;zang&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;col&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span>
            <span class="n">Column</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mag&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">7</span>
        <span class="p">)</span>  <span class="c1"># For convenience</span>

        <span class="c1"># Mag_err column is the RSS of the catalog mag err (i.e. systematic error in</span>
        <span class="c1"># the true star mag) and the sample uncertainty in the ACA readout mag</span>
        <span class="c1"># for a star with mag=MAG_ACA.  The latter typically dominates above 9th mag.</span>
        <span class="n">mag_aca_err</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.01</span>

        <span class="c1"># For color=1.5 stars set a lower limit of 0.3 on the catalog mag error.</span>
        <span class="c1"># This is based on analysis in ipynb/star_selection/star-mag-std-dev.ipynb</span>
        <span class="c1"># which shows that for color=1.5 stars the observed mag error is</span>
        <span class="c1"># does not correlate well with mag_err below around 0.3 and so setting a</span>
        <span class="c1"># floor of 0.3 is a reasonable way to capture the uncertainty.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;COLOR1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.5</span>
        <span class="n">mag_aca_err</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_aca_err</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">mag_std_dev</span> <span class="o">=</span> <span class="n">get_mag_std</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">])</span>
        <span class="n">mag_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mag_aca_err</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mag_std_dev</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">mag_err</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mag_err&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

        <span class="n">logger</span><span class="p">(</span><span class="s2">&quot;Finished star processing&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stars</span></div>

<div class="viewcode-block" id="StarsTable.empty"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.empty">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">att</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an empty StarsTable suitable for generating synthetic tables.</span>

<span class="sd">        :param att: any Quat-compatible attitude</span>
<span class="sd">        :returns: StarsTable of stars (empty)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_agasc</span><span class="p">(</span><span class="n">att</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Remove &quot;agasc_file&quot; meta key since it does not apply for a synthetic table.</span>
        <span class="k">del</span> <span class="n">stars</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;agasc_file&quot;</span><span class="p">]</span>
        <span class="n">stars</span><span class="o">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">att</span>

        <span class="k">return</span> <span class="n">stars</span></div>

<div class="viewcode-block" id="StarsTable.add_agasc_id"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.add_agasc_id">[docs]</a>    <span class="k">def</span> <span class="nf">add_agasc_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agasc_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a AGASC star to the current StarsTable.</span>

<span class="sd">        :param agasc_id: AGASC ID of the star to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">StarsTable</span><span class="o">.</span><span class="n">from_agasc_ids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;q_att&quot;</span><span class="p">],</span> <span class="p">[</span><span class="n">agasc_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="StarsTable.add_fake_constellation"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.add_fake_constellation">[docs]</a>    <span class="k">def</span> <span class="nf">add_fake_constellation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_stars</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a fake constellation of up to 8 stars consisting of a cross and square::</span>

<span class="sd">                *</span>
<span class="sd">              *   *</span>
<span class="sd">            *       *</span>
<span class="sd">              *   *</span>
<span class="sd">                *</span>

<span class="sd">          yangs = [1,  0, -1,  0, 0.5,  0.5, -0.5, -0.5] * size</span>
<span class="sd">          zangs = [0,  1,  0, -1, 0.5, -0.5,  0.5, -0.5] * size</span>

<span class="sd">        Additional star table attributes can be specified as keyword args.  All</span>
<span class="sd">        attributes are broadcast as needed.</span>

<span class="sd">        Example::</span>

<span class="sd">          &gt;&gt;&gt; stars = StarsTable.empty()</span>
<span class="sd">          &gt;&gt;&gt; stars.add_fake_constellation(n_stars=4, size=1000, mag=7.5, ASPQ1=[0, 1, 0, 20])</span>
<span class="sd">          &gt;&gt;&gt; stars[&#39;id&#39;, &#39;yang&#39;, &#39;zang&#39;, &#39;mag&#39;, &#39;ASPQ1&#39;]</span>
<span class="sd">          &lt;StarsTable length=4&gt;</span>
<span class="sd">            id    yang     zang     mag   ASPQ1</span>
<span class="sd">          int32 float64  float64  float32 int16</span>
<span class="sd">          ----- -------- -------- ------- -----</span>
<span class="sd">            100  1000.00     0.00    7.50     0</span>
<span class="sd">            101     0.00  1000.00    7.50     1</span>
<span class="sd">            102 -1000.00     0.00    7.50     0</span>
<span class="sd">            103     0.00 -1000.00    7.50    20</span>

<span class="sd">        :param n_stars: number of stars (default=8, max=8)</span>
<span class="sd">        :param size: size of constellation [arcsec] (default=2000)</span>
<span class="sd">        :param mag: star magnitudes (default=7.0)</span>
<span class="sd">        :param \**attrs: other star table attributes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_stars</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max value of n_stars is 8&quot;</span><span class="p">)</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_stars</span><span class="p">)</span>
        <span class="n">yangs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">][:</span><span class="n">n_stars</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">size</span>
        <span class="p">)</span>
        <span class="n">zangs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">][:</span><span class="n">n_stars</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">size</span>
        <span class="p">)</span>

        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">,</span> <span class="n">yangs</span><span class="p">,</span> <span class="n">zangs</span><span class="p">,</span> <span class="n">mag</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;yang&quot;</span><span class="p">,</span> <span class="s2">&quot;zang&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">vals</span><span class="p">)})</span></div>

<div class="viewcode-block" id="StarsTable.add_fake_star"><a class="viewcode-back" href="../../api.html#proseco.core.StarsTable.add_fake_star">[docs]</a>    <span class="k">def</span> <span class="nf">add_fake_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">star</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a star to the current StarsTable.</span>

<span class="sd">        The input kwargs must have at least:</span>
<span class="sd">        - One of yang/zang, ra/dec, or row/col</span>
<span class="sd">        - mag</span>
<span class="sd">        - mag_err (defaults to 0.1)</span>

<span class="sd">        Mag_err is set to 0.1 if not provided.  Yang/zang, ra/dec, and row/col</span>
<span class="sd">        RA/DEC_PMCORR, MAG_ACA, MAG_ACA_ERR will all be set according to the</span>
<span class="sd">        primary inputs unless explicitly provided.  All the rest will be set</span>
<span class="sd">        to default &quot;good&quot;&quot; values that will preclude initial exclusion of the star.</span>

<span class="sd">        :param \**star: keyword arg attributes corresponding to StarTable columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ra&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dec&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yang&quot;</span><span class="p">,</span>
            <span class="s2">&quot;zang&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row&quot;</span><span class="p">,</span>
            <span class="s2">&quot;col&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mag_err&quot;</span><span class="p">,</span>
            <span class="s2">&quot;POS_ERR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PM_RA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PM_DEC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAG_ACA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MAG_ACA_ERR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CLASS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COLOR1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COLOR1_ERR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VAR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ASPQ1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ASPQ2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ASPQ3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;mag_err&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;VAR&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">9999</span><span class="p">}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">star</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span>
        <span class="p">}</span>

        <span class="n">q_att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;q_att&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;ra&quot;</span> <span class="ow">in</span> <span class="n">star</span> <span class="ow">and</span> <span class="s2">&quot;dec&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_to_yagzag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span> <span class="n">q_att</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;yang&quot;</span> <span class="ow">in</span> <span class="n">star</span> <span class="ow">and</span> <span class="s2">&quot;zang&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yagzag_to_radec</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">q_att</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yagzag_to_pixels</span><span class="p">(</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;row&quot;</span> <span class="ow">in</span> <span class="n">star</span> <span class="ow">and</span> <span class="s2">&quot;col&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixels_to_yagzag</span><span class="p">(</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;row&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span> <span class="n">allow_bad</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yagzag_to_radec</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span> <span class="n">q_att</span><span class="p">)</span>

        <span class="n">reqd_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">,</span> <span class="s2">&quot;yang&quot;</span><span class="p">,</span> <span class="s2">&quot;zang&quot;</span><span class="p">,</span> <span class="s2">&quot;mag&quot;</span><span class="p">,</span> <span class="s2">&quot;mag_err&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">reqd_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;incomplete star data did not get </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> data&quot;</span><span class="p">)</span>

        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;RA_PMCORR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;DEC_PMCORR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;MAG_ACA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">]</span>

        <span class="c1"># The fake_code attribute is used for monitor window handling to</span>
        <span class="c1"># indicate that this star has been added as a fake star so that guide</span>
        <span class="c1"># selection can select it as a force-include star. Subsequently the</span>
        <span class="c1"># code is used to infer the provenance of that star.</span>
        <span class="k">if</span> <span class="s2">&quot;fake_code&quot;</span> <span class="ow">in</span> <span class="n">star</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;fake_code&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;fake_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;fake_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">star</span><span class="p">[</span><span class="s2">&quot;fake_code&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">add_fake_stars_from_fid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fid_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">offset_y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">offset_z</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">mag</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detector</span><span class="o">=</span><span class="s2">&quot;ACIS-S&quot;</span><span class="p">,</span>
        <span class="n">sim_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fids</span> <span class="o">=</span> <span class="n">FIDS_CACHE</span><span class="p">[</span><span class="n">detector</span><span class="p">,</span> <span class="n">sim_offset</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.fid</span> <span class="kn">import</span> <span class="n">get_fid_catalog</span>

            <span class="n">fids</span> <span class="o">=</span> <span class="n">get_fid_catalog</span><span class="p">(</span>
                <span class="n">att</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">n_fid</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">detector</span><span class="o">=</span><span class="n">detector</span><span class="p">,</span>
                <span class="n">sim_offset</span><span class="o">=</span><span class="n">sim_offset</span><span class="p">,</span>
                <span class="n">focus_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">t_ccd</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
                <span class="n">date</span><span class="o">=</span><span class="s2">&quot;2018:001&quot;</span><span class="p">,</span>
                <span class="n">dither</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">FIDS_CACHE</span><span class="p">[</span><span class="n">detector</span><span class="p">,</span> <span class="n">sim_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">fids</span>

        <span class="n">arrays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">fid_id</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">offset_z</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fid_id</span><span class="p">,</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">offset_z</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">fids</span><span class="o">.</span><span class="n">cand_fids</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">fid_id</span><span class="p">)</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">yang</span><span class="o">=</span><span class="n">fid</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset_y</span><span class="p">,</span> <span class="n">zang</span><span class="o">=</span><span class="n">fid</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset_z</span><span class="p">,</span> <span class="n">mag</span><span class="o">=</span><span class="n">mag</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_fake_star</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="bin2x2"><a class="viewcode-back" href="../../api.html#proseco.core.bin2x2">[docs]</a><span class="k">def</span> <span class="nf">bin2x2</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bin 2-d ``arr`` in 2x2 blocks.  Requires that ``arr`` has even shape sizes&quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<span class="n">RC_6x6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="mi">10</span><span class="p">,</span>
        <span class="mi">11</span><span class="p">,</span>
        <span class="mi">12</span><span class="p">,</span>
        <span class="mi">13</span><span class="p">,</span>
        <span class="mi">17</span><span class="p">,</span>
        <span class="mi">18</span><span class="p">,</span>
        <span class="mi">19</span><span class="p">,</span>
        <span class="mi">20</span><span class="p">,</span>
        <span class="mi">21</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">,</span>
        <span class="mi">26</span><span class="p">,</span>
        <span class="mi">27</span><span class="p">,</span>
        <span class="mi">28</span><span class="p">,</span>
        <span class="mi">29</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">,</span>
        <span class="mi">33</span><span class="p">,</span>
        <span class="mi">34</span><span class="p">,</span>
        <span class="mi">35</span><span class="p">,</span>
        <span class="mi">36</span><span class="p">,</span>
        <span class="mi">37</span><span class="p">,</span>
        <span class="mi">38</span><span class="p">,</span>
        <span class="mi">41</span><span class="p">,</span>
        <span class="mi">42</span><span class="p">,</span>
        <span class="mi">43</span><span class="p">,</span>
        <span class="mi">44</span><span class="p">,</span>
        <span class="mi">45</span><span class="p">,</span>
        <span class="mi">46</span><span class="p">,</span>
        <span class="mi">50</span><span class="p">,</span>
        <span class="mi">51</span><span class="p">,</span>
        <span class="mi">52</span><span class="p">,</span>
        <span class="mi">53</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ROW_6x6</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="mf">0.5</span>
<span class="p">)</span>

<span class="n">COL_6x6</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
            <span class="mi">6</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="mf">0.5</span>
<span class="p">)</span>


<div class="viewcode-block" id="get_image_props"><a class="viewcode-back" href="../../api.html#proseco.core.get_image_props">[docs]</a><span class="k">def</span> <span class="nf">get_image_props</span><span class="p">(</span><span class="n">ccd_img</span><span class="p">,</span> <span class="n">c_row</span><span class="p">,</span> <span class="n">c_col</span><span class="p">,</span> <span class="n">bgd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do a pseudo-read and compute the background-subtracted magnitude</span>
<span class="sd">    of the image.  Returns the 8x8 image and mag.</span>

<span class="sd">    :param ccd_image: full-frame CCD image (e.g. dark current, with or without stars).</span>
<span class="sd">    :param c_row: int row at center (readout row-4 to row+4)</span>
<span class="sd">    :param c_col: int col at center</span>
<span class="sd">    :param bgd: background to subtract at each pixel.  If None then compute flight bgd.</span>

<span class="sd">    :returns: 8x8 image (ndarray), image mag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">ccd_img</span><span class="p">[</span><span class="n">c_row</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">c_row</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">c_col</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">:</span> <span class="n">c_col</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">bgd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;no calc_flight_background here&quot;</span><span class="p">)</span>
        <span class="c1"># bgd = calc_flight_background(img)  # currently not defined</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">-</span> <span class="n">bgd</span>
    <span class="n">img_6x6</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">RC_6x6</span><span class="p">]</span>
    <span class="n">img_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img_6x6</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img_6x6</span> <span class="o">*</span> <span class="n">ROW_6x6</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_sum</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">img_6x6</span> <span class="o">*</span> <span class="n">COL_6x6</span><span class="p">)</span> <span class="o">/</span> <span class="n">img_sum</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">c_row</span> <span class="o">-</span> <span class="mi">4</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">c_col</span> <span class="o">-</span> <span class="mi">4</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="n">count_rate_to_mag</span><span class="p">(</span><span class="n">img_sum</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">img_sum</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span></div>


<div class="viewcode-block" id="pea_reject_image"><a class="viewcode-back" href="../../api.html#proseco.core.pea_reject_image">[docs]</a><span class="k">def</span> <span class="nf">pea_reject_image</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if PEA would reject image (too narrow, too peaky, etc)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To be implemented</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_kwargs_from_starcheck_text"><a class="viewcode-back" href="../../api.html#proseco.core.get_kwargs_from_starcheck_text">[docs]</a><span class="k">def</span> <span class="nf">get_kwargs_from_starcheck_text</span><span class="p">(</span><span class="n">obs_text</span><span class="p">,</span> <span class="n">include_cat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_catalog</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get proseco kwargs using the exact catalog from the starcheck output text</span>
<span class="sd">    ``obs_text``.  Mostly copied from annie/annie (should move into mica.starcheck</span>
<span class="sd">    one day).</span>

<span class="sd">    :param obs_text: text copied from starcheck output</span>
<span class="sd">    :param include_cat: include the original catalog in returned kwargs</span>
<span class="sd">    :param force_catalog: force proseco catalog to match the original catalog</span>
<span class="sd">    :returns: dict of keyword args corresponding to proseco args</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">textwrap</span>

    <span class="kn">from</span> <span class="nn">mica.starcheck.starcheck_parser</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">get_catalog</span><span class="p">,</span>
        <span class="n">get_coords</span><span class="p">,</span>
        <span class="n">get_dither</span><span class="p">,</span>
        <span class="n">get_manvrs</span><span class="p">,</span>
        <span class="n">get_pred_temp</span><span class="p">,</span>
        <span class="n">get_starcat_header</span><span class="p">,</span>
        <span class="n">get_targ</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Remove common leading whitespace</span>
    <span class="n">obs_text</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>

    <span class="c1"># Set up defaults</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dither&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">),</span>
        <span class="s2">&quot;t_ccd&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2018:001&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_guide&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s2">&quot;detector&quot;</span><span class="p">:</span> <span class="s2">&quot;ACIS-S&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sim_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;focus_offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;OBSID:\s(\d+).*&quot;</span><span class="p">,</span> <span class="n">obs_text</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Nothing else will work so raise an exception</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;text does not have OBSID: &lt;obsid&gt;, does not look like appropriate text&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">get_coords</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;att&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;point_ra&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;point_dec&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;point_roll&quot;</span><span class="p">]]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">get_manvrs</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;att&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;target_Q1&quot;</span><span class="p">],</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;target_Q2&quot;</span><span class="p">],</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;target_Q3&quot;</span><span class="p">],</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;target_Q4&quot;</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">get_manvrs</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;man_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;angle_deg&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">get_dither</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;dither&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;dither_y_amp&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;dither_z_amp&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ccd_temp</span> <span class="o">=</span> <span class="n">get_pred_temp</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;t_ccd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccd_temp</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">starcat_hdr</span> <span class="o">=</span> <span class="n">get_starcat_header</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starcat_hdr</span><span class="p">[</span><span class="s2">&quot;mp_starcat_time&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">get_catalog</span><span class="p">(</span><span class="n">obs_text</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">cat</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">monitors</span> <span class="o">=</span> <span class="n">get_monitors</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">],</span> <span class="n">cat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitors</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;monitors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monitors</span>

        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FID&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_cat</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span>

        <span class="k">if</span> <span class="n">force_catalog</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;ACQ&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">))</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;include_ids_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;include_halfws_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;GUI&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">))</span>
            <span class="c1"># n_guide kwarg needs to include guide stars + MON stars</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span>
                <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MON&quot;</span>
            <span class="p">)</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;include_ids_guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="s2">&quot;FID&quot;</span><span class="p">)</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;include_ids_fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;n_fid&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">targ</span> <span class="o">=</span> <span class="n">get_targ</span><span class="p">(</span><span class="n">obs_text</span><span class="p">)</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;detector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="s2">&quot;sci_instr&quot;</span><span class="p">]</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;sim_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">targ</span><span class="p">[</span><span class="s2">&quot;sim_z_offset_steps&quot;</span><span class="p">]</span>
        <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;focus_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">kw</span></div>


<div class="viewcode-block" id="get_monitors"><a class="viewcode-back" href="../../api.html#proseco.core.get_monitors">[docs]</a><span class="k">def</span> <span class="nf">get_monitors</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">cat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a list of monitor requests for an existing catalog</span>

<span class="sd">    :param obsid: int, obsid</span>
<span class="sd">    :param cat: starcheck catalog from get_catalog</span>
<span class="sd">    :returns: list of monitor requests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">monitors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Sort catalog by slot and index, and then iterate over catalog in reverse</span>
    <span class="c1"># order. This guarantees that any GFM or MON in slot 7 comes first so that</span>
    <span class="c1"># `monitors` is in the correct order. In particular the first entry is</span>
    <span class="c1"># always put into slot 7.</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cat</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;slot&quot;</span><span class="p">,</span> <span class="s2">&quot;idx&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1"># Will need to remove when we start scheduling OR&#39;s with 8x8 guides.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GUI&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;slot&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">7</span>
            <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sz&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;8x8&quot;</span>
            <span class="ow">and</span> <span class="n">obsid</span> <span class="o">&lt;=</span> <span class="mi">38000</span>
        <span class="p">):</span>
            <span class="c1"># Guide from MON (GFM) so force scheduling as GUI</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span>
                <span class="n">ACA</span><span class="o">.</span><span class="n">MonCoord</span><span class="o">.</span><span class="n">YAGZAG</span><span class="p">,</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;mag&quot;</span><span class="p">],</span>
                <span class="n">ACA</span><span class="o">.</span><span class="n">MonFunc</span><span class="o">.</span><span class="n">GUIDE</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MON&quot;</span><span class="p">:</span>
            <span class="c1"># Bona fide MON entry</span>
            <span class="n">mon_func</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ACA</span><span class="o">.</span><span class="n">MonFunc</span><span class="o">.</span><span class="n">MON_FIXED</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;slot&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;dim&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">ACA</span><span class="o">.</span><span class="n">MonFunc</span><span class="o">.</span><span class="n">MON_TRACK</span>
            <span class="p">)</span>
            <span class="n">monitor</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;yang&quot;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;zang&quot;</span><span class="p">],</span>
                <span class="n">ACA</span><span class="o">.</span><span class="n">MonCoord</span><span class="o">.</span><span class="n">YAGZAG</span><span class="p">,</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;maxmag&quot;</span><span class="p">],</span>
                <span class="n">mon_func</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">monitors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">monitors</span></div>


<div class="viewcode-block" id="includes_for_obsid"><a class="viewcode-back" href="../../api.html#proseco.core.includes_for_obsid">[docs]</a><span class="k">def</span> <span class="nf">includes_for_obsid</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dict with the include_ids_acq, include_halfws_acq and include_ids_guide</span>
<span class="sd">    lists for the as-run flight catalog of ``obsid``.  Useful for forcing catalog.</span>

<span class="sd">    Example::</span>

<span class="sd">      &gt;&gt;&gt; from proseco import get_aca_catalog</span>
<span class="sd">      &gt;&gt;&gt; from proseco.core import includes_for_obsid</span>
<span class="sd">      &gt;&gt;&gt; obsid = 8008</span>
<span class="sd">      &gt;&gt;&gt; aca = get_aca_catalog(obsid, **includes_for_obsid(obsid))</span>

<span class="sd">    :param obsid: int, obsid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mica.starcheck</span> <span class="kn">import</span> <span class="n">get_starcheck_catalog</span>

    <span class="n">obs</span> <span class="o">=</span> <span class="n">get_starcheck_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>

    <span class="n">cat</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cat&quot;</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;ACQ&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;include_ids_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;include_halfws_acq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;halfw&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;GUI&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;include_ids_guide&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="p">(</span><span class="s2">&quot;FID&quot;</span><span class="p">))</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;include_ids_fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">][</span><span class="n">ok</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_dim_res"><a class="viewcode-back" href="../../api.html#proseco.core.get_dim_res">[docs]</a><span class="k">def</span> <span class="nf">get_dim_res</span><span class="p">(</span><span class="n">halfws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get ACA search command ``dim`` and ``res`` corresponding to ``halfws``</span>

<span class="sd">    From DM11, where ``dim`` is a 6-bit uint and ``res`` is a 1-bit uint with</span>
<span class="sd">    0 =&gt; &quot;L&quot; and 1 =&gt; H&quot;.</span>

<span class="sd">    Define the search region (``dim``) for any image data slot to be a square</span>
<span class="sd">    centered at the commanded angular Z and Y coordinates. When the high</span>
<span class="sd">    resolution flag (H) (``res``) in command word 3 is true (=1), the half width</span>
<span class="sd">    of the square, in arc seconds, is (20 + 5D) where D is the dimension field</span>
<span class="sd">    in command word 2. When the H flag is false (=0), the half width, is (20 +</span>
<span class="sd">    40D) arc seconds.</span>

<span class="sd">    :param halfws: array of int</span>
<span class="sd">        Half-widths (arcsec)</span>
<span class="sd">    :returns: tuple (int array, int array)</span>
<span class="sd">        ACA search DIM and RES entries corresponding to halfws</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Max value of dim is 2**6 = 64, so high res is up to 20 + 5 * 63 = 335.</span>
    <span class="c1"># But values up to 335 + 2.5 would have dim=63 because of rounding. Select</span>
    <span class="c1"># the high-res and low-res values at that cutoff.</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">halfws</span> <span class="o">&lt;</span> <span class="mi">335</span> <span class="o">+</span> <span class="mf">2.5</span>

    <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">halfws</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">halfws</span><span class="p">)</span>
    <span class="c1"># High-resolution halfws</span>
    <span class="n">res</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dim</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">halfws</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
    <span class="c1"># Low-resolution halfws</span>
    <span class="n">res</span><span class="p">[</span><span class="o">~</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dim</span><span class="p">[</span><span class="o">~</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">halfws</span><span class="p">[</span><span class="o">~</span><span class="n">ok</span><span class="p">]</span> <span class="o">-</span> <span class="mi">20</span><span class="p">)</span> <span class="o">/</span> <span class="mi">40</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">dim</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dim</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;halfws </span><span class="si">{</span><span class="n">halfws</span><span class="si">}</span><span class="s2"> leading to bad value(s) of dim </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dim</span><span class="p">,</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_img_size"><a class="viewcode-back" href="../../api.html#proseco.core.get_img_size">[docs]</a><span class="k">def</span> <span class="nf">get_img_size</span><span class="p">(</span><span class="n">n_fids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get guide image readout size from ``n_fids``.</span>

<span class="sd">    This is the core definition for the default rule specifying the guide star</span>
<span class="sd">    image size.</span>

<span class="sd">    ER&#39;s (observations with no fids) always get 8x8.</span>

<span class="sd">    OR&#39;s (observations with fids) default to 8x8. This can be globally</span>
<span class="sd">    overridden by setting the ``PROSECO_OR_IMAGE_SIZE`` environment</span>
<span class="sd">    variable to &quot;4&quot;, &quot;6&quot; or &quot;8&quot;. As a reminder the ``img_size_guide`` parameter</span>
<span class="sd">    of ``get_aca_catalog`` can also be set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_fids : int</span>
<span class="sd">        Number of fids in the catalog</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Guide star image readout size to be used in a catalog (6 or 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_or_img_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PROSECO_OR_IMAGE_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default_or_img_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;8&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PROSECO_OR_IMAGE_SIZE must be 6 or 8, not </span><span class="si">{</span><span class="n">default_or_img_size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">default_or_img_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_fids</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">8</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>