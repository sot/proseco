
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>proseco.catalog &#8212; proseco 4.8.2.dev39+g28739c0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">proseco</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../index.html">proseco 4.8.2.dev39+g28739c0 documentation</a>
	 &#187;
      </li>
      <li><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for proseco.catalog</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">ACACatalogTable</span><span class="p">,</span> <span class="n">get_kwargs_from_starcheck_text</span><span class="p">,</span> <span class="n">MetaAttribute</span>
<span class="kn">from</span> <span class="nn">.guide</span> <span class="kn">import</span> <span class="n">get_guide_catalog</span><span class="p">,</span> <span class="n">GuideTable</span>
<span class="kn">from</span> <span class="nn">.acq</span> <span class="kn">import</span> <span class="n">get_acq_catalog</span><span class="p">,</span> <span class="n">AcqTable</span>
<span class="kn">from</span> <span class="nn">.fid</span> <span class="kn">import</span> <span class="n">get_fid_catalog</span><span class="p">,</span> <span class="n">FidTable</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">characteristics_acq</span> <span class="k">as</span> <span class="n">ACQ</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">characteristics</span> <span class="k">as</span> <span class="n">ACA</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">VERSION</span>


<div class="viewcode-block" id="get_aca_catalog"><a class="viewcode-back" href="../../api.html#proseco.catalog.get_aca_catalog">[docs]</a><span class="k">def</span> <span class="nf">get_aca_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a catalog of guide stars, acquisition stars and fid lights.</span>

<span class="sd">    If ``obsid`` is supplied and is a string, then it is taken to be starcheck</span>
<span class="sd">    text with required info.  User-supplied kwargs take precedence, however</span>
<span class="sd">    (e.g.  one can override the dither from starcheck).</span>

<span class="sd">    In this situation if the ``obsid`` text includes the string</span>
<span class="sd">    ``--force-catalog`` anywhere then the final proseco guide and acq catalogs</span>
<span class="sd">    will be forced to match the input starcheck catalog.  This can be done by</span>
<span class="sd">    appending this string, e.g. with ``obs_text + &#39;--force-catalog&#39;`` in the</span>
<span class="sd">    call to ``get_aca_catalog``.</span>

<span class="sd">    NOTE on API:</span>

<span class="sd">    Keywords that have ``_acq`` and/or ``_guide`` suffixes are handled with</span>
<span class="sd">    the AliasAttribute in core.py.  If one calls get_aca_catalog() with e.g.</span>
<span class="sd">    ``t_ccd=-10`` then that will set the CCD temperature for both acq and</span>
<span class="sd">    guide selection.  This is not part of the public API but is a private</span>
<span class="sd">    feature of the implementation that works for now.</span>

<span class="sd">    :param obsid: obsid (int) or starcheck text (str) (default=0)</span>
<span class="sd">    :param att: attitude (any object that can initialize Quat)</span>
<span class="sd">    :param n_acq: desired number of acquisition stars (default=8)</span>
<span class="sd">    :param n_fid: desired number of fid lights (req&#39;d unless obsid spec&#39;d)</span>
<span class="sd">    :param n_guide: desired number of guide stars (req&#39;d unless obsid spec&#39;d)</span>
<span class="sd">    :param monitors: N x 5 float array specifying monitor windows</span>
<span class="sd">    :param man_angle: maneuver angle (deg)</span>
<span class="sd">    :param t_ccd_acq: ACA CCD temperature for acquisition (degC)</span>
<span class="sd">    :param t_ccd_guide: ACA CCD temperature for guide (degC)</span>
<span class="sd">    :param date: date of acquisition (any DateTime-compatible format)</span>
<span class="sd">    :param dither_acq: acq dither size (2-element sequence (y, z), arcsec)</span>
<span class="sd">    :param dither_guide: guide dither size (2-element sequence (y, z), arcsec)</span>
<span class="sd">    :param detector: &#39;ACIS-S&#39; | &#39;ACIS-I&#39; | &#39;HRC-S&#39; | &#39;HRC-I&#39;</span>
<span class="sd">    :param sim_offset: SIM translation offset from nominal [steps] (default=0)</span>
<span class="sd">    :param focus_offset: SIM focus offset [steps] (default=0)</span>
<span class="sd">    :param target_offset: (y, z) target offset including dynamical offset</span>
<span class="sd">                          (2-element sequence (y, z), deg)</span>
<span class="sd">    :param stars: table of AGASC stars (will be fetched from agasc if None)</span>
<span class="sd">    :param include_ids_acq: list of AGASC IDs of stars to include in acq catalog</span>
<span class="sd">    :param include_halfws_acq: list of acq halfwidths corresponding to ``include_ids``.</span>
<span class="sd">                               For values of ``0`` proseco chooses the best halfwidth(s).</span>
<span class="sd">    :param exclude_ids_acq: list of AGASC IDs of stars to exclude from acq catalog</span>
<span class="sd">    :param include_ids_fid: list of fiducial lights to include by index.  If no possible</span>
<span class="sd">                            sets of fids include the id, no fids will be selected.</span>
<span class="sd">    :param exclude_ids_fid: list of fiducial lights to exclude by index</span>
<span class="sd">    :param include_ids_guide: list of AGASC IDs of stars to include in guide catalog</span>
<span class="sd">    :param exclude_ids_guide: list of AGASC IDs of stars to exclude from guide catalog</span>
<span class="sd">    :param optimize: optimize star catalog after initial selection (default=True)</span>
<span class="sd">    :param verbose: provide extra logging info (mostly calc_p_safe) (default=False)</span>
<span class="sd">    :param print_log: print the run log to stdout (default=False)</span>
<span class="sd">    :param raise_exc: raise exception if it occurs in processing (default=True)</span>

<span class="sd">    :returns: ACATable of stars and fids</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raise_exc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;raise_exc&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># This cannot credibly fail</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If obsid is supplied as a string then it is taken to be starcheck text</span>
        <span class="c1"># with required info.  User-supplied kwargs take precedence, however.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">force_catalog</span> <span class="o">=</span> <span class="s1">&#39;--force-catalog&#39;</span> <span class="ow">in</span> <span class="n">obsid</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="n">get_kwargs_from_starcheck_text</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">force_catalog</span><span class="o">=</span><span class="n">force_catalog</span><span class="p">)</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;obsid&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">aca</span> <span class="o">=</span> <span class="n">_get_aca_catalog</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="n">raise_exc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">raise_exc</span><span class="p">:</span>
            <span class="c1"># This is for debugging</span>
            <span class="k">raise</span>

        <span class="n">aca</span> <span class="o">=</span> <span class="n">ACATable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>  <span class="c1"># Makes zero-length table with correct columns</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">aca</span></div>


<span class="k">def</span> <span class="nf">_get_aca_catalog</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Do the actual work of getting the acq, fid and guide catalogs and</span>
<span class="sd">    assembling the merged aca catalog.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">raise_exc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;raise_exc&#39;</span><span class="p">)</span>

    <span class="n">aca</span> <span class="o">=</span> <span class="n">ACATable</span><span class="p">()</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">call_args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">set_attrs_from_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Override t_ccd related inputs with effective temperatures for downstream</span>
    <span class="c1"># action by AcqTable, GuideTable, FidTable.  See set_attrs_from_kwargs()</span>
    <span class="c1"># method for more details.</span>
    <span class="k">if</span> <span class="s1">&#39;t_ccd&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_ccd&#39;</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_ccd_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">t_ccd_eff_acq</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;t_ccd_guide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">t_ccd_eff_guide</span>

    <span class="c1"># Get stars (typically from AGASC) and do not filter for stars near</span>
    <span class="c1"># the ACA FOV.  This leaves the full radial selection available for</span>
    <span class="c1"># later roll optimization.  Use aca.stars or aca.acqs.stars from here.</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">set_stars</span><span class="p">(</span><span class="n">filter_near_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting get_acq_catalog&#39;</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span> <span class="o">=</span> <span class="n">get_acq_catalog</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">stars</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Store the date of the dark cal if available.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">,</span> <span class="s1">&#39;dark_date&#39;</span><span class="p">):</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">dark_date</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">dark_date</span>

    <span class="c1"># Note that aca.acqs.stars is a filtered version of aca.stars and includes</span>
    <span class="c1"># only stars that are in or near ACA FOV.  Use this for fids and guides stars.</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting get_fid_catalog&#39;</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">fids</span> <span class="o">=</span> <span class="n">get_fid_catalog</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">stars</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">fids</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">fids</span>

    <span class="k">if</span> <span class="n">aca</span><span class="o">.</span><span class="n">optimize</span><span class="p">:</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting optimize_acqs_fids&#39;</span><span class="p">)</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">optimize_acqs_fids</span><span class="p">()</span>

    <span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting get_guide_catalog&#39;</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">guides</span> <span class="o">=</span> <span class="n">get_guide_catalog</span><span class="p">(</span><span class="n">stars</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">stars</span><span class="p">,</span> <span class="n">fids</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Make a merged starcheck-like catalog.  Catch any errors at this point to avoid</span>
    <span class="c1"># impacting operational work (call from Matlab).</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Starting merge_cats&#39;</span><span class="p">)</span>
        <span class="n">merge_cat</span> <span class="o">=</span> <span class="n">merge_cats</span><span class="p">(</span><span class="n">fids</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">fids</span><span class="p">,</span> <span class="n">guides</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">guides</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="n">aca</span><span class="o">.</span><span class="n">acqs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">merge_cat</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">aca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_cat</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">raise_exc</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="n">empty</span> <span class="o">=</span> <span class="n">ACACatalogTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">empty</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
            <span class="n">aca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">empty</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="n">aca</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>

    <span class="n">aca</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Finished aca_get_catalog&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aca</span>


<div class="viewcode-block" id="get_effective_t_ccd"><a class="viewcode-back" href="../../api.html#proseco.catalog.get_effective_t_ccd">[docs]</a><span class="k">def</span> <span class="nf">get_effective_t_ccd</span><span class="p">(</span><span class="n">t_ccd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the effective T_ccd used for selection and catalog evaluation.</span>

<span class="sd">    For details see Dynamic ACA limits in baby steps section in:</span>
<span class="sd">    https://occweb.cfa.harvard.edu/twiki/bin/view/Aspect/StarWorkingGroupMeeting2019x02x13</span>

<span class="sd">    :param t_ccd:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_limit</span> <span class="o">=</span> <span class="n">ACA</span><span class="o">.</span><span class="n">aca_t_ccd_penalty_limit</span>
    <span class="k">if</span> <span class="n">t_ccd</span> <span class="o">&gt;</span> <span class="n">t_limit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t_ccd</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_ccd</span> <span class="o">-</span> <span class="n">t_limit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">t_ccd</span></div>


<div class="viewcode-block" id="ACATable"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable">[docs]</a><span class="k">class</span> <span class="nc">ACATable</span><span class="p">(</span><span class="n">ACACatalogTable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Container ACACatalogTable class that has merged guide / acq / fid catalogs</span>
<span class="sd">    as attributes and other methods relevant to the merged catalog.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define base set of allowed keyword args to __init__. Subsequent MetaAttribute</span>
    <span class="c1"># or AliasAttribute properties will add to this.</span>
    <span class="n">allowed_kwargs</span> <span class="o">=</span> <span class="n">ACACatalogTable</span><span class="o">.</span><span class="n">allowed_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">optimize</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">call_args</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">()</span>

    <span class="c1"># For validation with get_aca_catalog(obsid), store the starcheck</span>
    <span class="c1"># catalog in the ACATable meta.</span>
    <span class="n">starcheck_catalog</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Effective T_ccd used for dynamic ACA limits (see updates_for_t_ccd_effective()</span>
    <span class="c1"># method below).</span>
    <span class="n">t_ccd_eff_acq</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">t_ccd_eff_guide</span> <span class="o">=</span> <span class="n">MetaAttribute</span><span class="p">(</span><span class="n">is_kwarg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Astropy Table now does a light key-only copy of the `meta` dict, so</span>
        <span class="c1"># copy.copy(aca) does not copy the underlying table attributes.  Force</span>
        <span class="c1"># a deepcopy instead.</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For top-level ACATable object use the guide temperature, which is always</span>
        <span class="c1"># greater than or equal to the acq temperature.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_guide</span>

    <span class="nd">@t_ccd</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_guide</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_acq</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="ACATable.empty"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.empty">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">empty</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">acqs</span> <span class="o">=</span> <span class="n">AcqTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">fids</span> <span class="o">=</span> <span class="n">FidTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">guides</span> <span class="o">=</span> <span class="n">GuideTable</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="ACATable.set_attrs_from_kwargs"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.set_attrs_from_kwargs">[docs]</a>    <span class="k">def</span> <span class="nf">set_attrs_from_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set object attributes from kwargs.</span>

<span class="sd">        After calling the base class method which does all the real work, then</span>
<span class="sd">        compute the effective T_ccd temperatures.</span>

<span class="sd">        In this ACATable object:</span>

<span class="sd">        - t_ccd_eff_{acq,guide} are the effective T_ccd values which are adjusted</span>
<span class="sd">          if the actual t_ccd{acq,guide} values are above ACA.aca_t_ccd_penalty_limit.</span>
<span class="sd">        - t_ccd_{acq,guide} are the actual (or predicted) values from the call</span>

<span class="sd">        The downstream AcqTable, GuideTable, and FidTable are initialized with the</span>
<span class="sd">        *effective* values as t_ccd.  Those classes do not have the concept of effective</span>
<span class="sd">        temperature.</span>

<span class="sd">        :param kwargs: dict of input kwargs</span>
<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_attrs_from_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_eff_acq</span> <span class="o">=</span> <span class="n">get_effective_t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_acq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_eff_guide</span> <span class="o">=</span> <span class="n">get_effective_t_ccd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_ccd_guide</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">VERSION</span></div>

<div class="viewcode-block" id="ACATable.get_review_table"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.get_review_table">[docs]</a>    <span class="k">def</span> <span class="nf">get_review_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ACAReviewTable object based on self.</span>

<span class="sd">        :returns: ACAReviewTable object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">sparkles.core</span> <span class="kn">import</span> <span class="n">ACAReviewTable</span>

        <span class="k">return</span> <span class="n">ACAReviewTable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACATable.get_candidates_mask"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.get_candidates_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_candidates_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a boolean mask indicating which ``stars`` are acceptable candidates</span>
<span class="sd">        for the parent class.</span>

<span class="sd">        For ACATable this is the logical OR of the guide and acq values,</span>
<span class="sd">        i.e. for ACA a candidate is shown as OK if it is OK for either guide or</span>
<span class="sd">        acq.  This is just used for plotting.</span>

<span class="sd">        :param stars: StarsTable of stars</span>
<span class="sd">        :returns: bool mask</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">get_candidates_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span> <span class="o">|</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">guides</span><span class="o">.</span><span class="n">get_candidates_mask</span><span class="p">(</span><span class="n">stars</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ok</span></div>

<div class="viewcode-block" id="ACATable.make_report"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.make_report">[docs]</a>    <span class="k">def</span> <span class="nf">make_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rootdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make summary HTML report for acq and guide selection process and outputs.</span>

<span class="sd">        Outputs are in ``&lt;rootdir&gt;/obs&lt;obsid&gt;/{acq,guide}/index.html`` plus related</span>
<span class="sd">        images in that directory.</span>

<span class="sd">        :param rootdir: root directory for outputs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acqs</span><span class="o">.</span><span class="n">make_report</span><span class="p">(</span><span class="n">rootdir</span><span class="o">=</span><span class="n">rootdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guides</span><span class="o">.</span><span class="n">make_report</span><span class="p">(</span><span class="n">rootdir</span><span class="o">=</span><span class="n">rootdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ACATable.optimize_acqs_fids"><a class="viewcode-back" href="../../api.html#proseco.catalog.ACATable.optimize_acqs_fids">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_acqs_fids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concurrently optimize acqs and fids in the case where there is not</span>
<span class="sd">        already a good (no spoilers) fid set available.</span>

<span class="sd">        This updates the acqs and fids tables in place.</span>

<span class="sd">        :param acqs: AcqTable object</span>
<span class="sd">        :param fids: FidTable object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acqs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acqs</span>
        <span class="n">fids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fids</span>

        <span class="c1"># IF get_fid_catalog returned a good catalog,</span>
        <span class="c1">#    OR no fids were requested,</span>
        <span class="c1">#    OR no candidate fids are available,</span>
        <span class="c1">#    OR no candidate fid sets are available</span>
        <span class="c1"># THEN no optimization action required here.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="o">.</span><span class="n">cand_fids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="o">.</span><span class="n">cand_fid_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Start with the no-fids optimum catalog and save required info to restore</span>
        <span class="n">opt_P2</span> <span class="o">=</span> <span class="o">-</span><span class="n">acqs</span><span class="o">.</span><span class="n">get_log_p_2_or_fewer</span><span class="p">()</span>
        <span class="n">orig_acq_idxs</span> <span class="o">=</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">orig_acq_halfws</span> <span class="o">=</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting opt_P2=</span><span class="si">{</span><span class="n">opt_P2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">: ids=</span><span class="si">{</span><span class="n">orig_acq_idxs</span><span class="si">}</span><span class="s1"> halfws=</span><span class="si">{</span><span class="n">orig_acq_halfws</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># If not at least 2 fids then punt on optimization.</span>
        <span class="n">cand_fids</span> <span class="o">=</span> <span class="n">fids</span><span class="o">.</span><span class="n">cand_fids</span>

        <span class="c1"># Get list of fid_sets that are consistent with candidate fids. These</span>
        <span class="c1"># fid sets are the combinations of 3 (or 2) fid lights in preferred</span>
        <span class="c1"># order.</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fid_set</span> <span class="ow">in</span> <span class="n">fids</span><span class="o">.</span><span class="n">cand_fid_sets</span><span class="p">:</span>
            <span class="n">spoiler_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">cand_fids</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">fid_id</span><span class="p">)[</span><span class="s1">&#39;spoiler_score&#39;</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">fid_id</span> <span class="ow">in</span> <span class="n">fid_set</span><span class="p">)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fid_set</span><span class="p">,</span> <span class="n">spoiler_score</span><span class="p">))</span>

        <span class="c1"># Make a table to keep track of candidate fid_sets along with the</span>
        <span class="c1"># ranking metric P2 and the acq catalog info halfws and star ids.</span>
        <span class="n">fid_sets</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;fid_ids&#39;</span><span class="p">,</span> <span class="s1">&#39;spoiler_score&#39;</span><span class="p">))</span>
        <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;P2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span>  <span class="c1"># Marker for unfilled values</span>
        <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;acq_halfws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;acq_idxs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Group the table into groups by spoiler score.  This preserves the</span>
        <span class="c1"># original fid set ordering within a group.</span>
        <span class="n">fid_sets</span> <span class="o">=</span> <span class="n">fid_sets</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s1">&#39;spoiler_score&#39;</span><span class="p">)</span>

        <span class="c1"># Iterate through each spoiler_score group and then within that iterate</span>
        <span class="c1"># over each fid set.</span>
        <span class="k">for</span> <span class="n">fid_set_group</span> <span class="ow">in</span> <span class="n">fid_sets</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">spoiler_score</span> <span class="o">=</span> <span class="n">fid_set_group</span><span class="p">[</span><span class="s1">&#39;spoiler_score&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checking fid sets with spoiler_score=</span><span class="si">{</span><span class="n">spoiler_score</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fid_set</span> <span class="ow">in</span> <span class="n">fid_set_group</span><span class="p">:</span>
                <span class="c1"># Set the internal acqs fid set.  This does validation of the set</span>
                <span class="c1"># and also calls update_p_acq_column().</span>
                <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;fid_ids&#39;</span><span class="p">]</span>

                <span class="c1"># If P2 is effectively unchanged after updating the fid set,</span>
                <span class="c1"># that means there are no fids spoiling an acq star in the</span>
                <span class="c1"># optimum (no-fid) acq catalog, and there is no need to</span>
                <span class="c1"># re-optimize.  Furthermore this fid set is guaranteed to meet</span>
                <span class="c1"># the stage_min_P2 acceptance so no need to check any other fid</span>
                <span class="c1"># sets.  Only optimize if P2 decreased by at least 0.001,</span>
                <span class="c1"># remembering P2 is the -log10(prob).</span>
                <span class="n">fid_set_P2</span> <span class="o">=</span> <span class="o">-</span><span class="n">acqs</span><span class="o">.</span><span class="n">get_log_p_2_or_fewer</span><span class="p">()</span>
                <span class="n">found_good_set</span> <span class="o">=</span> <span class="n">fid_set_P2</span> <span class="o">-</span> <span class="n">opt_P2</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.001</span>
                <span class="k">if</span> <span class="n">found_good_set</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No change in P2 for fid set </span><span class="si">{</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span><span class="si">}</span><span class="s1">, &#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;skipping optimization&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Re-optimize the catalog with the fid set selected and get new probs.</span>
                    <span class="n">acqs</span><span class="o">.</span><span class="n">optimize_catalog</span><span class="p">()</span>
                    <span class="n">acqs</span><span class="o">.</span><span class="n">update_p_acq_column</span><span class="p">(</span><span class="n">acqs</span><span class="p">)</span>  <span class="c1"># Needed for get_log_p_2_or_fewer</span>

                <span class="c1"># Store optimization results</span>
                <span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;P2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">acqs</span><span class="o">.</span><span class="n">get_log_p_2_or_fewer</span><span class="p">()</span>
                <span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;acq_idxs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;acq_halfws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fid set </span><span class="si">{</span><span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;fid_ids&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: P2=</span><span class="si">{</span><span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;P2&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;acq_idxs=</span><span class="si">{</span><span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;acq_idxs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> halfws=</span><span class="si">{</span><span class="n">fid_set</span><span class="p">[</span><span class="s1">&#39;acq_halfws&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">found_good_set</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Put the catalog back to the original no-fid optimum and continue</span>
                    <span class="c1"># trying remaining fid sets.</span>
                    <span class="n">acqs</span><span class="o">.</span><span class="n">update_idxs_halfws</span><span class="p">(</span><span class="n">orig_acq_idxs</span><span class="p">,</span> <span class="n">orig_acq_halfws</span><span class="p">)</span>

            <span class="c1"># Get the best fid set / acq catalog configuration so far.  Fid sets not</span>
            <span class="c1"># yet considered have P2 = -99.</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;P2&#39;</span><span class="p">])</span>
            <span class="n">best_P2</span> <span class="o">=</span> <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;P2&#39;</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span>

            <span class="c1"># Get the row of the fid / acq stages table to determine the required minimum</span>
            <span class="c1"># P2 given the fid spoiler score.</span>
            <span class="n">stage</span> <span class="o">=</span> <span class="n">ACQ</span><span class="o">.</span><span class="n">fid_acq_stages</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">spoiler_score</span><span class="p">]</span>
            <span class="n">stage_min_P2</span> <span class="o">=</span> <span class="n">stage</span><span class="p">[</span><span class="s1">&#39;min_P2&#39;</span><span class="p">](</span><span class="n">opt_P2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Best P2=</span><span class="si">{</span><span class="n">best_P2</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> at idx=</span><span class="si">{</span><span class="n">best_idx</span><span class="si">}</span><span class="s1"> vs. &#39;</span>
                     <span class="s1">&#39;stage_min_P2=</span><span class="si">{stage_min_P2:.2f}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># If we have a winner then use that.</span>
            <span class="k">if</span> <span class="n">best_P2</span> <span class="o">&gt;=</span> <span class="n">stage_min_P2</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Set the acqs table to the best catalog</span>
        <span class="n">best_acq_idxs</span> <span class="o">=</span> <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;acq_idxs&#39;</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">best_acq_halfws</span> <span class="o">=</span> <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;acq_halfws&#39;</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span>
        <span class="n">acqs</span><span class="o">.</span><span class="n">update_idxs_halfws</span><span class="p">(</span><span class="n">best_acq_idxs</span><span class="p">,</span> <span class="n">best_acq_halfws</span><span class="p">)</span>
        <span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span> <span class="o">=</span> <span class="n">fid_sets</span><span class="p">[</span><span class="s1">&#39;fid_ids&#39;</span><span class="p">][</span><span class="n">best_idx</span><span class="p">]</span>

        <span class="c1"># Finally set the fids table to the desired fid set</span>
        <span class="n">fids</span><span class="o">.</span><span class="n">set_fid_set</span><span class="p">(</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best acq-fid set: P2=</span><span class="si">{</span><span class="n">best_P2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &quot;</span>
                 <span class="sa">f</span><span class="s2">&quot;acq_idxs=</span><span class="si">{</span><span class="n">best_acq_idxs</span><span class="si">}</span><span class="s2"> halfws=</span><span class="si">{</span><span class="n">best_acq_halfws</span><span class="si">}</span><span class="s2"> fid_ids=</span><span class="si">{</span><span class="n">acqs</span><span class="o">.</span><span class="n">fid_set</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_P2</span> <span class="o">&lt;</span> <span class="n">stage_min_P2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No acq-fid combination was found that met stage requirements&#39;</span><span class="p">,</span>
                     <span class="n">warning</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">merge_cats</span><span class="p">(</span><span class="n">fids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">guides</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">acqs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">fids</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">fids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fids</span>
    <span class="n">guides</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">guides</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">guides</span>
    <span class="n">acqs</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">acqs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">acqs</span>

    <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;sz&#39;</span><span class="p">,</span> <span class="s1">&#39;p_acq&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;maxmag&#39;</span><span class="p">,</span>
                <span class="s1">&#39;yang&#39;</span><span class="p">,</span> <span class="s1">&#39;zang&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="s1">&#39;halfw&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;FID&#39;</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.0</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;maxmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.0</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;p_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fids</span><span class="p">[</span><span class="s1">&#39;sz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;8x8&#39;</span>

    <span class="n">guide_size</span> <span class="o">=</span> <span class="s1">&#39;8x8&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;6x6&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">guides</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Filled in later</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GUI&#39;</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;maxmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_maxmag</span><span class="p">)</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;p_acq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;halfw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="n">guides</span><span class="p">[</span><span class="s1">&#39;sz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guide_size</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acqs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ACQ&#39;</span>
        <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;maxmag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ACA</span><span class="o">.</span><span class="n">max_maxmag</span><span class="p">)</span>
        <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;sz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">guide_size</span>
        <span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Accumulate a list of table Row objects to be assembled into the final table.</span>
    <span class="c1"># This has the desired side effect of back-populating &#39;slot&#39; and &#39;type&#39; columns</span>
    <span class="c1"># in the original acqs, guides, fids tables.</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Generate a list of AGASC IDs for the BOT, GUI, and ACQ stars</span>
    <span class="c1"># in the merged catalog.  Use filt() function below to maintain</span>
    <span class="c1"># the original order (instead of undefined order of set).</span>
    <span class="k">def</span> <span class="nf">filt</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">id_set</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tbl</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">id_set</span><span class="p">]</span>

    <span class="c1"># Sort the BOTs in agasc id order to match what will happen within the MATLAB code</span>
    <span class="n">bot_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filt</span><span class="p">(</span><span class="n">guides</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])))</span>

    <span class="c1"># Do not sort the GUI and ACQ stars (leave in selected order)</span>
    <span class="n">gui_ids</span> <span class="o">=</span> <span class="n">filt</span><span class="p">(</span><span class="n">guides</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
    <span class="n">acq_ids</span> <span class="o">=</span> <span class="n">filt</span><span class="p">(</span><span class="n">acqs</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">acqs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">guides</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>

    <span class="n">n_fid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span>
    <span class="n">n_bot</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bot_ids</span><span class="p">)</span>

    <span class="c1"># FIDs.  Slot starts at 0.</span>
    <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">fids</span><span class="p">):</span>
        <span class="n">fid</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fid</span><span class="p">[</span><span class="n">colnames</span><span class="p">])</span>

    <span class="c1"># BOT stars.  Slot starts after fid slots.</span>
    <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">bot_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">n_fid</span><span class="p">),</span> <span class="n">bot_ids</span><span class="p">):</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">bot_id</span><span class="p">)</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="n">guides</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">bot_id</span><span class="p">)</span>
        <span class="n">guide</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span>
        <span class="n">guide</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BOT&#39;</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="n">colnames</span><span class="p">])</span>

    <span class="c1"># GUI-only stars. Slot stars after fid and BOT slots.</span>
    <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">gui_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">n_fid</span> <span class="o">+</span> <span class="n">n_bot</span><span class="p">),</span> <span class="n">gui_ids</span><span class="p">):</span>
        <span class="n">guide</span> <span class="o">=</span> <span class="n">guides</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">gui_id</span><span class="p">)</span>
        <span class="n">guide</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">guide</span><span class="p">[</span><span class="n">colnames</span><span class="p">])</span>

    <span class="c1"># ACQ-only stars. Slot stars after fid and BOT slots.</span>
    <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">acq_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">n_fid</span> <span class="o">+</span> <span class="n">n_bot</span><span class="p">),</span> <span class="n">acq_ids</span><span class="p">):</span>
        <span class="n">acq</span> <span class="o">=</span> <span class="n">acqs</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="n">acq_id</span><span class="p">)</span>
        <span class="n">acq</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slot</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acq</span><span class="p">[</span><span class="n">colnames</span><span class="p">])</span>

    <span class="c1"># Create final table and assign idx</span>
    <span class="n">aca</span> <span class="o">=</span> <span class="n">ACACatalogTable</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aca</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;idx&#39;</span><span class="p">)</span>
    <span class="n">aca</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">aca</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2018, Tom Aldcroft, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 3.1.2. &nbsp;
  </p>
</footer>
  </body>
</html>